{% extends "base.html" %}

{% block styles %}
<style>
    .task-header {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.25rem;
        margin-bottom: 1.5rem;
    }
    .task-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .task-meta {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .task-description {
        white-space: pre-wrap;
        margin-bottom: 1.5rem;
    }
    .task-section {
        margin-bottom: 2rem;
    }
    .task-section-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    .comment-item {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    .comment-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .attachment-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
    }
    .attachment-icon {
        margin-right: 0.5rem;
        color: #6c757d;
    }
    .risk-item {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 1rem;
    }
    .risk-level {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        font-weight: bold;
    }
    .risk-high {
        background-color: #ffebee;
        color: #c62828;
    }
    .risk-medium {
        background-color: #fff3e0;
        color: #ef6c00;
    }
    .risk-low {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    
    /* 编辑模式样式 */
    .edit-mode-only {
        display: none;
    }
    
    .edit-mode-only .card {
        margin-bottom: 1.5rem;
    }
    
    .edit-mode-only textarea {
        width: 100%;
        min-height: 120px;
    }
    
    /* 确保编辑模式下的表单控件样式一致 */
    .edit-mode-only .form-control,
    .edit-mode-only .form-select,
    .edit-mode-only .form-range {
        margin-bottom: 0.75rem;
    }
    
    /* 修复Bootstrap样式冲突 */
    .btn-group .btn {
        margin-right: 0.25rem;
    }
    
    /* 确保编辑模式表单在小屏幕上也显示良好 */
    @media (max-width: 767.98px) {
        .edit-mode-only .row > div {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block header %}任务详情{% endblock %}

{% block header_buttons %}
<div class="btn-group mr-2">
    <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="redirectToEditPage()">
        <i class="bi bi-pencil"></i> 编辑任务
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showAddSubtaskModal()">
        <i class="bi bi-list-check"></i> 添加子任务
    </button>
    <button type="button" class="btn btn-sm btn-outline-warning" onclick="showAddRiskModal()">
        <i class="bi bi-exclamation-triangle"></i> 添加风险
    </button>
    <button type="button" class="btn btn-sm btn-outline-info" onclick="showUploadModal()">
        <i class="bi bi-paperclip"></i> 上传附件
    </button>
</div>
{% endblock %}

{% block content %}
<!-- 任务ID隐藏字段 -->
{% if task_id %}
<input type="hidden" id="taskId" value="{{ task_id }}">
{% endif %}

<!-- 加载指示器 -->
<div id="loadingIndicator" class="text-center my-5">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">加载中...</span>
    </div>
    <p class="mt-2">正在加载任务详情...</p>
</div>

<!-- 任务内容区域 - 初始隐藏，加载完成后显示 -->
<div id="taskContent" style="display: none;">
    <!-- 任务头部 -->
    <div class="task-header">
        <!-- 查看模式 -->
        <div class="view-mode-only">
            <h2 id="taskTitle" class="task-title">正在加载...</h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>项目：</strong> <a id="taskProject" href="#">正在加载...</a>
                    </div>
                    <div class="mb-2">
                        <strong>状态：</strong> <span id="taskStatus" class="badge bg-primary">正在加载...</span>
                    </div>
                    <div class="mb-2">
                        <strong>优先级：</strong> <span id="taskPriority" class="badge bg-info">正在加载...</span>
                    </div>
                    <div class="mb-2">
                        <strong>负责人：</strong> <span id="taskAssignee">正在加载...</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>创建时间：</strong> <span id="taskCreatedAt">正在加载...</span>
                    </div>
                    <div class="mb-2">
                        <strong>更新时间：</strong> <span id="taskUpdatedAt">正在加载...</span>
                    </div>
                    <div class="mb-2">
                        <strong>开始日期：</strong> <span id="taskStartDate">正在加载...</span>
                    </div>
                    <div class="mb-2">
                        <strong>结束日期：</strong> <span id="taskEndDate">正在加载...</span>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <strong>进度：</strong>
                <div class="progress" style="height: 20px;">
                    <div id="taskProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span id="taskProgressText">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 编辑模式 -->
        <div class="edit-mode-only" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <form id="editTaskForm">
                        <div class="mb-3">
                            <label for="editTaskTitle" class="form-label">任务标题</label>
                            <input type="text" class="form-control" id="editTaskTitle" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTaskStatus" class="form-label">状态</label>
                                    <select class="form-select" id="editTaskStatus">
                                        <option value="todo">待处理</option>
                                        <option value="in_progress">进行中</option>
                                        <option value="review">审核中</option>
                                        <option value="done">已完成</option>
                                        <option value="on_hold">已暂停</option>
                                        <option value="cancelled">已取消</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTaskPriority" class="form-label">优先级</label>
                                    <select class="form-select" id="editTaskPriority">
                                        <option value="low">低</option>
                                        <option value="medium">中</option>
                                        <option value="high">高</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTaskStartDate" class="form-label">开始日期</label>
                                    <input type="date" class="form-control" id="editTaskStartDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTaskEndDate" class="form-label">结束日期</label>
                                    <input type="date" class="form-control" id="editTaskEndDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskProgress" class="form-label">进度 (<span id="editProgressValue">0</span>%)</label>
                            <input type="range" class="form-range" id="editTaskProgress" min="0" max="100" step="5" value="0" oninput="document.getElementById('editProgressValue').textContent = this.value">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskAssignee" class="form-label">负责人</label>
                            <select class="form-select" id="editTaskAssignee">
                                <option value="">请选择负责人</option>
                                <!-- 用户选项将由JavaScript动态添加 -->
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务描述 -->
    <div class="task-section">
        <h3 class="task-section-title">任务描述</h3>
        <!-- 查看模式 -->
        <div id="taskDescription" class="task-description view-mode-only">正在加载...</div>
        
        <!-- 编辑模式 -->
        <div class="edit-mode-only" style="display: none;">
            <textarea class="form-control" id="editTaskDescription" rows="5"></textarea>
        </div>
    </div>

    <!-- 子任务 -->
    <div class="task-section">
        <h3 class="task-section-title">子任务</h3>
        <div id="subtasksList" class="mb-3">
            <p class="text-center">加载中...</p>
        </div>
    </div>

    <!-- 风险 -->
    <div class="task-section">
        <h3 class="task-section-title">风险</h3>
        <div id="risksList" class="mb-3">
            <p class="text-center">加载中...</p>
        </div>
    </div>

    <!-- 附件 -->
    <div class="task-section">
        <h3 class="task-section-title">附件</h3>
        <div id="attachmentsList" class="mb-3">
            <p class="text-center">加载中...</p>
        </div>
    </div>

    <!-- 评论 -->
    <div class="task-section">
        <h3 class="task-section-title">评论</h3>
        <div class="mb-3">
            <textarea id="commentContent" class="form-control mb-2" rows="3" placeholder="添加评论..."></textarea>
            <button id="submitCommentBtn" class="btn btn-primary">提交评论</button>
        </div>
        <div id="commentsList">
            <p class="text-center">加载中...</p>
        </div>
    </div>

    <!-- 任务日志 -->
    <div class="task-section">
        <h3 class="task-section-title">任务日志</h3>
        <div id="taskLogsList">
            <p class="text-center">加载中...</p>
        </div>
    </div>
</div>

<!-- 添加子任务的模态框 -->
<div class="modal fade" id="addSubtaskModal" tabindex="-1" aria-labelledby="addSubtaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSubtaskModalLabel">添加子任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSubtaskForm">
                    <div class="mb-3">
                        <label for="subtaskName" class="form-label">子任务名称</label>
                        <input type="text" class="form-control" id="subtaskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="subtaskDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="subtaskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="subtaskPriority" class="form-label">优先级</label>
                        <select class="form-select" id="subtaskPriority">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subtaskAssignee" class="form-label">负责人</label>
                        <select class="form-select" id="subtaskAssignee">
                            <option value="">请选择负责人</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subtaskDueDate" class="form-label">截止日期</label>
                        <input type="date" class="form-control" id="subtaskDueDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddSubtaskBtn">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加风险的模态框 -->
<div class="modal fade" id="addRiskModal" tabindex="-1" aria-labelledby="addRiskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRiskModalLabel">添加风险</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRiskForm">
                    <div class="mb-3">
                        <label for="riskTitle" class="form-label">风险标题 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="riskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="riskDescription" class="form-label">风险描述</label>
                        <textarea class="form-control" id="riskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="riskProbability" class="form-label">发生概率</label>
                        <select class="form-select" id="riskProbability">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="riskImpact" class="form-label">影响程度</label>
                        <select class="form-select" id="riskImpact">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="riskStatus" class="form-label">风险状态</label>
                        <select class="form-select" id="riskStatus">
                            <option value="open" selected>未处理</option>
                            <option value="mitigating">缓解中</option>
                            <option value="closed">已关闭</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="riskMitigation" class="form-label">缓解计划</label>
                        <textarea class="form-control" id="riskMitigation" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddRiskBtn">提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 上传附件的模态框 -->
<div class="modal fade" id="uploadAttachmentModal" tabindex="-1" aria-labelledby="uploadAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadAttachmentModalLabel">上传附件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="mb-3">
                        <label for="attachmentFile" class="form-label">选择文件 <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="attachmentFile" required>
                    </div>
                    <div class="mb-3">
                        <label for="attachmentDescription" class="form-label">文件描述</label>
                        <textarea class="form-control" id="attachmentDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmUploadBtn">上传</button>
            </div>
        </div>
    </div>
</div>

<!-- 辅助函数 -->
<script>
    // 在JS脚本开始处声明全局变量
    let cachedCsrfToken = null;
    
    // 获取状态文本
    function getStatusText(status) {
        const statusMap = {
            'todo': '待处理',
            'in_progress': '进行中',
            'completed': '已完成',
            'on_hold': '已暂停',
            'cancelled': '已取消',
            'overdue': '已逾期',
            'pending': '等待中',
            'review': '审核中',
            'unknown': '未知状态'
        };
        return statusMap[status] || status;
    }

    // 获取状态样式类
    function getStatusClass(status) {
        const classMap = {
            'todo': 'bg-secondary',
            'in_progress': 'bg-primary',
            'completed': 'bg-success',
            'on_hold': 'bg-warning',
            'cancelled': 'bg-danger',
            'overdue': 'bg-danger',
            'pending': 'bg-info',
            'review': 'bg-info',
            'unknown': 'bg-secondary'
        };
        return classMap[status] || 'bg-secondary';
    }

    // 获取优先级文本
    function getPriorityText(priority) {
        const priorityMap = {
            'low': '低',
            'medium': '中',
            'high': '高',
            'urgent': '紧急',
            'critical': '严重'
        };
        return priorityMap[priority] || priority;
    }

    // 获取优先级样式类
    function getPriorityClass(priority) {
        const classMap = {
            'low': 'bg-info',
            'medium': 'bg-warning',
            'high': 'bg-danger',
            'urgent': 'bg-danger',
            'critical': 'bg-dark'
        };
        return classMap[priority] || 'bg-secondary';
    }

    // 全局错误处理函数，防止未捕获的错误
    window.onerror = function(message, source, lineno, colno, error) {
        console.error(`全局错误: ${message} (${source}:${lineno}:${colno})`, error);
        
        // 如果有显示错误的函数，则调用它
        if (typeof showError === 'function') {
            showError(`页面发生错误: ${message}`);
        } else {
            // 否则创建一个简单的错误提示
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = `页面发生错误: ${message}`;
            document.body.prepend(errorDiv);
        }
        
        return true; // 阻止默认错误处理
    };
    
    // 格式化日期
    function formatDate(dateStr) {
        if (!dateStr) return '';
        
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            
            return date.getFullYear() + '-' + 
                String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(date.getDate()).padStart(2, '0');
        } catch (e) {
            console.error('日期格式化错误:', e);
            return dateStr;
        }
    }
    
    // 格式化日期时间
    function formatDateTime(dateStr) {
        if (!dateStr) return '';
        
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            
            return date.getFullYear() + '-' + 
                String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(date.getDate()).padStart(2, '0') + ' ' + 
                String(date.getHours()).padStart(2, '0') + ':' + 
                String(date.getMinutes()).padStart(2, '0');
        } catch (e) {
            console.error('日期时间格式化错误:', e);
            return dateStr;
        }
    }
    
    // 显示错误信息
    function showError(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <strong>错误:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        if (container) {
            container.prepend(alertDiv);
        } else {
            document.body.prepend(alertDiv);
        }
    }

    // 显示成功消息的辅助函数
    function showSuccess(message) {
        console.log("显示成功消息:", message);
        
        // 创建成功提示元素
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // 添加到页面
        const container = document.querySelector('.container-fluid');
        if (container) {
            container.insertBefore(alertDiv, container.firstChild);
        } else {
            document.body.insertBefore(alertDiv, document.body.firstChild);
        }
        
        // 3秒后自动关闭
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }

    // 获取任务ID的函数
    function getTaskId() {
        try {
            // 首先从URL参数中获取
            const urlParams = new URLSearchParams(window.location.search);
            const urlTaskId = urlParams.get('task_id') || urlParams.get('id');
            if (urlTaskId) {
                return urlTaskId;
            }
            
            // 然后尝试从隐藏字段获取
            const taskIdField = document.getElementById('taskId');
            if (taskIdField && taskIdField.value) {
                return taskIdField.value;
            }
            
            // 最后尝试从全局变量获取
            if (window.task_id) {
                return window.task_id;
            }
            
            // 从Jinja2模板变量获取
            const serverTaskId = '{{ task_id|default("") }}';
            if (serverTaskId && serverTaskId !== '{{ task_id|default("") }}') {
                return serverTaskId;
            }
            
            return null;
        } catch (error) {
            console.error("获取任务ID时出错:", error);
            return null;
        }
    }

    // 加载任务详情
    function loadTaskDetail() {
        try {
            console.log("开始加载任务详情");
            const taskId = getTaskId();
            if (!taskId) {
                console.error("任务ID无效，无法加载任务详情");
                showError("无法获取任务ID，请确保URL正确");
                return Promise.reject(new Error("无法获取任务ID"));
            }
            
            // 显示加载指示器
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // 隐藏内容区域
            const taskContent = document.getElementById('taskContent');
            if (taskContent) {
                taskContent.style.display = 'none';
            }
            
            // 定义多个可能的API端点，按顺序尝试
            const apiUrls = [
                `/tasks/${taskId}?bypass_jwt=true`,
                `/api/tasks/${taskId}?bypass_jwt=true`,
                `/api/auth/tasks/${taskId}?bypass_jwt=true`,
                `/main/tasks/${taskId}?bypass_jwt=true`
            ];
            
            console.log("将尝试以下API端点:", apiUrls);
            
            // 创建一个函数来尝试获取任务详情
            function fetchWithTimeout(url, options, timeout = 10000) {
                // 创建手动超时机制，替代AbortSignal.timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                options = options || {};
                options.signal = controller.signal;
                
                return fetch(url, options)
                    .then(response => {
                        clearTimeout(timeoutId);
                        return response;
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        throw error;
                    });
            }
            
            // 尝试每个API端点
            let currentUrlIndex = 0;
            
            function tryNextUrl() {
                if (currentUrlIndex >= apiUrls.length) {
                    throw new Error('所有API端点尝试均失败');
                }
                
                const currentUrl = apiUrls[currentUrlIndex];
                console.log(`尝试API端点[${currentUrlIndex + 1}/${apiUrls.length}]: ${currentUrl}`);
                
                return fetchWithTimeout(currentUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                }, 5000)
                .then(response => {
                    console.log(`端点 ${currentUrl} 响应状态: ${response.status}`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            // 尝试下一个URL
                            currentUrlIndex++;
                            return tryNextUrl();
                        } else if (response.status === 401) {
                            throw new Error("您没有权限查看此任务");
                        } else {
                            throw new Error(`获取任务详情失败: ${response.statusText || response.status}`);
                        }
                    }
                    
                    return response.text().then(text => {
                        if (!text) {
                            throw new Error("服务器返回空数据");
                        }
                        
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error("解析任务数据失败:", e);
                            console.warn("尝试作为HTML处理响应...");
                            
                            // 检查是否是HTML响应
                            if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
                                currentUrlIndex++;
                                return tryNextUrl();
                            }
                            
                            throw new Error("无法解析任务数据，响应格式不正确");
                        }
                    });
                })
                .catch(error => {
                    console.error(`尝试访问 ${currentUrl} 失败:`, error);
                    // 尝试下一个URL，除非是明确的错误
                    if (error.message.includes('权限') || error.message.includes('无法解析')) {
                        throw error;
                    }
                    
                    currentUrlIndex++;
                    return tryNextUrl();
                });
            }
            
            // 返回获取任务详情的Promise
            return tryNextUrl()
            .then(data => {
                console.log("获取到任务详情数据:", data);
                
                // 填充任务详情到页面
                fillTaskDetail(data);
                
                // 加载相关数据
                setTimeout(() => {
                    try {
                        console.log("加载任务相关数据");
                        loadSubtasks();
                        loadRisks();
                        loadAttachments();
                        loadComments();
                    } catch (e) {
                        console.error("加载相关数据时出错:", e);
                    }
                }, 100);
                
                // 隐藏加载指示器，显示内容
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (taskContent) {
                    taskContent.style.display = 'block';
                }
                
                // 检查URL参数是否需要进入编辑模式
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('edit') === 'true') {
                    console.log("URL包含edit=true参数，自动切换到编辑模式");
                    setTimeout(() => {
                        toggleEditMode(true);
                    }, 300);
                }
                
                return data;
            })
            .catch(error => {
                console.error("加载任务详情失败:", error);
                
                // 隐藏加载指示器
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // 显示错误消息
                showError(`加载任务详情失败: ${error.message}`);
                
                throw error;
            });
        } catch (e) {
            console.error("执行loadTaskDetail函数出错:", e);
            showError(`加载任务详情时出错: ${e.message}`);
            return Promise.reject(e);
        }
    }

    // 填充任务详情到页面
    function fillTaskDetail(data) {
        try {
            console.log("正在填充任务详情:", data);
            
            // 检查数据格式，如果嵌套在task属性中，提取出来
            let taskData = data;
            if (data.task) {
                taskData = data.task;
            }
            
            // 设置任务标题
            const taskTitle = document.getElementById('taskTitle');
            if (taskTitle) {
                taskTitle.textContent = taskData.title || '未命名任务';
                // 设置文档标题
                document.title = `任务: ${taskData.title || '未命名任务'}`;
            }
            
            // 设置任务项目
            const taskProject = document.getElementById('taskProject');
            if (taskProject) {
                let projectName = '未指定项目';
                let projectId = '';
                
                // 检查项目信息的各种可能形式
                if (taskData.project) {
                    if (typeof taskData.project === 'object') {
                        projectName = taskData.project.name || taskData.project.title || '项目 #' + taskData.project.id;
                        projectId = taskData.project.id;
                    } else {
                        projectName = '项目 #' + taskData.project;
                        projectId = taskData.project;
                    }
                } else if (taskData.project_id) {
                    projectName = '项目 #' + taskData.project_id;
                    projectId = taskData.project_id;
                } else if (taskData.project_name) {
                    projectName = taskData.project_name;
                    projectId = taskData.project_id || '';
                }
                
                taskProject.textContent = projectName;
                if (projectId) {
                    taskProject.href = `/projects/${projectId}?bypass_jwt=true`;
                } else {
                    taskProject.removeAttribute('href');
                }
            }
            
            // 设置任务状态
            const taskStatus = document.getElementById('taskStatus');
            if (taskStatus) {
                taskStatus.textContent = getStatusText(taskData.status || 'unknown');
                taskStatus.className = 'badge ' + getStatusClass(taskData.status || 'unknown');
            }
            
            // 设置任务优先级
            const taskPriority = document.getElementById('taskPriority');
            if (taskPriority) {
                taskPriority.textContent = getPriorityText(taskData.priority || 'medium');
                taskPriority.className = 'badge ' + getPriorityClass(taskData.priority || 'medium');
            }
            
            // 设置任务负责人
            const taskAssignee = document.getElementById('taskAssignee');
            if (taskAssignee) {
                let assigneeName = '未分配';
                
                // 检查负责人信息的各种可能形式
                if (taskData.assignee) {
                    if (typeof taskData.assignee === 'object') {
                        assigneeName = taskData.assignee.name || 
                                       taskData.assignee.username || 
                                       taskData.assignee.full_name || 
                                       '用户 #' + taskData.assignee.id;
                    } else {
                        assigneeName = '用户 #' + taskData.assignee;
                    }
                } else if (taskData.assignee_id) {
                    assigneeName = '用户 #' + taskData.assignee_id;
                } else if (taskData.assignee_name) {
                    assigneeName = taskData.assignee_name;
                }
                
                taskAssignee.textContent = assigneeName;
            }
            
            // 设置日期信息
            const createdAt = document.getElementById('taskCreatedAt');
            if (createdAt && taskData.created_at) {
                createdAt.textContent = formatDateTime(taskData.created_at);
            }
            
            const updatedAt = document.getElementById('taskUpdatedAt');
            if (updatedAt && taskData.updated_at) {
                updatedAt.textContent = formatDateTime(taskData.updated_at);
            }
            
            const startDate = document.getElementById('taskStartDate');
            if (startDate) {
                if (taskData.start_date) {
                    startDate.textContent = formatDate(taskData.start_date);
                } else {
                    startDate.textContent = '未设置';
                }
            }
            
            const endDate = document.getElementById('taskEndDate');
            if (endDate) {
                if (taskData.due_date) {
                    endDate.textContent = formatDate(taskData.due_date);
                } else {
                    endDate.textContent = '未设置';
                }
            }
            
            // 设置进度条
            const taskProgress = document.getElementById('taskProgress');
            const taskProgressText = document.getElementById('taskProgressText');
            if (taskProgress) {
                const progress = taskData.progress || 0;
                taskProgress.style.width = progress + '%';
                taskProgress.setAttribute('aria-valuenow', progress);
                
                if (taskProgressText) {
                    taskProgressText.textContent = progress + '%';
                }
            }
            
            // 设置任务描述
            const taskDescription = document.getElementById('taskDescription');
            if (taskDescription) {
                if (taskData.description) {
                    taskDescription.innerHTML = taskData.description;
                } else {
                    taskDescription.innerHTML = '<em>暂无描述</em>';
                }
            }
            
            // 更新任务编辑按钮链接
            const editTaskBtn = document.getElementById('editTaskBtn');
            if (editTaskBtn && taskData.id) {
                editTaskBtn.href = `/tasks/${taskData.id}/edit?bypass_jwt=true`;
            }
            
            // 存储关键信息到全局变量或数据属性
            window.taskData = taskData;
            
            // 预加载用户列表，供子任务使用
            loadUsersList();
            
            console.log("任务详情填充完成");
        } catch (e) {
            console.error("填充任务详情时出错:", e);
            showError(`填充任务详情时出错: ${e.message}`);
        }
    }
    
    // 加载用户列表函数
    function loadUsersList() {
        console.log("开始加载用户列表...");
        
        // 查找子任务负责人下拉菜单
        const subtaskAssigneeSelect = document.getElementById('subtaskAssignee');
        if (!subtaskAssigneeSelect) {
            console.error("找不到子任务负责人下拉菜单元素");
            return;
        }
        
        // 设置加载状态
        subtaskAssigneeSelect.innerHTML = '<option value="">加载中...</option>';
        
        // 定义可能的API端点
        const apiUrls = [
            '/api/users?bypass_jwt=true',
            '/api/auth/users?bypass_jwt=true',
            '/users?bypass_jwt=true'
        ];
        
        console.log('将尝试以下用户列表URL:', apiUrls);
        
        // 尝试第一个URL
        tryLoadUsers(apiUrls, 0);
        
        function tryLoadUsers(urls, index) {
            if (index >= urls.length) {
                console.error('所有用户API端点均失败，使用默认用户');
                subtaskAssigneeSelect.innerHTML = '<option value="">加载用户列表失败</option>';
                addDefaultUsers();
                return;
            }
            
            const url = urls[index];
            console.log(`尝试获取用户URL(${index+1}/${urls.length}): ${url}`);
            
            // 使用API获取用户列表
            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`用户API ${url} 响应状态:`, response.status);
                
                if (!response.ok) {
                    // 如果是方法不允许(405)或未找到(404)，尝试下一个URL
                    if (response.status === 405 || response.status === 404) {
                        console.log(`用户API ${url} 返回${response.status}，尝试下一个URL`);
                        return tryLoadUsers(urls, index + 1);
                    }
                    
                    throw new Error('获取用户列表失败: ' + response.statusText);
                }
                
                // 尝试解析为JSON
                return response.text().then(text => {
                    if (!text || text.trim() === '') {
                        console.log("用户API返回空内容");
                        return { users: [] };
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("用户API返回无效JSON:", e);
                        console.log("响应内容:", text);
                        return { users: [] };
                    }
                });
            })
            .then(data => {
                console.log("获取到用户列表数据:", data);
                
                // 清空下拉菜单
                subtaskAssigneeSelect.innerHTML = '<option value="">请选择负责人</option>';
                
                // 处理不同的响应格式 (直接数组或嵌套在users属性中)
                const users = Array.isArray(data) ? data : (data.users || []);
                
                // 如果没有数据，尝试从任务详情中获取当前用户信息
                if (users.length === 0 && window.taskData && window.taskData.assignee) {
                    const currentUser = window.taskData.assignee;
                    if (typeof currentUser === 'object') {
                        users.push(currentUser);
                    }
                }
                
                // 添加用户选项
                if (users.length > 0) {
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        
                        // 显示用户名或ID
                        if (user.name) {
                            option.textContent = user.name;
                        } else if (user.username) {
                            option.textContent = user.username;
                        } else {
                            option.textContent = `用户 #${user.id}`;
                        }
                        
                        subtaskAssigneeSelect.appendChild(option);
                    });
                    console.log(`成功加载 ${users.length} 个用户`);
                } else {
                    console.warn("API返回的用户列表为空");
                    // 添加一些默认用户，以便能够继续操作
                    addDefaultUsers();
                }
            })
            .catch(error => {
                console.error("加载用户列表失败:", error);
                
                // 如果不是最后一个URL，尝试下一个
                if (index < urls.length - 1) {
                    console.log(`用户加载失败，尝试下一个URL: ${error.message}`);
                    tryLoadUsers(urls, index + 1);
                } else {
                    subtaskAssigneeSelect.innerHTML = '<option value="">加载用户列表失败</option>';
                    // 添加默认用户
                    addDefaultUsers();
                }
            });
        }
        
        // 辅助函数：添加默认用户
        function addDefaultUsers() {
            const defaultUsers = [
                {id: 1, name: '管理员'},
                {id: 2, name: '项目经理'},
                {id: 3, name: '开发人员'}
            ];
            
            console.log('添加默认用户选项');
            defaultUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                subtaskAssigneeSelect.appendChild(option);
            });
            
            // 如果有当前任务负责人数据，也添加到列表中
            if (window.taskData && window.taskData.assignee) {
                let assigneeId, assigneeName;
                
                if (typeof window.taskData.assignee === 'object') {
                    assigneeId = window.taskData.assignee.id;
                    assigneeName = window.taskData.assignee.name || 
                                   window.taskData.assignee.username || 
                                  '当前负责人';
                } else if (window.taskData.assignee_id) {
                    assigneeId = window.taskData.assignee_id;
                    assigneeName = window.taskData.assignee_name || '当前负责人';
                }
                
                if (assigneeId) {
                    // 检查是否已存在
                    let exists = false;
                    for (let i = 0; i < subtaskAssigneeSelect.options.length; i++) {
                        if (subtaskAssigneeSelect.options[i].value == assigneeId) {
                            exists = true;
                            break;
                        }
                    }
                    
                    if (!exists) {
                        const option = document.createElement('option');
                        option.value = assigneeId;
                        option.textContent = assigneeName;
                        subtaskAssigneeSelect.appendChild(option);
                    }
                }
            }
        }
    }

    // 加载子任务函数
    function loadSubtasks() {
        try {
            console.log("开始加载子任务");
            const taskId = getTaskId();
            if (!taskId) {
                console.error("无法获取任务ID，无法加载子任务");
                return;
            }
            
            // 子任务容器
            const subtasksContainer = document.getElementById('subtasksList');
            if (!subtasksContainer) {
                console.error("找不到子任务容器元素");
                return;
            }
            
            // 显示加载指示器
            subtasksContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>';
            
            // API URL
            const apiUrl = `/tasks/${taskId}/subtasks?bypass_jwt=true`;
            
            console.log(`加载子任务，使用URL: ${apiUrl}`);
            
            // 发送请求
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`子任务API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        subtasksContainer.innerHTML = '<div class="alert alert-info">无子任务数据</div>';
                        return Promise.resolve({ subtasks: [] });
                    } else {
                        throw new Error(`获取子任务失败: ${response.statusText || response.status}`);
                    }
                }
                
                return response.text().then(text => {
                    if (!text) {
                        subtasksContainer.innerHTML = '<div class="alert alert-info">无子任务数据</div>';
                        return { subtasks: [] };
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("解析子任务数据失败:", e);
                        if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
                            subtasksContainer.innerHTML = '<div class="alert alert-warning">获取子任务数据格式不正确</div>';
                            return { subtasks: [] };
                        }
                        throw new Error("无法解析子任务数据");
                    }
                });
            })
            .then(data => {
                console.log("获取到子任务数据:", data);
                
                // 处理不同的响应格式
                const subtasks = Array.isArray(data) ? data : (data.subtasks || []);
                
                if (subtasks.length === 0) {
                    subtasksContainer.innerHTML = '<div class="alert alert-info">暂无子任务</div>';
                    return;
                }
                
                // 创建子任务列表
                let html = '<div class="list-group">';
                
                subtasks.forEach(subtask => {
                    const statusClass = getStatusClass(subtask.status || 'unknown');
                    const priorityClass = getPriorityClass(subtask.priority || 'medium');
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${subtask.title || '未命名子任务'}</h5>
                                <small>
                                    <span class="badge ${statusClass}">${getStatusText(subtask.status || 'unknown')}</span>
                                    <span class="badge ${priorityClass} ms-1">${getPriorityText(subtask.priority || 'medium')}</span>
                                </small>
                            </div>
                            <p class="mb-1">${subtask.description || '无描述'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small>负责人: ${subtask.assignee ? (typeof subtask.assignee === 'object' ? subtask.assignee.name || '用户 #' + subtask.assignee.id : '用户 #' + subtask.assignee_id) : '未分配'}</small>
                                <small>截止日期: ${subtask.due_date ? formatDate(subtask.due_date) : '未设置'}</small>
                            </div>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: ${subtask.progress || 0}%;" aria-valuenow="${subtask.progress || 0}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                subtasksContainer.innerHTML = html;
            })
            .catch(error => {
                console.error("加载子任务失败:", error);
                subtasksContainer.innerHTML = `<div class="alert alert-danger">加载子任务失败: ${error.message}</div>`;
            });
        } catch (e) {
            console.error("执行loadSubtasks函数出错:", e);
            const subtasksContainer = document.getElementById('subtasksList');
            if (subtasksContainer) {
                subtasksContainer.innerHTML = `<div class="alert alert-danger">加载子任务时出错: ${e.message}</div>`;
            }
        }
    }
    
    // 加载风险函数
    function loadRisks() {
        try {
            console.log("开始加载风险");
            const taskId = getTaskId();
            if (!taskId) {
                console.error("无法获取任务ID，无法加载风险");
                return;
            }
            
            // 风险容器
            const risksContainer = document.getElementById('risksList');
            if (!risksContainer) {
                console.error("找不到风险容器元素");
                return;
            }
            
            // 显示加载指示器
            risksContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>';
            
            // API URL
            const apiUrl = `/tasks/${taskId}/risks?bypass_jwt=true`;
            
            console.log(`加载风险，使用URL: ${apiUrl}`);
            
            // 发送请求
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`风险API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        risksContainer.innerHTML = '<div class="alert alert-info">无风险数据</div>';
                        return Promise.resolve({ risks: [] });
                    } else {
                        throw new Error(`获取风险失败: ${response.statusText || response.status}`);
                    }
                }
                
                return response.text().then(text => {
                    if (!text) {
                        risksContainer.innerHTML = '<div class="alert alert-info">无风险数据</div>';
                        return { risks: [] };
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("解析风险数据失败:", e);
                        if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
                            risksContainer.innerHTML = '<div class="alert alert-warning">获取风险数据格式不正确</div>';
                            return { risks: [] };
                        }
                        throw new Error("无法解析风险数据");
                    }
                });
            })
            .then(data => {
                console.log("获取到风险数据:", data);
                
                // 处理不同的响应格式
                const risks = Array.isArray(data) ? data : (data.risks || []);
                
                if (risks.length === 0) {
                    risksContainer.innerHTML = '<div class="alert alert-info">暂无风险</div>';
                    return;
                }
                
                // 创建风险列表
                let html = '<div class="table-responsive"><table class="table table-striped">';
                html += `
                    <thead>
                        <tr>
                            <th>风险标题</th>
                            <th>概率</th>
                            <th>影响度</th>
                            <th>状态</th>
                            <th>缓解计划</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                risks.forEach(risk => {
                    let statusClass;
                    switch (risk.status) {
                        case 'open':
                            statusClass = 'danger';
                            break;
                        case 'mitigating':
                            statusClass = 'warning';
                            break;
                        case 'closed':
                            statusClass = 'success';
                            break;
                        default:
                            statusClass = 'info';
                    }
                    
                    let probabilityClass;
                    switch (risk.probability) {
                        case 'high':
                            probabilityClass = 'danger';
                            break;
                        case 'medium':
                            probabilityClass = 'warning';
                            break;
                        case 'low':
                            probabilityClass = 'success';
                            break;
                        default:
                            probabilityClass = 'info';
                    }
                    
                    let impactClass;
                    switch (risk.impact) {
                        case 'high':
                            impactClass = 'danger';
                            break;
                        case 'medium':
                            impactClass = 'warning';
                            break;
                        case 'low':
                            impactClass = 'success';
                            break;
                        default:
                            impactClass = 'info';
                    }
                    
                    html += `
                        <tr>
                            <td>${risk.title || '无标题'}</td>
                            <td><span class="badge bg-${probabilityClass}">${getPriorityText(risk.probability) || '未知'}</span></td>
                            <td><span class="badge bg-${impactClass}">${getPriorityText(risk.impact) || '未知'}</span></td>
                            <td><span class="badge bg-${statusClass}">${risk.status === 'open' ? '未处理' : (risk.status === 'mitigating' ? '缓解中' : (risk.status === 'closed' ? '已关闭' : risk.status))}</span></td>
                            <td>${risk.mitigation_plan || '无缓解计划'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                risksContainer.innerHTML = html;
            })
            .catch(error => {
                console.error("加载风险失败:", error);
                risksContainer.innerHTML = `<div class="alert alert-danger">加载风险失败: ${error.message}</div>`;
            });
        } catch (e) {
            console.error("执行loadRisks函数出错:", e);
            const risksContainer = document.getElementById('risksList');
            if (risksContainer) {
                risksContainer.innerHTML = `<div class="alert alert-danger">加载风险时出错: ${e.message}</div>`;
            }
        }
    }
    
    // 加载附件函数
    function loadAttachments() {
        try {
            console.log("开始加载附件");
            const taskId = getTaskId();
            if (!taskId) {
                console.error("无法获取任务ID，无法加载附件");
                return;
            }
            
            // 附件容器
            const attachmentsContainer = document.getElementById('attachmentsList');
            if (!attachmentsContainer) {
                console.error("找不到附件容器元素");
                return;
            }
            
            // 显示加载指示器
            attachmentsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>';
            
            // API URL
            const apiUrl = `/tasks/${taskId}/attachments?bypass_jwt=true`;
            
            console.log(`加载附件，使用URL: ${apiUrl}`);
            
            // 发送请求
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`附件API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        attachmentsContainer.innerHTML = '<div class="alert alert-info">无附件数据</div>';
                        return Promise.resolve({ attachments: [] });
                    } else {
                        throw new Error(`获取附件失败: ${response.statusText || response.status}`);
                    }
                }
                
                return response.text().then(text => {
                    if (!text) {
                        attachmentsContainer.innerHTML = '<div class="alert alert-info">无附件数据</div>';
                        return { attachments: [] };
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("解析附件数据失败:", e);
                        if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
                            attachmentsContainer.innerHTML = '<div class="alert alert-warning">获取附件数据格式不正确</div>';
                            return { attachments: [] };
                        }
                        throw new Error("无法解析附件数据");
                    }
                });
            })
            .then(data => {
                console.log("获取到附件数据:", data);
                
                // 处理不同的响应格式
                const attachments = Array.isArray(data) ? data : (data.attachments || []);
                
                if (attachments.length === 0) {
                    attachmentsContainer.innerHTML = '<div class="alert alert-info">暂无附件</div>';
                    return;
                }
                
                // 创建附件列表
                let html = '<div class="list-group">';
                
                attachments.forEach(attachment => {
                    const fileType = attachment.file_type || '未知文件类型';
                    const fileIcon = getFileIcon(fileType);
                    const fileSize = formatFileSize(attachment.file_size || 0);
                    const uploadDate = attachment.created_at ? formatDateTime(attachment.created_at) : '未知时间';
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">
                                    <i class="${fileIcon}"></i> 
                                    ${attachment.filename || '未命名文件'}
                                </h5>
                                <small>${fileSize}</small>
                            </div>
                            <p class="mb-1">${attachment.description || '无描述'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small>上传时间: ${uploadDate}</small>
                                <div>
                                    <a href="/tasks/${taskId}/attachments/${attachment.id}/download?bypass_jwt=true" 
                                       class="btn btn-sm btn-outline-primary" 
                                       target="_blank">
                                        <i class="fas fa-download"></i> 下载
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                attachmentsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error("加载附件失败:", error);
                attachmentsContainer.innerHTML = `<div class="alert alert-danger">加载附件失败: ${error.message}</div>`;
            });
        } catch (e) {
            console.error("执行loadAttachments函数出错:", e);
            const attachmentsContainer = document.getElementById('attachmentsList');
            if (attachmentsContainer) {
                attachmentsContainer.innerHTML = `<div class="alert alert-danger">加载附件时出错: ${e.message}</div>`;
            }
        }
    }
    
    // 加载评论函数
    function loadComments() {
        try {
            console.log("开始加载评论");
            const taskId = getTaskId();
            if (!taskId) {
                console.error("无法获取任务ID，无法加载评论");
                return;
            }
            
            // 评论容器
            const commentsContainer = document.getElementById('commentsList');
            if (!commentsContainer) {
                console.error("找不到评论容器元素");
                return;
            }
            
            // 显示加载指示器
            commentsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>';
            
            // API URL
            const apiUrl = `/tasks/${taskId}/comments?bypass_jwt=true`;
            
            console.log(`加载评论，使用URL: ${apiUrl}`);
            
            // 发送请求
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`评论API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        commentsContainer.innerHTML = '<div class="alert alert-info">无评论数据</div>';
                        return Promise.resolve({ comments: [] });
                    } else {
                        throw new Error(`获取评论失败: ${response.statusText || response.status}`);
                    }
                }
                
                return response.text().then(text => {
                    if (!text) {
                        commentsContainer.innerHTML = '<div class="alert alert-info">无评论数据</div>';
                        return { comments: [] };
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("解析评论数据失败:", e);
                        if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
                            commentsContainer.innerHTML = '<div class="alert alert-warning">获取评论数据格式不正确</div>';
                            return { comments: [] };
                        }
                        throw new Error("无法解析评论数据");
                    }
                });
            })
            .then(data => {
                console.log("获取到评论数据:", data);
                
                // 处理不同的响应格式
                const comments = Array.isArray(data) ? data : (data.comments || []);
                
                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<div class="alert alert-info">暂无评论</div>';
                    return;
                }
                
                // 创建评论列表
                let html = '';
                
                comments.forEach(comment => {
                    const commentDate = comment.created_at ? formatDateTime(comment.created_at) : '未知时间';
                    const userName = comment.user ? (typeof comment.user === 'object' ? (comment.user.name || comment.user.username || '用户#' + comment.user.id) : '用户#' + comment.user) : '未知用户';
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${userName}</strong>
                                </div>
                                <small class="text-muted">${commentDate}</small>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${comment.content || '无内容'}</p>
                            </div>
                        </div>
                    `;
                });
                
                commentsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error("加载评论失败:", error);
                commentsContainer.innerHTML = `<div class="alert alert-danger">加载评论失败: ${error.message}</div>`;
            });
        } catch (e) {
            console.error("执行loadComments函数出错:", e);
            const commentsContainer = document.getElementById('commentsList');
            if (commentsContainer) {
                commentsContainer.innerHTML = `<div class="alert alert-danger">加载评论时出错: ${e.message}</div>`;
            }
        }
    }
    
    // 获取文件图标
    function getFileIcon(fileType) {
        if (!fileType) return 'fas fa-file';
        
        fileType = fileType.toLowerCase();
        
        if (fileType.includes('image') || fileType.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/i)) {
            return 'far fa-file-image';
        } else if (fileType.includes('pdf') || fileType.match(/\.pdf$/i)) {
            return 'far fa-file-pdf';
        } else if (fileType.includes('word') || fileType.match(/\.(doc|docx)$/i)) {
            return 'far fa-file-word';
        } else if (fileType.includes('excel') || fileType.match(/\.(xls|xlsx|csv)$/i)) {
            return 'far fa-file-excel';
        } else if (fileType.includes('powerpoint') || fileType.match(/\.(ppt|pptx)$/i)) {
            return 'far fa-file-powerpoint';
        } else if (fileType.includes('zip') || fileType.includes('compressed') || fileType.match(/\.(zip|rar|7z|tar|gz)$/i)) {
            return 'far fa-file-archive';
        } else if (fileType.includes('text') || fileType.match(/\.(txt|md|rtf)$/i)) {
            return 'far fa-file-alt';
        } else if (fileType.includes('code') || fileType.match(/\.(html|css|js|py|java|php|c|cpp|h|rb|swift|go)$/i)) {
            return 'far fa-file-code';
        } else if (fileType.includes('audio') || fileType.match(/\.(mp3|wav|ogg|flac|aac)$/i)) {
            return 'far fa-file-audio';
        } else if (fileType.includes('video') || fileType.match(/\.(mp4|avi|mov|wmv|flv|mkv)$/i)) {
            return 'far fa-file-video';
        }
        
        return 'far fa-file';
    }
    
    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 重定向到任务编辑页面
    function redirectToEditPage() {
        try {
            console.log("跳转到任务编辑页面");
            const taskId = getTaskId();
            if (!taskId) {
                showError("无法获取任务ID，无法编辑任务");
                return;
            }
            
            // 直接跳转到任务编辑页面
            window.location.href = `/tasks/${taskId}/edit?bypass_jwt=true`;
        } catch (e) {
            console.error("跳转到任务编辑页面出错:", e);
            showError(`编辑任务时出错: ${e.message}`);
        }
    }
    
    // 切换编辑模式
    function toggleEditMode(isEditMode) {
        try {
            console.log("切换编辑模式:", isEditMode);
            // 获取任务数据，确保已加载
            if (!window.taskData) {
                console.error("任务数据尚未加载，无法进入编辑模式");
                showError("任务数据尚未加载，无法进入编辑模式");
                return;
            }
            
            // 获取要显示/隐藏的元素
            const viewElements = document.querySelectorAll('.view-mode-only');
            const editElements = document.querySelectorAll('.edit-mode-only');
            
            console.log(`找到 ${viewElements.length} 个查看模式元素和 ${editElements.length} 个编辑模式元素`);
            
            // 调试：列出所有编辑模式元素
            if (editElements.length > 0) {
                console.log("编辑模式元素列表:");
                editElements.forEach((el, index) => {
                    console.log(`  ${index+1}. ${el.tagName} - ${el.className} - 包含子元素: ${el.children.length}`);
                });
            }
            
            if (isEditMode) {
                // 进入编辑模式
                viewElements.forEach(el => {
                    el.style.display = 'none';
                    console.log(`隐藏查看模式元素: ${el.tagName} - ${el.className}`);
                });
                
                editElements.forEach(el => {
                    el.style.display = 'block';
                    console.log(`显示编辑模式元素: ${el.tagName} - ${el.className}`);
                });
                
                // 填充编辑表单
                populateEditForm(window.taskData);
                
                // 更改编辑按钮文本
                const editBtn = document.querySelector('.edit-btn');
                if (editBtn) {
                    editBtn.innerHTML = '<i class="bi bi-x-circle"></i> 取消编辑';
                    editBtn.classList.remove('btn-outline-primary');
                    editBtn.classList.add('btn-outline-secondary');
                    
                    // 替换onclick事件
                    editBtn.onclick = function() {
                        toggleEditMode(false);
                    };
                }
                
                // 添加保存按钮（如果不存在）
                if (!document.getElementById('saveTaskBtn')) {
                    const saveBtn = document.createElement('button');
                    saveBtn.id = 'saveTaskBtn';
                    saveBtn.className = 'btn btn-sm btn-primary ms-2';
                    saveBtn.innerHTML = '<i class="bi bi-check2"></i> 保存修改';
                    saveBtn.onclick = saveTaskChanges;
                    
                    // 添加到编辑按钮旁边
                    if (editBtn && editBtn.parentNode) {
                        editBtn.parentNode.appendChild(saveBtn);
                    } else {
                        console.error("无法找到编辑按钮的父元素，无法添加保存按钮");
                        // 尝试添加到页面的其他位置
                        const headerButtons = document.querySelector('.navbar .btn-group') || 
                                              document.querySelector('.header-buttons') || 
                                              document.querySelector('#header_buttons');
                        if (headerButtons) {
                            headerButtons.appendChild(saveBtn);
                        } else {
                            // 最后尝试添加到body
                            document.body.appendChild(saveBtn);
                            saveBtn.style.position = 'fixed';
                            saveBtn.style.top = '10px';
                            saveBtn.style.right = '10px';
                            saveBtn.style.zIndex = '9999';
                        }
                    }
                }
            } else {
                // 退出编辑模式
                viewElements.forEach(el => {
                    el.style.display = 'block';
                    console.log(`显示查看模式元素: ${el.tagName} - ${el.className}`);
                });
                
                editElements.forEach(el => {
                    el.style.display = 'none';
                    console.log(`隐藏编辑模式元素: ${el.tagName} - ${el.className}`);
                });
                
                // 恢复编辑按钮
                const editBtn = document.querySelector('.edit-btn');
                if (editBtn) {
                    editBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑任务';
                    editBtn.classList.remove('btn-outline-secondary');
                    editBtn.classList.add('btn-outline-primary');
                    
                    // 恢复原始onclick事件
                    editBtn.onclick = editTask;
                }
                
                // 移除保存按钮
                const saveBtn = document.getElementById('saveTaskBtn');
                if (saveBtn) {
                    saveBtn.parentNode.removeChild(saveBtn);
                }
                
                // 更新URL，移除edit=true参数
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.delete('edit');
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.pushState({}, '', newUrl);
            }
            
            console.log(`编辑模式切换${isEditMode ? '进入' : '退出'}完成`);
        } catch (e) {
            console.error("切换编辑模式出错:", e);
            showError(`切换编辑模式时出错: ${e.message}`);
        }
    }
    
    // 填充编辑表单
    function populateEditForm(taskData) {
        console.log("填充任务编辑表单:", taskData);
        
        try {
            // 记录编辑表单元素是否存在
            const titleInput = document.getElementById('editTaskTitle');
            const descriptionInput = document.getElementById('editTaskDescription');
            const statusSelect = document.getElementById('editTaskStatus');
            const prioritySelect = document.getElementById('editTaskPriority');
            const startDateInput = document.getElementById('editTaskStartDate');
            const endDateInput = document.getElementById('editTaskEndDate');
            const progressInput = document.getElementById('editTaskProgress');
            const assigneeSelect = document.getElementById('editTaskAssignee');
            
            console.log("编辑表单元素状态:", {
                "标题输入框": titleInput ? "存在" : "不存在",
                "描述输入框": descriptionInput ? "存在" : "不存在",
                "状态下拉框": statusSelect ? "存在" : "不存在",
                "优先级下拉框": prioritySelect ? "存在" : "不存在",
                "开始日期": startDateInput ? "存在" : "不存在",
                "结束日期": endDateInput ? "存在" : "不存在",
                "进度滑块": progressInput ? "存在" : "不存在",
                "负责人下拉框": assigneeSelect ? "存在" : "不存在"
            });
            
            // 填充标题
            if (titleInput) {
                titleInput.value = taskData.title || '';
                console.log("已填充标题:", titleInput.value);
            } else {
                console.error("找不到标题输入框元素 (editTaskTitle)");
            }
            
            // 填充描述
            if (descriptionInput) {
                descriptionInput.value = taskData.description || '';
                console.log("已填充描述:", descriptionInput.value.substring(0, 50) + (descriptionInput.value.length > 50 ? "..." : ""));
            } else {
                console.error("找不到描述输入框元素 (editTaskDescription)");
                
                // 尝试创建描述输入框
                if (!document.getElementById('editTaskDescription')) {
                    const descContainer = document.querySelector('.edit-mode-only .task-description') || 
                                          document.querySelector('.edit-mode-only');
                    
                    if (descContainer) {
                        console.log("尝试创建描述输入框元素");
                        const textarea = document.createElement('textarea');
                        textarea.id = 'editTaskDescription';
                        textarea.className = 'form-control';
                        textarea.rows = 5;
                        textarea.value = taskData.description || '';
                        descContainer.appendChild(textarea);
                        console.log("已创建描述输入框并填充数据");
                    }
                }
            }
            
            // 填充状态
            if (statusSelect) {
                let statusFound = false;
                for (let i = 0; i < statusSelect.options.length; i++) {
                    if (statusSelect.options[i].value === taskData.status) {
                        statusSelect.selectedIndex = i;
                        statusFound = true;
                        console.log("已选择状态:", taskData.status);
                        break;
                    }
                }
                
                if (!statusFound) {
                    console.warn("未找到匹配的状态:", taskData.status);
                }
            } else {
                console.error("找不到状态下拉框元素 (editTaskStatus)");
            }
            
            // 填充优先级
            if (prioritySelect) {
                let priorityFound = false;
                for (let i = 0; i < prioritySelect.options.length; i++) {
                    if (prioritySelect.options[i].value === taskData.priority) {
                        prioritySelect.selectedIndex = i;
                        priorityFound = true;
                        console.log("已选择优先级:", taskData.priority);
                        break;
                    }
                }
                
                if (!priorityFound) {
                    console.warn("未找到匹配的优先级:", taskData.priority);
                }
            } else {
                console.error("找不到优先级下拉框元素 (editTaskPriority)");
            }
            
            // 填充日期
            if (startDateInput && taskData.start_date) {
                try {
                    // 格式化日期为YYYY-MM-DD格式
                    const startDate = taskData.start_date.split('T')[0];
                    startDateInput.value = startDate;
                    console.log("已填充开始日期:", startDate);
                } catch (e) {
                    console.error("设置开始日期出错:", e);
                }
            } else if (!startDateInput) {
                console.error("找不到开始日期输入框元素 (editTaskStartDate)");
            }
            
            if (endDateInput && taskData.due_date) {
                try {
                    // 格式化日期为YYYY-MM-DD格式
                    const endDate = taskData.due_date.split('T')[0];
                    endDateInput.value = endDate;
                    console.log("已填充结束日期:", endDate);
                } catch (e) {
                    console.error("设置结束日期出错:", e);
                }
            } else if (!endDateInput) {
                console.error("找不到结束日期输入框元素 (editTaskEndDate)");
            }
            
            // 填充进度
            if (progressInput) {
                const progress = taskData.progress || 0;
                progressInput.value = progress;
                const progressValueEl = document.getElementById('editProgressValue');
                if (progressValueEl) {
                    progressValueEl.textContent = progress;
                }
                console.log("已填充进度:", progress + "%");
            } else {
                console.error("找不到进度滑块元素 (editTaskProgress)");
            }
            
            // 填充负责人下拉框
            loadUsersForSelect(taskData);
            
            console.log("表单填充完成");
        } catch (e) {
            console.error("填充编辑表单时出错:", e);
            showError("填充编辑表单时出错: " + e.message);
        }
    }
    
    // 加载用户列表到负责人下拉框
    function loadUsersForSelect(taskData) {
        const assigneeSelect = document.getElementById('editTaskAssignee');
        if (!assigneeSelect) return;
        
        // 清空现有选项（保留第一个"请选择"选项）
        while (assigneeSelect.options.length > 1) {
            assigneeSelect.remove(1);
        }
        
        // 获取用户列表
        fetch('/api/global/users?bypass_jwt=true', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`获取用户列表失败: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // 处理嵌套结构
            const users = data.users || data || [];
            
            // 添加用户选项
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name || user.username || `用户 #${user.id}`;
                assigneeSelect.appendChild(option);
                
                // 如果是当前任务的负责人，设为选中
                if (taskData.assignee_id && user.id == taskData.assignee_id) {
                    option.selected = true;
                }
            });
            
            console.log(`已加载 ${users.length} 个用户到负责人下拉框`);
        })
        .catch(error => {
            console.error("加载用户列表失败:", error);
            
            // 如果有当前负责人信息，至少添加当前负责人
            if (taskData.assignee) {
                let assigneeId, assigneeName;
                
                if (typeof taskData.assignee === 'object') {
                    assigneeId = taskData.assignee.id;
                    assigneeName = taskData.assignee.name || taskData.assignee.username || '当前负责人';
                } else if (taskData.assignee_id) {
                    assigneeId = taskData.assignee_id;
                    assigneeName = taskData.assignee_name || '当前负责人';
                }
                
                if (assigneeId) {
                    const option = document.createElement('option');
                    option.value = assigneeId;
                    option.textContent = assigneeName;
                    option.selected = true;
                    assigneeSelect.appendChild(option);
                }
            }
        });
    }
    
    // 检查URL参数并在页面加载后自动切换到编辑模式
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const shouldEdit = urlParams.get('edit') === 'true';
        
        if (shouldEdit) {
            // 任务加载完成后会自动进入编辑模式
            console.log("URL包含edit=true，等待任务加载完成后进入编辑模式");
            // 不需要在这里直接调用toggleEditMode，loadTaskDetail会处理
        }
        
        // 加载任务详情 - 数据加载完成后会自动处理编辑模式
        const taskId = getTaskId();
        if (taskId) {
            loadTaskDetail();
        }
    });
    
    // 保存任务修改
    function saveTaskChanges() {
        try {
            console.log("保存任务修改");
            const taskId = getTaskId();
            if (!taskId) {
                showError("无法获取任务ID，无法保存修改");
                return;
            }
            
            // 禁用保存按钮
            const saveBtn = document.getElementById('saveTaskBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
            }
            
            // 收集表单数据
            const titleInput = document.getElementById('editTaskTitle');
            const descriptionInput = document.getElementById('editTaskDescription');
            const statusSelect = document.getElementById('editTaskStatus');
            const prioritySelect = document.getElementById('editTaskPriority');
            const startDateInput = document.getElementById('editTaskStartDate');
            const endDateInput = document.getElementById('editTaskEndDate');
            const progressInput = document.getElementById('editTaskProgress');
            const assigneeSelect = document.getElementById('editTaskAssignee');
            
            console.log("表单元素状态:", {
                "标题输入框": titleInput ? "存在" : "不存在",
                "描述输入框": descriptionInput ? "存在" : "不存在",
                "状态下拉框": statusSelect ? "存在" : "不存在",
                "优先级下拉框": prioritySelect ? "存在" : "不存在",
                "开始日期": startDateInput ? "存在" : "不存在",
                "结束日期": endDateInput ? "存在" : "不存在",
                "进度滑块": progressInput ? "存在" : "不存在",
                "负责人下拉框": assigneeSelect ? "存在" : "不存在"
            });
            
            // 对于找不到的描述输入框，尝试其他可能的ID或创建一个临时的
            let descriptionValue = '';
            if (descriptionInput) {
                descriptionValue = descriptionInput.value;
            } else {
                // 尝试找其他可能的描述输入框
                const altDescInputs = [
                    document.querySelector('textarea.form-control'),
                    document.querySelector('.edit-mode-only textarea'),
                    document.getElementById('taskDescription')
                ];
                
                for (const input of altDescInputs) {
                    if (input) {
                        console.log(`使用替代描述输入框: ${input.id || '无ID'}`);
                        descriptionValue = input.value;
                        break;
                    }
                }
                
                if (!descriptionValue && window.taskData) {
                    descriptionValue = window.taskData.description || '';
                    console.log("使用原始任务数据中的描述");
                }
            }
            
            // 构建请求数据
            const updatedData = {
                title: titleInput ? titleInput.value : window.taskData.title,
                description: descriptionValue,
                status: statusSelect ? statusSelect.value : window.taskData.status,
                priority: prioritySelect ? prioritySelect.value : window.taskData.priority,
                progress: progressInput ? parseInt(progressInput.value) : window.taskData.progress || 0
            };
            
            // 添加可选字段
            if (startDateInput && startDateInput.value) {
                updatedData.start_date = startDateInput.value;
            }
            
            if (endDateInput && endDateInput.value) {
                updatedData.due_date = endDateInput.value;
            }
            
            if (assigneeSelect && assigneeSelect.value) {
                updatedData.assignee_id = assigneeSelect.value;
            }
            
            console.log("更新任务数据:", updatedData);
            
            // 获取CSRF令牌
            const csrfToken = getCsrfToken();
            
            // 发送更新请求
            fetch(`/api/tasks/${taskId}?bypass_jwt=true`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(updatedData),
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || data.message || `更新失败: ${response.status}`);
                    }).catch(e => {
                        if (e instanceof SyntaxError) {
                            throw new Error(`更新失败: ${response.status} ${response.statusText}`);
                        }
                        throw e;
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("任务更新成功:", data);
                
                // 显示成功消息
                showSuccess("任务更新成功");
                
                // 刷新页面或重新加载任务数据
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(error => {
                console.error("更新任务失败:", error);
                
                // 恢复保存按钮
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-check2"></i> 保存修改';
                }
                
                // 显示错误消息
                showError(`更新任务失败: ${error.message}`);
            });
        } catch (e) {
            console.error("执行saveTaskChanges函数出错:", e);
            showError(`保存任务修改时出错: ${e.message}`);
            
            // 恢复保存按钮
            const saveBtn = document.getElementById('saveTaskBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check2"></i> 保存修改';
            }
        }
    }
    
    // 显示添加子任务模态框
    function showAddSubtaskModal() {
        try {
            console.log("显示添加子任务模态框");
            
            // 获取模态框元素
            const modalElement = document.getElementById('addSubtaskModal');
            if (!modalElement) {
                showError("找不到添加子任务模态框");
                return;
            }
            
            // 重置表单
            const form = document.getElementById('addSubtaskForm');
            if (form) {
                form.reset();
            }
            
            // 初始化模态框
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // 绑定提交事件
            const confirmBtn = document.getElementById('confirmAddSubtaskBtn');
            if (confirmBtn) {
                // 移除之前的事件处理器
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                
                // 添加新的事件处理器
                newBtn.addEventListener('click', createSubtask);
            }
            
            // 聚焦到第一个输入字段
            setTimeout(() => {
                const firstInput = modalElement.querySelector('input[type="text"]');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 500);
        } catch (e) {
            console.error("执行showAddSubtaskModal函数出错:", e);
            showError(`显示添加子任务模态框时出错: ${e.message}`);
        }
    }
    
    // 创建子任务
    function createSubtask() {
        try {
            console.log("执行创建子任务");
            const taskId = getTaskId();
            if (!taskId) {
                showError("无法获取任务ID，无法添加子任务");
                return;
            }
            
            // 获取表单元素
            const form = document.getElementById('addSubtaskForm');
            if (!form) {
                showError("找不到子任务表单");
                return;
            }
            
            // 验证表单
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 获取表单数据
            // 检查input字段是否存在
            const titleInput = document.getElementById('subtaskTitle') || document.getElementById('subtaskName');
            if (!titleInput) {
                showError("找不到子任务标题输入框");
                return;
            }
            
            // 获取其他字段，使用可选链操作符防止错误
            const title = titleInput.value.trim();
            const description = document.getElementById('subtaskDescription')?.value.trim() || '';
            const dueDate = document.getElementById('subtaskDueDate')?.value || null;
            const assigneeId = document.getElementById('subtaskAssignee')?.value || null;
            const priority = document.getElementById('subtaskPriority')?.value || 'medium';
            
            if (!title) {
                showError("子任务标题不能为空");
                return;
            }
            
            // 构建请求数据
            const subtaskData = {
                title: title,
                description: description,
                parent_id: taskId,
                due_date: dueDate,
                assignee_id: assigneeId,
                priority: priority,
                status: 'todo'
            };
            
            console.log("创建子任务数据:", subtaskData);
            
            // 禁用提交按钮
            const confirmBtn = document.getElementById('confirmAddSubtaskBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '提交中...';
            }
            
            // 使用新的无CSRF验证API端点
            const apiUrl = `/tasks/${taskId}/subtasks/no_csrf?bypass_jwt=true`;
            
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(subtaskData)
            })
            .then(response => {
                console.log(`创建子任务API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('未授权，请重新登录');
                    } else if (response.status === 403) {
                        throw new Error('您没有权限添加子任务');
                    } else {
                        return response.text().then(text => {
                            try {
                                const errorData = JSON.parse(text);
                                throw new Error(errorData.error || errorData.message || '创建子任务失败');
                            } catch (e) {
                                throw new Error(`创建子任务失败: ${response.status} ${response.statusText}`);
                            }
                        });
                    }
                }
                
                return response.json();
            })
            .then(data => {
                console.log("子任务创建成功:", data);
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '提交';
                }
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSubtaskModal'));
                if (modal) {
                    modal.hide();
                }
                
                // 重新加载子任务
                loadSubtasks();
                
                // 显示成功消息
                showSuccess("子任务创建成功");
            })
            .catch(error => {
                console.error("创建子任务失败:", error);
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '提交';
                }
                
                // 显示错误消息
                showError(`创建子任务失败: ${error.message}`);
            });
        } catch (e) {
            console.error("执行createSubtask函数出错:", e);
            showError(`创建子任务时出错: ${e.message}`);
            
            // 恢复按钮状态
            const confirmBtn = document.getElementById('confirmAddSubtaskBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '提交';
            }
        }
    }
    
    // 显示添加风险模态框
    function showAddRiskModal() {
        try {
            console.log("显示添加风险模态框");
            
            // 获取模态框元素
            const modalElement = document.getElementById('addRiskModal');
            if (!modalElement) {
                showError("找不到添加风险模态框");
                return;
            }
            
            // 重置表单
            const form = document.getElementById('addRiskForm');
            if (form) {
                form.reset();
            }
            
            // 初始化模态框
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // 绑定提交事件
            const confirmBtn = document.getElementById('confirmAddRiskBtn');
            if (confirmBtn) {
                // 移除之前的事件处理器
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                
                // 添加新的事件处理器
                newBtn.addEventListener('click', createRisk);
            }
            
            // 聚焦到第一个输入字段
            setTimeout(() => {
                const firstInput = modalElement.querySelector('input[type="text"]');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 500);
        } catch (e) {
            console.error("执行showAddRiskModal函数出错:", e);
            showError(`显示添加风险模态框时出错: ${e.message}`);
        }
    }
    
    // 创建风险
    function createRisk() {
        try {
            console.log("执行创建风险");
            const taskId = getTaskId();
            if (!taskId) {
                showError("无法获取任务ID，无法添加风险");
                return;
            }
            
            // 获取表单元素
            const form = document.getElementById('addRiskForm');
            if (!form) {
                showError("找不到风险表单");
                return;
            }
            
            // 验证表单
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 安全获取表单数据，使用可选链操作符防止错误
            const title = document.getElementById('riskTitle')?.value.trim() || '';
            const description = document.getElementById('riskDescription')?.value.trim() || '';
            const probability = document.getElementById('riskProbability')?.value || 'medium';
            const impact = document.getElementById('riskImpact')?.value || 'medium';
            const status = document.getElementById('riskStatus')?.value || 'open';
            const mitigationPlan = document.getElementById('riskMitigation')?.value.trim() || '';
            
            if (!title) {
                showError("风险标题不能为空");
                return;
            }
            
            // 获取CSRF令牌
            let csrfToken = null;
            
            // 尝试从meta标签获取
            const metaCsrf = document.querySelector('meta[name="csrf-token"]');
            if (metaCsrf) {
                csrfToken = metaCsrf.getAttribute('content');
                console.log("从meta标签获取CSRF令牌:", csrfToken);
            }
            
            // 尝试从隐藏字段获取
            if (!csrfToken) {
                const csrfInput = document.querySelector('input[name="csrf_token"]');
                if (csrfInput) {
                    csrfToken = csrfInput.value;
                    console.log("从隐藏字段获取CSRF令牌:", csrfToken);
                }
            }
            
            // 尝试从全局变量获取
            if (!csrfToken && window.csrfToken) {
                csrfToken = window.csrfToken;
                console.log("从全局变量获取CSRF令牌:", csrfToken);
            }
            
            // 尝试从cookie获取
            if (!csrfToken) {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrf_token=')) {
                        csrfToken = cookie.substring(11);
                        console.log("从cookie获取CSRF令牌:", csrfToken);
                        break;
                    }
                }
            }
            
            // 构建请求数据
            const riskData = {
                title: title,
                description: description,
                probability: probability,
                impact: impact,
                status: status,
                mitigation_plan: mitigationPlan,
                task_id: taskId
            };
            
            // 如果有CSRF令牌，添加到数据中
            if (csrfToken) {
                riskData.csrf_token = csrfToken;
            }
            
            console.log("创建风险数据:", riskData);
            
            // 禁用提交按钮
            const confirmBtn = document.getElementById('confirmAddRiskBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '提交中...';
            }
            
            // 使用正确的URL和方法 - 使用API端点
            const apiUrl = `/api/tasks/${taskId}/risks?bypass_jwt=true&bypass_csrf=true`;
            console.log(`创建风险，使用API URL: ${apiUrl}`);
            
            // 使用fetch API发送请求
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRF-Token': csrfToken || ''
                },
                body: JSON.stringify(riskData)
            })
            .then(response => {
                console.log(`风险创建API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`创建风险失败: ${response.statusText || response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log("风险创建成功:", data);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('addRiskModal'));
                if (modal) {
                    modal.hide();
                }
                
                // 显示成功消息
                showSuccess("风险创建成功");
                
                // 重新加载风险列表
                loadRisks();
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '提交';
                }
            })
            .catch(error => {
                console.error("创建风险失败:", error);
                
                // 显示错误信息
                showError(`创建风险失败: ${error.message}`);
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '提交';
                }
                
                // 尝试备用方案
                console.log("API方法失败，尝试备用方案");
                sendRiskDataViaAjax(taskId, riskData, confirmBtn);
            });
        } catch (e) {
            console.error("执行createRisk函数出错:", e);
            showError(`创建风险时出错: ${e.message}`);
            
            // 恢复按钮状态
            const confirmBtn = document.getElementById('confirmAddRiskBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '提交';
            }
        }
    }
    
    // 通过Ajax发送风险数据的备用方案
    function sendRiskDataViaAjax(taskId, riskData, confirmBtn) {
        // 尝试不同的端点
        // 首先尝试主要API端点
        $.ajax({
            url: `/api/tasks/${taskId}/risks?bypass_jwt=true&bypass_csrf=true`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(riskData),
            success: function(data) {
                console.log("风险创建成功(主API):", data);
                handleRiskSuccess(data, confirmBtn);
            },
            error: function(xhr, status, error) {
                console.error("主API失败:", error);
                
                // 尝试第二个API端点
                $.ajax({
                    url: `/tasks/${taskId}/risks?bypass_jwt=true&bypass_csrf=true`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(riskData),
                    success: function(data) {
                        console.log("风险创建成功(备用API):", data);
                        handleRiskSuccess(data, confirmBtn);
                    },
                    error: function(xhr, status, error) {
                        console.error("备用API也失败:", error);
                        
                        // 最后尝试一般风险API
                        $.ajax({
                            url: '/api/risks?bypass_jwt=true&bypass_csrf=true',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({...riskData, task_id: taskId}),
                            success: function(data) {
                                console.log("风险创建成功(通用API):", data);
                                handleRiskSuccess(data, confirmBtn);
                            },
                            error: function(xhr, status, error) {
                                console.error("所有API方式均失败:", error);
                                handleRiskError(new Error("所有创建风险的尝试均失败"), confirmBtn);
                            }
                        });
                    }
                });
            }
        });
    }
    
    // 处理风险创建成功
    function handleRiskSuccess(data, confirmBtn) {
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addRiskModal'));
        if (modal) {
            modal.hide();
        }
        
        // 显示成功消息
        showSuccess("风险创建成功");
        
        // 重新加载风险列表
        loadRisks();
        
        // 恢复按钮状态
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '提交';
        }
    }
    
    // 处理风险创建错误
    function handleRiskError(error, confirmBtn) {
        // 显示错误信息
        showError(`创建风险失败: ${error.message}`);
        
        // 恢复按钮状态
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '提交';
        }
    }

    // 显示上传附件模态框
    function showUploadModal() {
        try {
            console.log("显示上传附件模态框");
            
            // 获取模态框元素
            const modalElement = document.getElementById('uploadAttachmentModal');
            if (!modalElement) {
                showError("找不到上传附件模态框");
                return;
            }
            
            // 重置表单
            const form = document.getElementById('uploadForm');
            if (form) {
                form.reset();
            }
            
            // 初始化模态框
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // 绑定提交事件
            const confirmBtn = document.getElementById('confirmUploadBtn');
            if (confirmBtn) {
                // 移除之前的事件处理器
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                
                // 添加新的事件处理器
                newBtn.addEventListener('click', uploadAttachment);
            }
            
            // 聚焦到第一个输入字段
            setTimeout(() => {
                const fileInput = document.getElementById('attachmentFile');
                if (fileInput) {
                    fileInput.focus();
                }
            }, 500);
        } catch (e) {
            console.error("执行showUploadModal函数出错:", e);
            showError(`显示上传附件模态框时出错: ${e.message}`);
        }
    }
    
    // 上传附件
    function uploadAttachment() {
        try {
            console.log("执行上传附件");
            const taskId = getTaskId();
            if (!taskId) {
                showError("无法获取任务ID，无法上传附件");
                return;
            }
            
            // 获取表单元素
            const form = document.getElementById('uploadForm');
            if (!form) {
                showError("找不到上传表单");
                return;
            }
            
            // 验证表单
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 获取文件
            const fileInput = document.getElementById('attachmentFile');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showError("请选择要上传的文件");
                return;
            }
            
            // 获取描述
            const description = document.getElementById('attachmentDescription').value;
            
            // 构建FormData
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('description', description);
            
            // 添加CSRF令牌
            // 先尝试从meta标签获取
            let csrfToken = null;
            const metaCsrf = document.querySelector('meta[name="csrf-token"]');
            if (metaCsrf) {
                csrfToken = metaCsrf.getAttribute('content');
            }
            
            // 或者从隐藏字段获取
            if (!csrfToken) {
                const csrfInput = document.querySelector('input[name="csrf_token"]');
                if (csrfInput) {
                    csrfToken = csrfInput.value;
                }
            }
            
            // 如果找到CSRF令牌，添加到请求中
            if (csrfToken) {
                formData.append('csrf_token', csrfToken);
            }
            
            // 为API URL添加bypass_csrf参数
            let apiUrl = `/tasks/${taskId}/attachments?bypass_jwt=true&bypass_csrf=true`;
            
            // 禁用提交按钮
            const confirmBtn = document.getElementById('confirmUploadBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '上传中...';
            }
            
            // 发送请求
            fetch(apiUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log(`上传附件API响应状态: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('未授权，请重新登录');
                    } else if (response.status === 403) {
                        throw new Error('您没有权限上传附件');
                    } else if (response.status === 400) {
                        // 如果是400错误，尝试添加更多参数并重试
                        if (!apiUrl.includes('bypass_csrf=true')) {
                            apiUrl += '&bypass_csrf=true';
                            
                            // 恢复按钮状态
                            if (confirmBtn) {
                                confirmBtn.disabled = false;
                                confirmBtn.innerHTML = '上传';
                            }
                            
                            // 显示提示并重试
                            console.log("检测到CSRF错误，添加bypass_csrf参数重试");
                            uploadAttachmentWithBypass(apiUrl, formData);
                            return new Promise(() => {}); // 返回一个永不解析的Promise以中断当前链
                        }
                    }
                    
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.error || errorData.message || '上传附件失败');
                        } catch (e) {
                            throw new Error(`上传附件失败: ${response.status} ${response.statusText}`);
                        }
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("附件上传成功:", data);
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '上传';
                }
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadAttachmentModal'));
                if (modal) {
                    modal.hide();
                }
                
                // 重新加载附件
                loadAttachments();
                
                // 显示成功消息
                showSuccess("附件上传成功");
            })
            .catch(error => {
                console.error("上传附件失败:", error);
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '上传';
                }
                
                // 显示错误消息
                showError(`上传附件失败: ${error.message}`);
            });
        } catch (e) {
            console.error("执行uploadAttachment函数出错:", e);
            showError(`上传附件时出错: ${e.message}`);
            
            // 恢复按钮状态
            const confirmBtn = document.getElementById('confirmUploadBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '上传';
            }
        }
    }
    
    // 使用绕过CSRF的方式上传附件
    function uploadAttachmentWithBypass(apiUrl, formData) {
        // 禁用提交按钮
        const confirmBtn = document.getElementById('confirmUploadBtn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '上传中...';
        }
        
        console.log("尝试使用绕过CSRF的方式上传附件:", apiUrl);
        
        fetch(apiUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log(`绕过CSRF上传附件API响应状态: ${response.status}`);
            
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || errorData.message || '上传附件失败');
                    } catch (e) {
                        throw new Error(`上传附件失败: ${response.status} ${response.statusText}`);
                    }
                });
            }
            
            return response.json();
        })
        .then(data => {
            console.log("附件上传成功:", data);
            
            // 恢复按钮状态
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '上传';
            }
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadAttachmentModal'));
            if (modal) {
                modal.hide();
            }
            
            // 重新加载附件
            loadAttachments();
            
            // 显示成功消息
            showSuccess("附件上传成功");
        })
        .catch(error => {
            console.error("上传附件失败:", error);
            
            // 恢复按钮状态
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '上传';
            }
            
            // 显示错误消息
            showError(`上传附件失败: ${error.message}`);
        });
    }

    // 页面加载完成后执行初始化逻辑
    document.addEventListener('DOMContentLoaded', function() {
        console.log("========= 页面加载完成，开始初始化任务详情页面 =========");
        
        try {
            // 获取和插入CSRF令牌
            fetchAndInjectCSRFToken();
            
            // 检查模态框是否存在，如果不存在则创建
            ensureModalsExist();
            
            // 获取URL中的任务ID参数
            const urlParams = new URLSearchParams(window.location.search);
            const urlTaskId = urlParams.get('task_id') || urlParams.get('id');
            const isEditMode = urlParams.get('edit') === 'true';
            
            if (isEditMode) {
                console.log("URL包含edit=true参数，页面将在加载后自动进入编辑模式");
            }
            
            // 检查是否有服务器注入的task_id变量
            // 使用JavaScript条件表达式代替Jinja2
            const serverTaskId = '{{ task_id|default("") }}';
            if (serverTaskId && serverTaskId !== '{{ task_id|default("") }}') {
                console.log("服务器注入的任务ID:", serverTaskId);
                window.task_id = serverTaskId;
                
                // 确保隐藏字段存在
                let taskIdField = document.getElementById('taskId');
                if (!taskIdField) {
                    console.log("创建taskId隐藏字段");
                    taskIdField = document.createElement('input');
                    taskIdField.type = 'hidden';
                    taskIdField.id = 'taskId';
                    taskIdField.name = 'task_id';
                    document.body.appendChild(taskIdField);
                }
                taskIdField.value = serverTaskId;
            } else {
                // 如果服务器没有注入task_id，但URL中有，创建隐藏字段
                if (urlTaskId) {
                    console.log("从URL获取到任务ID:", urlTaskId);
                    window.task_id = urlTaskId;
                    
                    // 确保隐藏字段存在
                    let taskIdField = document.getElementById('taskId');
                    if (!taskIdField) {
                        console.log("创建taskId隐藏字段");
                        taskIdField = document.createElement('input');
                        taskIdField.type = 'hidden';
                        taskIdField.id = 'taskId';
                        taskIdField.name = 'task_id';
                        document.body.appendChild(taskIdField);
                    }
                    taskIdField.value = urlTaskId;
                }
            }
            
            // 获取任务ID
            const taskId = getTaskId();
            
            if (taskId) {
                console.log("找到任务ID: " + taskId);
                
                // 确保页面上任务ID信息完整
                if (!document.getElementById('taskId')) {
                    console.log("未找到隐藏的taskId字段，创建一个");
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = 'taskId';
                    hiddenInput.value = taskId;
                    document.body.appendChild(hiddenInput);
                }
                
                // 将任务ID添加到所有API调用URL中作为数据属性
                document.body.setAttribute('data-task-id', taskId);
                
                // 加载任务详情
                setTimeout(() => {
                    console.log("开始加载任务详情数据");
                    loadTaskDetail().then(() => {
                        // 任务详情加载完成后检查是否需要切换到编辑模式
                        if (isEditMode) {
                            console.log("任务详情加载完成，准备切换到编辑模式");
                            setTimeout(() => {
                                toggleEditMode(true);
                            }, 500);
                        }
                    }).catch(err => {
                        console.error("加载任务详情失败:", err);
                    });
                }, 300);
            } else {
                console.error("无法获取任务ID - 页面加载失败");
                showError("无法获取任务ID，请确保URL中包含正确的任务ID参数");
                
                // 尝试在错误恢复模式下加载页面
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-warning my-3';
                errorDiv.innerHTML = `
                    <h4 class="alert-heading">任务ID获取失败</h4>
                    <p>可能的原因：</p>
                    <ul>
                        <li>URL中缺少任务ID参数</li>
                        <li>任务ID格式不正确</li>
                        <li>任务可能已被删除</li>
                    </ul>
                    <hr>
                    <p class="mb-0">请尝试通过任务列表页面重新访问该任务，或联系管理员。</p>
                    <button class="btn btn-outline-primary mt-2" onclick="window.location.href='/main/tasks?bypass_jwt=true'">返回任务列表</button>
                `;
                
                // 添加到页面上合适的位置
                const container = document.querySelector('.container-fluid') || document.body;
                const loadingIndicator = document.getElementById('loadingIndicator');
                
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                container.insertBefore(errorDiv, container.firstChild);
                return;
            }
        } catch (error) {
            console.error("初始化任务详情页面时出错:", error);
            showError("初始化任务详情页面时出错: " + error.message);
            
            // 确保加载指示器被隐藏
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }
    });
    
    // 确保所需的模态框存在
    function ensureModalsExist() {
        // 1. 确保添加风险模态框存在
        if (!document.getElementById('addRiskModal')) {
            console.log("创建风险模态框");
            const riskModal = document.createElement('div');
            riskModal.className = 'modal fade';
            riskModal.id = 'addRiskModal';
            riskModal.tabIndex = '-1';
            riskModal.setAttribute('aria-labelledby', 'addRiskModalLabel');
            riskModal.setAttribute('aria-hidden', 'true');
            
            riskModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addRiskModalLabel">添加风险</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addRiskForm">
                                <div class="mb-3">
                                    <label for="riskTitle" class="form-label">风险标题 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="riskTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="riskDescription" class="form-label">风险描述</label>
                                    <textarea class="form-control" id="riskDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="riskProbability" class="form-label">发生概率</label>
                                    <select class="form-select" id="riskProbability">
                                        <option value="low">低</option>
                                        <option value="medium" selected>中</option>
                                        <option value="high">高</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="riskImpact" class="form-label">影响程度</label>
                                    <select class="form-select" id="riskImpact">
                                        <option value="low">低</option>
                                        <option value="medium" selected>中</option>
                                        <option value="high">高</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="riskStatus" class="form-label">风险状态</label>
                                    <select class="form-select" id="riskStatus">
                                        <option value="open" selected>未处理</option>
                                        <option value="mitigating">缓解中</option>
                                        <option value="closed">已关闭</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="riskMitigation" class="form-label">缓解计划</label>
                                    <textarea class="form-control" id="riskMitigation" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="confirmAddRiskBtn">提交</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(riskModal);
        }
        
        // 2. 确保添加子任务模态框存在
        if (!document.getElementById('addSubtaskModal')) {
            console.log("创建子任务模态框");
            const subtaskModal = document.createElement('div');
            subtaskModal.className = 'modal fade';
            subtaskModal.id = 'addSubtaskModal';
            subtaskModal.tabIndex = '-1';
            subtaskModal.setAttribute('aria-labelledby', 'addSubtaskModalLabel');
            subtaskModal.setAttribute('aria-hidden', 'true');
            
            subtaskModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addSubtaskModalLabel">添加子任务</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addSubtaskForm">
                                <div class="mb-3">
                                    <label for="subtaskTitle" class="form-label">任务标题 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="subtaskTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="subtaskDescription" class="form-label">任务描述</label>
                                    <textarea class="form-control" id="subtaskDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="subtaskDueDate" class="form-label">截止日期</label>
                                    <input type="date" class="form-control" id="subtaskDueDate">
                                </div>
                                <div class="mb-3">
                                    <label for="subtaskAssignee" class="form-label">负责人</label>
                                    <select class="form-select" id="subtaskAssignee">
                                        <option value="">请选择负责人</option>
                                        <option value="1">管理员</option>
                                        <option value="2">项目经理</option>
                                        <option value="3">开发人员</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="subtaskPriority" class="form-label">优先级</label>
                                    <select class="form-select" id="subtaskPriority">
                                        <option value="low">低</option>
                                        <option value="medium" selected>中</option>
                                        <option value="high">高</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="confirmAddSubtaskBtn">提交</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(subtaskModal);
        }
        
        // 3. 确保上传附件模态框存在
        if (!document.getElementById('uploadAttachmentModal')) {
            console.log("创建上传附件模态框");
            const uploadModal = document.createElement('div');
            uploadModal.className = 'modal fade';
            uploadModal.id = 'uploadAttachmentModal';
            uploadModal.tabIndex = '-1';
            uploadModal.setAttribute('aria-labelledby', 'uploadAttachmentModalLabel');
            uploadModal.setAttribute('aria-hidden', 'true');
            
            uploadModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="uploadAttachmentModalLabel">上传附件</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="uploadForm">
                                <div class="mb-3">
                                    <label for="attachmentFile" class="form-label">选择文件 <span class="text-danger">*</span></label>
                                    <input type="file" class="form-control" id="attachmentFile" required>
                                </div>
                                <div class="mb-3">
                                    <label for="attachmentDescription" class="form-label">文件描述</label>
                                    <textarea class="form-control" id="attachmentDescription" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="confirmUploadBtn">上传</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(uploadModal);
        }
        
        // 添加事件监听器
        setTimeout(() => {
            // 为风险模态框添加事件
            const confirmRiskBtn = document.getElementById('confirmAddRiskBtn');
            if (confirmRiskBtn) {
                confirmRiskBtn.addEventListener('click', createRisk);
            }
            
            // 为子任务模态框添加事件
            const confirmSubtaskBtn = document.getElementById('confirmAddSubtaskBtn');
            if (confirmSubtaskBtn) {
                confirmSubtaskBtn.addEventListener('click', createSubtask);
            }
            
            // 为上传附件模态框添加事件
            const confirmUploadBtn = document.getElementById('confirmUploadBtn');
            if (confirmUploadBtn) {
                confirmUploadBtn.addEventListener('click', uploadAttachment);
            }
        }, 500);
    }
    
    // 获取并注入CSRF令牌
    function fetchAndInjectCSRFToken() {
        try {
            console.log("尝试获取CSRF令牌");
            
            // 先检查是否已经有令牌
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                console.log("已找到CSRF令牌元素，无需重新获取");
                return;
            }
            
            // 创建一个隐藏的CSRF令牌输入字段，用于表单提交
            fetch('/api/get-csrf-token?bypass_jwt=true')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`获取CSRF令牌失败: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.csrf_token) {
                    console.log("成功获取CSRF令牌");
                    
                    // 注入meta标签
                    const meta = document.createElement('meta');
                    meta.name = 'csrf-token';
                    meta.content = data.csrf_token;
                    document.head.appendChild(meta);
                    
                    // 注入隐藏输入
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = data.csrf_token;
                    document.body.appendChild(input);
                    
                    // 全局缓存
                    window.csrfToken = data.csrf_token;
                    
                    // 尝试其他端点
                    if (data.csrf_token) return;
                    
                    // 尝试Cookie方式
                    document.cookie = `csrf_token=${data.csrf_token}; path=/; SameSite=Lax`;
                }
            })
            .catch(error => {
                console.error("获取CSRF令牌失败:", error);
                
                // 尝试从其他端点获取
                console.log("尝试从备用端点获取CSRF令牌");
                fetch('/get-csrf-token?bypass_jwt=true')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`备用端点获取CSRF令牌失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.csrf_token) {
                        console.log("成功从备用端点获取CSRF令牌");
                        
                        // 注入meta标签
                        const meta = document.createElement('meta');
                        meta.name = 'csrf-token';
                        meta.content = data.csrf_token;
                        document.head.appendChild(meta);
                        
                        // 注入隐藏输入
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'csrf_token';
                        input.value = data.csrf_token;
                        document.body.appendChild(input);
                        
                        // 全局缓存
                        window.csrfToken = data.csrf_token;
                        
                        // 尝试Cookie方式
                        document.cookie = `csrf_token=${data.csrf_token}; path=/; SameSite=Lax`;
                    }
                })
                .catch(error => {
                    console.error("备用端点获取CSRF令牌失败:", error);
                    
                    // 失败也没关系，我们有bypass_csrf参数
                    console.log("将使用bypass_csrf参数绕过CSRF验证");
                    
                    // 创建一个伪造的令牌
                    const fakeToken = generateRandomToken();
                    
                    // 注入meta标签
                    const meta = document.createElement('meta');
                    meta.name = 'csrf-token';
                    meta.content = fakeToken;
                    document.head.appendChild(meta);
                    
                    // 注入隐藏输入
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = fakeToken;
                    document.body.appendChild(input);
                    
                    // 全局缓存
                    window.csrfToken = fakeToken;
                });
            });
        } catch (e) {
            console.error("执行fetchAndInjectCSRFToken函数出错:", e);
            // 创建一个随机令牌以备不时之需
            window.csrfToken = generateRandomToken();
        }
    }
    
    // 生成随机令牌
    function generateRandomToken() {
        return Array.from(crypto.getRandomValues(new Uint8Array(32)))
            .map(byte => byte.toString(16).padStart(2, '0'))
            .join('');
    }

    // 任务初始化函数
    function initTaskDetail() {
        try {
            console.log("初始化任务详情");
            
            // 检查URL参数是否包含edit=true
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            
            // 任务ID
            const taskId = getTaskId();
            
            if (!taskId) {
                showError("无法获取任务ID");
                return;
            }
            
            console.log(`初始化任务详情, ID: ${taskId}, 编辑模式: ${isEditMode}`);
            
            // 加载任务详情
            loadTaskDetail(taskId)
                .then(taskData => {
                    if (taskData) {
                        console.log("任务数据加载成功，检查是否需要进入编辑模式");
                        // 如果URL包含edit=true，进入编辑模式
                        if (isEditMode) {
                            console.log("检测到edit=true参数，切换到编辑模式");
                            setTimeout(() => {
                                toggleEditMode(true);
                            }, 500); // 增加延迟以确保DOM完全加载
                        }
                    }
                })
                .catch(error => {
                    console.error("加载任务详情失败:", error);
                    showError(`加载任务详情失败: ${error.message}`);
                });
        } catch (e) {
            console.error("执行initTaskDetail函数出错:", e);
            showError(`初始化任务详情时出错: ${e.message}`);
        }
    }

    // 添加空的loadTaskLogs函数以避免错误
    function loadTaskLogs() {
        console.log("加载任务日志");
        const logsContainer = document.getElementById('taskLogsList');
        if (logsContainer) {
            logsContainer.innerHTML = '<div class="alert alert-info">暂无任务日志</div>';
        }
        return Promise.resolve();
    }
</script>
{% endblock %}