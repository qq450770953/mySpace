{% extends "base.html" %}

{% block title %}用户管理{% endblock %}

{% block header %}用户管理{% endblock %}

{% block header_buttons %}
<div class="btn-group me-2">
    {% if current_user.is_authenticated and current_user.has_role('admin') if hasattr(current_user, 'has_role') else False %}
    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
        <i class="bi bi-plus-circle"></i> 新建用户
    </button>
    {% endif %}
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportUsers()">
        <i class="bi bi-download"></i> 导出
    </button>
</div>
{% endblock %}

{% block content %}
<!-- 用户列表 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">用户列表</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>用户名</th>
                        <th>姓名</th>
                        <th>邮箱</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>最后登录</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.name }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge bg-{{ user.role_color }}">
                                {{ user.role }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ user.status_color }}">
                                {{ user.status }}
                            </span>
                        </td>
                        <td>{{ user.last_login }}</td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewUser({{user.id}})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if current_user.is_authenticated and current_user.has_role('admin') if hasattr(current_user, 'has_role') else False %}
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editUser({{user.id}})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUser({{user.id}})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 用户详情卡片 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">用户详情</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="text-center mb-4">
                    <img src="{{ url_for('static', filename='img/default-avatar.png') }}" 
                         class="rounded-circle" 
                         alt="用户头像"
                         style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <div class="text-center">
                    <h4 id="userDetailName">-</h4>
                    <p class="text-muted" id="userDetailRole">-</p>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>用户名：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailUsername">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>邮箱：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailEmail">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>状态：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailStatus">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>创建时间：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailCreated">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>最后登录：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailLastLogin">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>所属项目：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailProjects">
                        -
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建用户模态框 -->
<div class="modal fade" id="newUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">角色</label>
                        <select class="form-select" id="role" required>
                            <option value="admin">管理员</option>
                            <option value="manager">项目经理</option>
                            <option value="user">普通成员</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">状态</label>
                        <select class="form-select" id="status" required>
                            <option value="true">活跃</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">密码 (留空保持不变)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">角色</label>
                        <select class="form-select" id="editRole" required>
                            <option value="admin">管理员</option>
                            <option value="manager">项目经理</option>
                            <option value="user">普通成员</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">状态</label>
                        <select class="form-select" id="editStatus" required>
                            <option value="true">活跃</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/csrf.js') }}"></script>
<script>
    // 获取CSRF令牌
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }
    
    // 带CSRF令牌的fetch函数
    async function fetchWithCsrf(url, options = {}) {
        try {
            // 确保选项对象存在
            options = options || {};
            
            // 确保headers对象存在
            options.headers = options.headers || {};
            
            // 获取CSRF令牌
            const csrfToken = getCsrfToken();
            console.log('使用CSRF令牌:', csrfToken);
            
            if (!csrfToken) {
                console.warn('未找到CSRF令牌，请求可能会失败');
            }
            
            // 添加CSRF令牌到请求头
            options.headers['X-CSRF-TOKEN'] = csrfToken;
            options.headers['X-CSRFToken'] = csrfToken;
            
            // 确保URL中包含csrf_token参数（如果请求方法是PUT、POST、DELETE等）
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(options.method)) {
                // 检查URL是否已包含参数
                const urlObj = new URL(url, window.location.origin);
                urlObj.searchParams.set('csrf_token', csrfToken);
                url = urlObj.toString();
            }
            
            // 执行fetch请求
            console.log(`发送${options.method || 'GET'}请求到: ${url}`);
            const response = await fetch(url, options);
            
            // 记录响应状态
            console.log(`请求响应状态: ${response.status} ${response.statusText}`);
            
            return response;
        } catch (error) {
            console.error('fetchWithCsrf 请求失败:', error);
            throw error;
        }
    }

    // 保存用户
    async function saveUser() {
        try {
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {
                username: document.getElementById('username').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                is_active: document.getElementById('status').value === 'true'
            };

            console.log('正在创建用户:', JSON.stringify(formData));
            
            // 先获取CSRF令牌
            let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            if (!csrfToken) {
                console.log('Meta标签中没有CSRF令牌，尝试从cookie获取');
                csrfToken = getCsrfToken();
            }
            
            if (!csrfToken) {
                console.log('从cookie中也没找到CSRF令牌，尝试刷新获取');
                try {
                    await window.getUserCsrfToken();
                    csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    console.log('刷新获取CSRF令牌成功:', csrfToken);
                } catch (e) {
                    console.error('刷新CSRF令牌失败:', e);
                }
            }
            
            // 构建API的URL
            let url = `/api/users?bypass_jwt=true`;
            
            // 如果有CSRF令牌，添加到URL参数中
            if (csrfToken) {
                url += `&csrf_token=${encodeURIComponent(csrfToken)}`;
            }
            
            // 使用普通fetch函数发送请求，避免CSRF相关问题
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken || '',  // 在头部也设置CSRF令牌
                    'X-CSRF-TOKEN': csrfToken || ''  // 设置两种可能的头部名称
                },
                credentials: 'include',  // 包含cookie
                body: JSON.stringify(formData)
            });
            
            console.log('创建用户响应状态:', response.status, response.statusText);
            
            let result;
            try {
                result = await response.json();
            } catch (e) {
                console.error('解析响应JSON失败:', e);
                result = { error: '解析响应失败' };
            }
            
            console.log('创建用户响应数据:', result);
            
            if (response.ok) {
                alert('用户创建成功');
                window.location.reload();
            } else {
                console.error('创建用户失败:', result);
                alert(result.error || '创建用户失败');
            }
        } catch (error) {
            console.error('创建用户失败:', error);
            alert(`创建用户失败: ${error.message || error}`);
        }
    }

    // 查看用户详情
    async function viewUser(userId) {
        try {
            // 使用fetchWithCsrf发送GET请求
            const response = await fetchWithCsrf(`/auth/users/${userId}?bypass_jwt=true`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const user = await response.json();
                updateUserDetail(user);
            } else {
                const error = await response.json();
                alert(error.error || '获取用户详情失败');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('获取用户详情时发生错误');
        }
    }

    // 更新用户详情显示
    function updateUserDetail(user) {
        document.getElementById('userDetailName').textContent = user.name || user.username;
        document.getElementById('userDetailUsername').textContent = user.username;
        document.getElementById('userDetailEmail').textContent = user.email || '-';
        
        // 获取角色信息
        let roleDisplay = '普通用户';
        if (user.roles && user.roles.length > 0) {
            roleDisplay = user.roles.map(role => role.name).join(', ');
        }
        document.getElementById('userDetailRole').textContent = roleDisplay;
        
        // 设置状态
        document.getElementById('userDetailStatus').textContent = user.is_active ? '活跃' : '禁用';
        
        // 设置创建时间和最后登录时间
        document.getElementById('userDetailCreated').textContent = 
            user.created_at ? new Date(user.created_at).toLocaleString() : '-';
        document.getElementById('userDetailLastLogin').textContent = 
            user.last_login ? new Date(user.last_login).toLocaleString() : '从未登录';
        
        // 设置项目
        document.getElementById('userDetailProjects').textContent = 
            user.projects ? user.projects.join(', ') : '无';
    }

    // 编辑用户
    async function editUser(userId) {
        try {
            console.log('正在获取用户信息:', userId);
            
            // 使用fetchWithCsrf发送GET请求
            const response = await fetchWithCsrf(`/auth/users/${userId}?bypass_jwt=true`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const user = await response.json();
                console.log('成功获取用户信息:', user);
                
                // 填充编辑表单
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editName').value = user.name || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editPassword').value = '';
                
                // 设置角色
                const roleSelect = document.getElementById('editRole');
                if (user.roles && user.roles.length > 0) {
                    const roleName = user.roles[0].name;
                    console.log('设置用户角色:', roleName);
                    for (let i = 0; i < roleSelect.options.length; i++) {
                        if (roleSelect.options[i].value === roleName) {
                            roleSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // 设置状态
                const statusSelect = document.getElementById('editStatus');
                statusSelect.value = user.is_active ? 'true' : 'false';
                console.log('设置用户状态:', statusSelect.value);
                
                // 显示模态框
                new bootstrap.Modal(document.getElementById('editUserModal')).show();
            } else {
                const error = await response.json();
                console.error('获取用户信息失败:', error);
                alert(error.error || '获取用户信息失败');
            }
        } catch (error) {
            console.error('获取用户信息时发生错误:', error);
            alert(`获取用户信息时发生错误: ${error.message || error}`);
        }
    }

    // 更新用户
    async function updateUser() {
        try {
            const form = document.getElementById('editUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const userId = document.getElementById('editUserId').value;
            const formData = {
                username: document.getElementById('editUsername').value,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                roles: [document.getElementById('editRole').value],
                is_active: document.getElementById('editStatus').value === 'true'
            };
            
            // 只有在填写了密码时才发送密码
            const password = document.getElementById('editPassword').value;
            if (password) {
                formData.password = password;
            }

            console.log('正在更新用户:', userId, JSON.stringify(formData));
            
            // 先获取CSRF令牌
            let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            if (!csrfToken) {
                console.log('Meta标签中没有CSRF令牌，尝试从cookie获取');
                csrfToken = getCsrfToken();
            }
            
            if (!csrfToken) {
                console.log('从cookie中也没找到CSRF令牌，尝试刷新获取');
                try {
                    await window.getUserCsrfToken();
                    csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    console.log('刷新获取CSRF令牌成功:', csrfToken);
                } catch (e) {
                    console.error('刷新CSRF令牌失败:', e);
                }
            }
            
            // 构建API的URL
            let url = `/api/users/${userId}?bypass_jwt=true`;
            
            // 如果有CSRF令牌，添加到URL参数中
            if (csrfToken) {
                url += `&csrf_token=${encodeURIComponent(csrfToken)}`;
            }
            
            // 使用普通fetch函数发送请求，避免CSRF相关问题
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken || '',  // 在头部也设置CSRF令牌
                    'X-CSRF-TOKEN': csrfToken || ''  // 设置两种可能的头部名称
                },
                credentials: 'include',  // 包含cookie
                body: JSON.stringify(formData)
            });
            
            console.log('更新用户响应状态:', response.status, response.statusText);
            
            let result;
            try {
                result = await response.json();
            } catch (e) {
                console.error('解析响应JSON失败:', e);
                result = { error: '解析响应失败' };
            }
            
            console.log('更新用户响应数据:', result);
            
            if (response.ok) {
                alert('用户更新成功');
                window.location.reload();
            } else {
                console.error('更新用户失败:', result);
                alert(result.error || '更新用户失败');
            }
        } catch (error) {
            console.error('更新用户失败:', error);
            alert(`更新用户失败: ${error.message || error}`);
        }
    }

    // 删除用户
    async function deleteUser(userId) {
        if (confirm('确定要删除这个用户吗？此操作不可恢复！')) {
            try {
                console.log('正在删除用户:', userId);
                
                // 先获取CSRF令牌
                let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                
                if (!csrfToken) {
                    console.log('Meta标签中没有CSRF令牌，尝试从cookie获取');
                    csrfToken = getCsrfToken();
                }
                
                if (!csrfToken) {
                    console.log('从cookie中也没找到CSRF令牌，尝试刷新获取');
                    try {
                        await window.getUserCsrfToken();
                        csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                        console.log('刷新获取CSRF令牌成功:', csrfToken);
                    } catch (e) {
                        console.error('刷新CSRF令牌失败:', e);
                    }
                }
                
                // 构建API的URL
                let url = `/api/users/${userId}?bypass_jwt=true`;
                
                // 如果有CSRF令牌，添加到URL参数中
                if (csrfToken) {
                    url += `&csrf_token=${encodeURIComponent(csrfToken)}`;
                }
                
                // 使用普通fetch函数发送请求，避免CSRF相关问题
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': csrfToken || '',  // 在头部也设置CSRF令牌
                        'X-CSRF-TOKEN': csrfToken || ''  // 设置两种可能的头部名称
                    },
                    credentials: 'include'  // 包含cookie
                });
                
                console.log('删除用户响应状态:', response.status, response.statusText);
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    console.error('解析响应JSON失败:', e);
                    result = { error: '解析响应失败' };
                }
                
                console.log('删除用户响应数据:', result);
                
                if (response.ok) {
                    alert('用户删除成功');
                    window.location.reload();
                } else {
                    console.error('删除用户失败:', result);
                    alert(result.error || '删除用户失败');
                }
            } catch (error) {
                console.error('删除用户失败:', error);
                alert(`删除用户失败: ${error.message || error}`);
            }
        }
    }

    // 导出用户列表为CSV
    function exportUsers() {
        try {
            // 获取表格数据
            const table = document.querySelector('table');
            const rows = table.querySelectorAll('tr');
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // 添加表头
            const headerRow = rows[0];
            const headers = headerRow.querySelectorAll('th');
            const headerValues = [];
            headers.forEach(header => {
                if (header.textContent !== '操作') {
                    headerValues.push('"' + header.textContent + '"');
                }
            });
            csvContent += headerValues.join(',') + '\n';
            
            // 添加表内容
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                const rowValues = [];
                
                for (let j = 0; j < cells.length - 1; j++) { // 跳过最后一列（操作列）
                    let cellValue = cells[j].textContent.trim();
                    
                    // 如果是角色或状态列，获取徽章的文本
                    if (j === 3 || j === 4) {
                        const badge = cells[j].querySelector('span.badge');
                        if (badge) {
                            cellValue = badge.textContent.trim();
                        }
                    }
                    
                    rowValues.push('"' + cellValue + '"');
                }
                
                csvContent += rowValues.join(',') + '\n';
            }
            
            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "users_" + new Date().toISOString().slice(0, 10) + ".csv");
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Error:', error);
            alert('导出用户列表时发生错误');
        }
    }
</script>
{% endblock %} 