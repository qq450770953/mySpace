{% extends "base.html" %}

{% block title %}用户管理{% endblock %}

{% block header %}用户管理{% endblock %}

{% block header_buttons %}
<div class="btn-group me-2">
    {% if 'admin' in current_user_data.roles %}
    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
        <i class="bi bi-plus-circle"></i> 新建用户
    </button>
    {% endif %}
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportUsers()">
        <i class="bi bi-download"></i> 导出
    </button>
</div>
{% endblock %}

{% block content %}
<!-- 用户列表 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">用户列表</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>用户名</th>
                        <th>姓名</th>
                        <th>邮箱</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>最后登录</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.name }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge bg-{{ user.role_color }}">
                                {{ user.display_role }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ user.status_color }}">
                                {{ user.status }}
                            </span>
                        </td>
                        <td>{{ user.last_login_display }}</td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewUser({{user.id}})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if 'admin' in current_user_data.roles %}
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editUser({{user.id}})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUser({{user.id}})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 用户详情卡片 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">用户详情</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="text-center mb-4">
                    <img src="{{ url_for('static', filename='img/default-avatar.png') }}" 
                         class="rounded-circle" 
                         alt="用户头像"
                         style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <div class="text-center">
                    <h4 id="userDetailName">-</h4>
                    <p class="text-muted" id="userDetailRole">-</p>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>用户名：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailUsername">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>邮箱：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailEmail">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>状态：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailStatus">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>创建时间：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailCreated">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>最后登录：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailLastLogin">
                        -
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>所属项目：</strong>
                    </div>
                    <div class="col-sm-9" id="userDetailProjects">
                        -
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建用户模态框 -->
<div class="modal fade" id="newUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">角色</label>
                        <select class="form-select" id="role" required>
                            <option value="admin">管理员</option>
                            <option value="manager">项目经理</option>
                            <option value="user">普通成员</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">状态</label>
                        <select class="form-select" id="status" required>
                            <option value="true">活跃</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">密码 (留空保持不变)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">角色</label>
                        <select class="form-select" id="editRole" required>
                            <option value="admin">管理员</option>
                            <option value="manager">项目经理</option>
                            <option value="user">普通成员</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">状态</label>
                        <select class="form-select" id="editStatus" required>
                            <option value="true">活跃</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 获取CSRF令牌
    function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrf_token') {
                return value;
            }
        }
        return null;
    }

    // 带CSRF令牌的fetch
    async function fetchWithCsrf(url, options = {}) {
        try {
            // 获取CSRF令牌
            let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            if (!csrfToken) {
                csrfToken = getCsrfToken();
            }
            
            if (!csrfToken) {
                try {
                    await window.getUserCsrfToken();
                    csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                } catch (e) {
                    console.error('获取CSRF令牌失败:', e);
                }
            }
            
            // 如果URL没有参数，添加?，否则添加&
            const separator = url.includes('?') ? '&' : '?';
            url = url + separator + `bypass_jwt=true`;
            
            if (csrfToken) {
                url += `&csrf_token=${encodeURIComponent(csrfToken)}`;
            }
            
            // 设置默认的fetch选项
            const fetchOptions = {
                ...options,
                credentials: 'include'  // 包含cookie
            };
            
            // 添加CSRF头
            fetchOptions.headers = {
                ...fetchOptions.headers,
                'X-CSRFToken': csrfToken || '',
                'X-CSRF-TOKEN': csrfToken || ''
            };
            
            // 发送请求
            console.log(`发送请求到 ${url}`, fetchOptions);
            const response = await fetch(url, fetchOptions);
            
            return response;
        } catch (error) {
            console.error('fetchWithCsrf 请求失败:', error);
            throw error;
        }
    }

    // 保存用户
    async function saveUser() {
        try {
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {
                username: document.getElementById('username').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                is_active: document.getElementById('status').value === 'true'
            };

            console.log('正在创建用户:', JSON.stringify(formData));
            
            // 使用API端点
            const response = await fetchWithCsrf(`/api/auth/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            console.log('创建用户响应状态:', response.status, response.statusText);
            
            let result;
            try {
                result = await response.json();
            } catch (e) {
                console.error('解析响应JSON失败:', e);
                result = { error: '解析响应失败' };
            }
            
            console.log('创建用户响应数据:', result);
            
            if (response.ok) {
                alert('用户创建成功');
                window.location.reload();
            } else {
                console.error('创建用户失败:', result);
                alert(result.error || '创建用户失败');
            }
        } catch (error) {
            console.error('创建用户失败:', error);
            alert(`创建用户失败: ${error.message || error}`);
        }
    }

    // 查看用户详情
    async function viewUser(userId) {
        try {
            // 使用API端点
            const response = await fetchWithCsrf(`/api/auth/users/${userId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const user = await response.json();
                updateUserDetail(user);
            } else {
                const error = await response.json();
                alert(error.error || '获取用户详情失败');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('获取用户详情时发生错误');
        }
    }

    // 更新用户详情显示
    function updateUserDetail(user) {
        document.getElementById('userDetailName').textContent = user.name || user.username;
        document.getElementById('userDetailUsername').textContent = user.username;
        document.getElementById('userDetailEmail').textContent = user.email || '-';
        
        // 获取角色信息
        let roleDisplay = '普通用户';
        if (user.roles && user.roles.length > 0) {
            roleDisplay = user.roles.join(', ');
        }
        document.getElementById('userDetailRole').textContent = roleDisplay;
        
        // 设置状态
        document.getElementById('userDetailStatus').textContent = user.is_active ? '活跃' : '禁用';
        
        // 设置创建时间和最后登录时间
        document.getElementById('userDetailCreated').textContent = 
            user.created_at ? new Date(user.created_at).toLocaleString() : '-';
        document.getElementById('userDetailLastLogin').textContent = 
            user.last_login ? new Date(user.last_login).toLocaleString() : '从未登录';
        
        // 设置项目
        document.getElementById('userDetailProjects').textContent = '无';
    }

    // 编辑用户
    async function editUser(userId) {
        try {
            console.log('正在获取用户信息:', userId);
            
            // 使用API端点
            const response = await fetchWithCsrf(`/api/auth/users/${userId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const user = await response.json();
                console.log('成功获取用户信息:', user);
                
                // 填充编辑表单
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editName').value = user.name || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editPassword').value = '';
                
                // 设置角色
                const roleSelect = document.getElementById('editRole');
                if (user.roles && user.roles.length > 0) {
                    const roleName = user.roles[0];
                    console.log('设置用户角色:', roleName);
                    for (let i = 0; i < roleSelect.options.length; i++) {
                        if (roleSelect.options[i].value === roleName) {
                            roleSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // 设置状态
                const statusSelect = document.getElementById('editStatus');
                statusSelect.value = user.is_active ? 'true' : 'false';
                console.log('设置用户状态:', statusSelect.value);
                
                // 显示模态框
                new bootstrap.Modal(document.getElementById('editUserModal')).show();
            } else {
                const error = await response.json();
                console.error('获取用户信息失败:', error);
                alert(error.error || '获取用户信息失败');
            }
        } catch (error) {
            console.error('获取用户信息时发生错误:', error);
            alert(`获取用户信息时发生错误: ${error.message || error}`);
        }
    }

    // 更新用户
    async function updateUser() {
        try {
            const form = document.getElementById('editUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const userId = document.getElementById('editUserId').value;
            const formData = {
                username: document.getElementById('editUsername').value,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                is_active: document.getElementById('editStatus').value === 'true'
            };
            
            // 只有当密码不为空时，才添加密码到表单数据
            const password = document.getElementById('editPassword').value;
            if (password) {
                formData.password = password;
            }
            
            console.log('正在更新用户:', userId, JSON.stringify(formData));
            
            // 使用API端点
            const response = await fetchWithCsrf(`/api/auth/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('更新用户成功:', result);
                alert('用户更新成功');
                window.location.reload();
            } else {
                const error = await response.json();
                console.error('更新用户失败:', error);
                alert(error.error || '更新用户失败');
            }
        } catch (error) {
            console.error('更新用户失败:', error);
            alert(`更新用户失败: ${error.message || error}`);
        }
    }

    // 删除用户
    async function deleteUser(userId) {
        if (!confirm('确定要删除此用户吗？此操作不可恢复。')) {
            return;
        }
        
        try {
            console.log('正在删除用户:', userId);
            
            // 使用API端点
            const response = await fetchWithCsrf(`/api/auth/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('删除用户成功:', result);
                alert('用户已成功删除');
                window.location.reload();
            } else {
                const error = await response.json();
                console.error('删除用户失败:', error);
                alert(error.error || '删除用户失败');
            }
        } catch (error) {
            console.error('删除用户失败:', error);
            alert(`删除用户失败: ${error.message || error}`);
        }
    }

    // 导出用户列表
    function exportUsers() {
        alert('导出功能尚未实现');
    }
</script>
{% endblock %} 