{% extends "base.html" %}

{% block page_content %}
<div class="container mt-4">
    <!-- 项目基本信息 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">项目详情</h5>
                    <div>
                        <a href="{{ url_for('main.projects') }}" class="btn btn-sm btn-outline-secondary me-1">
                            <i class="bi bi-arrow-left"></i> 返回项目列表
                        </a>
                        {% if not user_is_regular(current_user) %}
                        <button type="button" class="btn btn-sm btn-primary edit-btn" id="editProjectBtn">
                            <i class="bi bi-pencil"></i> 编辑项目
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 class="card-title">{{ project.name }}</h2>
                    </div>
                    <p class="card-text">{{ project.description }}</p>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>负责人：</strong>{{ project.manager.name }}</p>
                            <p><strong>开始日期：</strong>{{ project.start_date.strftime('%Y-%m-%d') }}</p>
                            <p><strong>结束日期：</strong>{{ project.end_date.strftime('%Y-%m-%d') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>状态：</strong>
                                <span class="badge bg-{{ 'success' if project.status == 'active' else 'warning' if project.status == 'pending' else 'danger' }}">
                                    {{ project.status }}
                                </span>
                            </p>
                            <p><strong>进度：</strong></p>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                aria-valuenow="{{ project.progress }}"
                                aria-valuemin="0"
                                aria-valuemax="100"
                                     style="width: {{ project.progress }}%">
                                    {{ project.progress }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">项目成员</h5>
                    <div class="mb-3">
                        {% if not user_is_regular(current_user) %}
                        <button type="button" class="btn btn-sm btn-primary" id="addMemberBtn">
                            <i class="fas fa-user-plus"></i> 添加成员
                        </button>
                        {% endif %}
                    </div>
                    <ul class="list-group">
                        {% for member in project.members %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ member.name }}
                            <div>
                                <span class="badge bg-primary rounded-pill">{{ member.role }}</span>
                                {% if not user_is_regular(current_user) %}
                                <button class="btn btn-sm btn-danger delete-btn" data-action="remove" data-project-id="{{ project.id }}" data-member-id="{{ member.id }}">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务管理 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card my-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">项目任务</h5>
                    {% if current_user.is_authenticated and (current_user.has_permission('manage_task') if hasattr(current_user, 'has_permission') else False or current_user.has_permission('manage_all_tasks') if hasattr(current_user, 'has_permission') else False or current_user.has_role('admin') if hasattr(current_user, 'has_role') else False or current_user.has_role('manager') if hasattr(current_user, 'has_role') else False) %}
                    <button type="button" class="btn btn-sm btn-primary" id="addTaskBtn">
                        <i class="bi bi-plus-lg"></i> 新建任务
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>任务名称</th>
                                    <th>状态</th>
                                    <th>优先级</th>
                                    <th>负责人</th>
                                    <th>截止日期</th>
                                    <th>进度</th>
                                    <th class="text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="projectTasksTableBody">
                                <!-- 任务数据将通过JavaScript填充 -->
                                <!-- 示例任务行 -->
                                <tr class="task-loading">
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                        加载项目任务...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 项目风险 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card my-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">风险管理</h5>
                    {% if current_user.is_authenticated and (current_user.has_permission('manage_risks') if hasattr(current_user, 'has_permission') else False or current_user.has_role('admin') if hasattr(current_user, 'has_role') else False or current_user.has_role('manager') if hasattr(current_user, 'has_role') else False) %}
                    <button type="button" class="btn btn-sm btn-primary" id="addRiskBtn">
                        <i class="bi bi-plus-lg"></i> 添加风险
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>风险名称</th>
                                    <th>风险描述</th>
                                    <th>风险等级</th>
                                    <th>风险概率</th>
                                    <th>风险影响</th>
                                    <th>风险控制措施</th>
                                    <th class="text-end">操作</th>
                                </tr>
                            </thead>
                            <tbody id="riskList">
                                {% for risk in project.risks %}
                                <tr data-risk-id="{{ risk.id }}">
                                    <td>{{ risk.name }}</td>
                                    <td>{{ risk.description }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if risk.level == 'high' else 'warning' if risk.level == 'medium' else 'info' }}">
                                            {{ risk.level }}
                                        </span>
                                    </td>
                                    <td>{{ risk.probability }}</td>
                                    <td>{{ risk.impact }}</td>
                                    <td>{{ risk.control_measures }}</td>
                                    <td class="text-end">
                                        <div class="risk-operations">
                                            {% if current_user.is_authenticated and (current_user.has_permission('manage_risks') if hasattr(current_user, 'has_permission') else False or current_user.has_role('admin') if hasattr(current_user, 'has_role') else False or current_user.has_role('manager') if hasattr(current_user, 'has_role') else False) %}
                                            <button class="btn btn-sm btn-outline-primary edit-btn" data-action="edit" data-risk-id="{{ risk.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-btn" data-action="delete" data-risk-id="{{ risk.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 资源分配 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card my-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">资源分配</h5>
                    {% if current_user.is_authenticated and (current_user.has_permission('manage_resources') if hasattr(current_user, 'has_permission') else False or current_user.has_role('admin') if hasattr(current_user, 'has_role') else False or current_user.has_role('manager') if hasattr(current_user, 'has_role') else False) %}
                    <button type="button" class="btn btn-sm btn-primary" id="addResourceBtn">
                        <i class="bi bi-plus-lg"></i> 分配资源
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>资源名称</th>
                                    <th>资源类型</th>
                                    <th>分配给</th>
                                    <th>分配日期</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="resourceList">
                                {% for resource in project.resources %}
                                <tr data-resource-id="{{ resource.id }}">
                                    <td>{{ resource.name }}</td>
                                    <td>{{ resource.type }}</td>
                                    <td>{{ resource.assigned_to }}</td>
                                    <td>{{ resource.assigned_date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-end">
                                        <div class="resource-operations">
                                            {% if current_user.is_authenticated and (current_user.has_permission('manage_resources') if hasattr(current_user, 'has_permission') else False or current_user.has_role('admin') if hasattr(current_user, 'has_role') else False or current_user.has_role('manager') if hasattr(current_user, 'has_role') else False) %}
                                            <button class="btn btn-sm btn-outline-primary edit-btn" data-action="edit" data-resource-id="{{ resource.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-btn" data-action="delete" data-resource-id="{{ resource.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加成员模态框 -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加项目成员</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMemberForm">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <div class="mb-3">
                        <label class="form-label">选择成员</label>
                        <select class="form-select" name="user_id" required>
                            <option value="">选择成员...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">角色</label>
                        <select class="form-select" name="role" required>
                            <option value="member">普通成员</option>
                            <option value="developer">开发人员</option>
                            <option value="tester">测试人员</option>
                            <option value="designer">设计师</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveMember">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 任务编辑模态框 -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalTitle">新建任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId" name="id">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <div class="mb-3">
                        <label class="form-label">任务名称</label>
                        <input type="text" class="form-control" id="taskName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">任务描述</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">负责人</label>
                        <select class="form-select" id="taskAssignee" name="assignee_id" required>
                            <option value="">选择负责人...</option>
                            {% for member in project.members %}
                            <option value="{{ member.id }}">{{ member.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="taskStartDate" name="start_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="taskEndDate" name="end_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">优先级</label>
                        <select class="form-select" id="taskPriority" name="priority" required>
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">状态</label>
                        <select class="form-select" id="taskStatus" name="status" required>
                            <option value="todo">待办</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">进度</label>
                        <input type="range" class="form-range" id="taskProgress" name="progress" min="0" max="100" step="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTask">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { taskUtils } from '/static/js/utils/index.js';
    
    // 初始化任务操作
    taskUtils.initTaskOperations();
    
    // 为表格绑定事件委托处理
    document.addEventListener('DOMContentLoaded', function() {
        // 刷新表格行样式
        const taskRows = document.querySelectorAll('#taskList tr');
        taskRows.forEach(row => {
            // 添加数据状态样式
            const statusCell = row.querySelector('td:nth-child(6)');
            if (statusCell) {
                const status = statusCell.textContent.trim().toLowerCase();
                row.classList.add('task-status-' + status.replace(' ', '-'));
            }
        });
        
        // 检查用户角色并隐藏按钮
        if (typeof isRegularUser === 'function' && isRegularUser()) {
            console.log('项目详情页：当前用户是普通用户，隐藏编辑按钮');
            
            // 隐藏所有编辑和删除按钮
            document.querySelectorAll('[data-action="edit"], [data-action="delete"], [data-action="remove"]').forEach(function(btn) {
                btn.style.display = 'none';
            });
            
            // 隐藏新建任务按钮
            document.querySelectorAll('[data-bs-target="#taskModal"], [data-bs-target="#addMemberModal"]').forEach(function(btn) {
                btn.style.display = 'none';
            });
            
            // 在表格中仅保留查看按钮
            document.querySelectorAll('.task-operations').forEach(function(container) {
                container.querySelectorAll('button').forEach(function(btn) {
                    // 如果不是查看按钮，则隐藏
                    if (!btn.innerHTML.includes('fa-eye')) {
                        btn.style.display = 'none';
                    }
                });
            });
        }
        
        // 初始化任务模态框事件处理
        initTaskModalEvents();
    });
    
    // 初始化任务模态框事件处理
    function initTaskModalEvents() {
        // 获取任务模态框元素和添加任务按钮
        const taskModal = document.getElementById('taskModal');
        const addTaskBtn = document.getElementById('addTaskBtn');
        
        if (taskModal && addTaskBtn) {
            console.log('初始化任务模态框事件处理');
            
            // 监听添加任务按钮点击事件
            addTaskBtn.addEventListener('click', function() {
                prepareTaskModal();
            });
            
            // 监听模态框显示事件
            taskModal.addEventListener('show.bs.modal', function() {
                prepareTaskModal();
            });
            
            // 绑定保存按钮事件
            const saveTaskBtn = document.getElementById('saveTask');
            if (saveTaskBtn) {
                saveTaskBtn.addEventListener('click', saveTaskHandler);
            }
        }
    }
    
    // 准备任务模态框
    function prepareTaskModal() {
        console.log('准备任务模态框...');
        
        // 获取表单和项目ID
        const taskForm = document.getElementById('taskForm');
        const projectIdInput = taskForm ? taskForm.querySelector('input[name="project_id"]') : null;
        
        if (taskForm) {
            // 重置表单
            taskForm.reset();
            
            // 设置默认日期值
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('taskStartDate');
            const endDateInput = document.getElementById('taskEndDate');
            
            if (startDateInput) startDateInput.value = today;
            if (endDateInput) {
                // 设置默认结束日期为一周后
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                endDateInput.value = nextWeek.toISOString().split('T')[0];
            }
            
            // 加载负责人列表
            loadProjectMembersAsAssignees(projectIdInput ? projectIdInput.value : null);
        }
    }
    
    // 加载项目成员作为负责人
    function loadProjectMembersAsAssignees(projectId) {
        if (!projectId) {
            console.error('缺少项目ID，无法加载项目成员');
            return;
        }
        
        const assigneeSelect = document.getElementById('taskAssignee');
        if (!assigneeSelect) {
            console.error('未找到任务负责人选择器');
            return;
        }
        
        console.log(`加载项目 ${projectId} 的成员作为负责人候选...`);
        
        // 显示加载中状态
        assigneeSelect.innerHTML = '<option value="">加载中...</option>';
        assigneeSelect.disabled = true;
        
        // 构建多个可能的API端点
        const apiUrls = [
            `/api/projects/${projectId}/members?bypass_jwt=true`,
            `/api/auth/projects/${projectId}/members?bypass_jwt=true`,
            `/api/noauth/projects/${projectId}/members`
        ];
        
        // 尝试从多个API端点加载数据
        tryLoadProjectMembers(apiUrls, 0, assigneeSelect);
    }
    
    // 尝试从不同API端点加载项目成员
    function tryLoadProjectMembers(urls, index, assigneeSelect) {
        // 如果所有URL都尝试过了，尝试加载所有用户
        if (index >= urls.length) {
            console.warn('所有项目成员API端点都请求失败，尝试加载所有用户');
            loadAllUsersAsAssignees(assigneeSelect);
            return;
        }
        
        const url = urls[index];
        console.log(`[tryLoadProjectMembers] 尝试从 ${url} 加载项目成员`);
        
        fetch(url)
            .then(async response => {
                // 检查是否返回HTML而不是JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    console.warn(`[tryLoadProjectMembers] ${url} 返回了HTML而不是JSON`);
                    throw new Error('返回了HTML而不是JSON');
                }
                
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.status}`);
                }
                
                try {
                    const data = await response.json();
                    
                    // 检查成员数据格式
                    let members = [];
                    
                    if (Array.isArray(data)) {
                        members = data;
                    } else if (data.members && Array.isArray(data.members)) {
                        members = data.members;
                    } else if (data.data && Array.isArray(data.data)) {
                        members = data.data;
                    } else {
                        console.warn('[tryLoadProjectMembers] 无法识别返回的数据格式');
                        throw new Error('无法识别返回的数据格式');
                    }
                    
                    // 如果没有成员数据，尝试加载所有用户
                    if (members.length === 0) {
                        console.warn('[tryLoadProjectMembers] 没有成员数据，尝试加载所有用户');
                        loadAllUsersAsAssignees(assigneeSelect);
                        return;
                    }
                    
                    // 更新下拉框
                    updateAssigneeDropdown(assigneeSelect, members);
                    
                } catch (parseError) {
                    console.error(`[tryLoadProjectMembers] 解析 ${url} 响应出错:`, parseError);
                    throw parseError;
                }
            })
            .catch(error => {
                console.error(`[tryLoadProjectMembers] ${url} 请求失败:`, error);
                
                // 尝试下一个API端点
                setTimeout(() => tryLoadProjectMembers(urls, index + 1, assigneeSelect), 300);
            });
    }
    
    // 加载所有用户作为负责人候选
    function loadAllUsersAsAssignees(assigneeSelect) {
        // 构建多个可能的API端点
        const apiUrls = [
            `/api/users?bypass_jwt=true`,
            `/api/auth/users?bypass_jwt=true`,
            `/api/noauth/users`
        ];
        
        // 尝试从多个API端点加载数据
        tryLoadAllUsers(apiUrls, 0, assigneeSelect);
    }
    
    // 尝试从不同API端点加载所有用户
    function tryLoadAllUsers(urls, index, assigneeSelect) {
        // 如果所有URL都尝试过了，显示错误信息
        if (index >= urls.length) {
            console.error('所有用户API端点都请求失败');
            
            assigneeSelect.innerHTML = '<option value="">无法加载用户</option>';
            assigneeSelect.disabled = false;
            
            return;
        }
        
        const url = urls[index];
        console.log(`[tryLoadAllUsers] 尝试从 ${url} 加载所有用户`);
        
        fetch(url)
            .then(async response => {
                // 检查是否返回HTML而不是JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    console.warn(`[tryLoadAllUsers] ${url} 返回了HTML而不是JSON`);
                    throw new Error('返回了HTML而不是JSON');
                }
                
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.status}`);
                }
                
                try {
                    const data = await response.json();
                    
                    // 检查用户数据格式
                    let users = [];
                    
                    if (Array.isArray(data)) {
                        users = data;
                    } else if (data.users && Array.isArray(data.users)) {
                        users = data.users;
                    } else if (data.data && Array.isArray(data.data)) {
                        users = data.data;
                    } else {
                        console.warn('[tryLoadAllUsers] 无法识别返回的数据格式');
                        throw new Error('无法识别返回的数据格式');
                    }
                    
                    // 更新下拉框
                    updateAssigneeDropdown(assigneeSelect, users);
                    
                } catch (parseError) {
                    console.error(`[tryLoadAllUsers] 解析 ${url} 响应出错:`, parseError);
                    throw parseError;
                }
            })
            .catch(error => {
                console.error(`[tryLoadAllUsers] ${url} 请求失败:`, error);
                
                // 尝试下一个API端点
                setTimeout(() => tryLoadAllUsers(urls, index + 1, assigneeSelect), 300);
            });
    }
    
    // 更新负责人下拉框
    function updateAssigneeDropdown(assigneeSelect, users) {
        // 清空现有选项
        assigneeSelect.innerHTML = '';
        
        // 添加默认选项
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- 选择负责人 --';
        assigneeSelect.appendChild(defaultOption);
        
        // 添加用户选项
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name || user.username || `用户 #${user.id}`;
            assigneeSelect.appendChild(option);
        });
        
        // 启用选择器
        assigneeSelect.disabled = false;
        
        console.log(`已加载 ${users.length} 个用户作为负责人候选`);
    }
    
    // 保存任务处理函数
    function saveTaskHandler() {
        const taskForm = document.getElementById('taskForm');
        if (!taskForm) return;
        
        if (!taskForm.checkValidity()) {
            console.log('表单验证失败');
            taskForm.reportValidity();
            return;
        }
        
        // 获取保存按钮并显示加载状态
        const saveBtn = document.querySelector('#taskModal .btn-primary');
        if (saveBtn) {
            saveBtn.setAttribute('data-original-html', saveBtn.innerHTML);
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
            saveBtn.disabled = true;
            
            // 设置超时自动恢复按钮状态
            setTimeout(() => {
                if (saveBtn.disabled) {
                    saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                    saveBtn.disabled = false;
                    console.log('按钮状态自动恢复');
                }
            }, 5000);
        }
        
        // 收集表单数据
        const formData = new FormData(taskForm);
        const taskData = Object.fromEntries(formData.entries());
        
        console.log('提交任务数据:', taskData);
        
        // 构建多个可能的API端点
        const apiUrls = [
            '/api/tasks',
            '/api/auth/tasks',
            '/api/noauth/tasks'
        ];
        
        // 尝试从多个API端点保存数据
        trySaveTask(apiUrls, 0, taskData, saveBtn);
    }
    
    // 尝试向不同API端点保存任务
    function trySaveTask(urls, index, taskData, saveBtn) {
        // 如果所有URL都尝试过了，显示错误信息
        if (index >= urls.length) {
            console.error('所有任务保存API端点都请求失败');
            
            alert('保存任务失败，请刷新页面重试');
            
            // 恢复按钮状态
            if (saveBtn) {
                saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                saveBtn.disabled = false;
            }
            
            return;
        }
        
        const url = urls[index];
        console.log(`[trySaveTask] 尝试向 ${url} 保存任务`);
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(taskData)
        })
        .then(async response => {
            // 检查是否返回HTML而不是JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                console.warn(`[trySaveTask] ${url} 返回了HTML而不是JSON`);
                throw new Error('返回了HTML而不是JSON');
            }
            
            if (!response.ok) {
                throw new Error(`请求失败: ${response.status}`);
            }
            
            try {
                const data = await response.json();
                console.log('保存任务成功:', data);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                if (modal) modal.hide();
                
                // 恢复按钮状态
                if (saveBtn) {
                    saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                    saveBtn.disabled = false;
                }
                
                // 刷新页面或更新任务列表
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                
            } catch (parseError) {
                console.error(`[trySaveTask] 解析 ${url} 响应出错:`, parseError);
                throw parseError;
            }
        })
        .catch(error => {
            console.error(`[trySaveTask] ${url} 请求失败:`, error);
            
            // 尝试下一个API端点
            setTimeout(() => trySaveTask(urls, index + 1, taskData, saveBtn), 300);
        });
    }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 尝试使用多个API端点加载任务数据
    loadProjectTasks();
    
    // 尝试加载项目风险数据
    loadProjectRisks();
    
    // 自动重置所有按钮状态（避免卡在加载状态）
    setTimeout(resetAllButtonStates, 1000);
});

// 重置所有按钮状态
function resetAllButtonStates() {
    document.querySelectorAll('.btn').forEach(button => {
        if (button.getAttribute('data-original-html')) {
            button.innerHTML = button.getAttribute('data-original-html');
            button.disabled = false;
        }
        
        if (button.classList.contains('btn-loading')) {
            button.classList.remove('btn-loading');
            button.disabled = false;
        }
    });
    console.log('已重置所有按钮状态');
}

// 加载项目任务
function loadProjectTasks() {
    const projectId = {{ project.id }};
    const taskTableBody = document.getElementById('projectTasksTableBody');
    
    if (!taskTableBody) {
        console.warn('未找到任务表格容器');
        return;
    }
    
    // 显示加载中状态
    taskTableBody.innerHTML = `
        <tr class="task-loading">
            <td colspan="7" class="text-center">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                加载项目任务...
            </td>
        </tr>
    `;
    
    // 构建多个可能的API端点
    const apiUrls = [
        `/api/projects/${projectId}/tasks?bypass_jwt=true`,
        `/api/auth/projects/${projectId}/tasks?bypass_jwt=true`,
        `/api/noauth/projects/${projectId}/tasks`
    ];
    
    // 尝试从多个API端点加载数据
    tryLoadTasks(apiUrls, 0);
}

// 尝试从不同API端点加载任务数据
function tryLoadTasks(urls, index) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        const taskTableBody = document.getElementById('projectTasksTableBody');
        
        if (taskTableBody) {
            taskTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-exclamation-triangle"></i>
                        无法加载任务数据，请刷新页面重试
                    </td>
                </tr>
            `;
        }
        
        console.error('所有API端点都请求失败，无法加载任务数据');
        return;
    }
    
    const url = urls[index];
    console.log(`[tryLoadTasks] 尝试从 ${url} 加载任务数据`);
    
    fetch(url)
        .then(async response => {
            // 检查是否返回HTML而不是JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                console.warn(`[tryLoadTasks] ${url} 返回了HTML而不是JSON`);
                throw new Error('返回了HTML而不是JSON');
            }
            
            if (!response.ok) {
                throw new Error(`请求失败: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('[tryLoadTasks] 获取到任务数据:', data);
            
            // 检查任务数据格式
            let tasks = [];
            
            if (Array.isArray(data)) {
                tasks = data;
            } else if (data.tasks && Array.isArray(data.tasks)) {
                tasks = data.tasks;
            } else if (data.data && Array.isArray(data.data)) {
                tasks = data.data;
            } else {
                console.warn('[tryLoadTasks] 无法识别返回的数据格式');
                throw new Error('无法识别返回的数据格式');
            }
            
            // 更新任务表格
            updateTaskTable(tasks);
        })
        .catch(error => {
            console.error(`[tryLoadTasks] ${url} 请求失败:`, error);
            
            // 尝试下一个API端点
            setTimeout(() => tryLoadTasks(urls, index + 1), 300);
        });
}

// 更新任务表格
function updateTaskTable(tasks) {
    const taskTableBody = document.getElementById('projectTasksTableBody');
    
    if (!taskTableBody) {
        console.warn('未找到任务表格容器');
        return;
    }
    
    if (!tasks || tasks.length === 0) {
        taskTableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    暂无任务
                </td>
            </tr>
        `;
        return;
    }
    
    taskTableBody.innerHTML = '';
    
    tasks.forEach(task => {
        const taskRow = renderTaskRow(task);
        taskTableBody.innerHTML += taskRow;
    });
    
    // 添加事件监听器
    attachTaskButtonListeners();
}

// 加载项目风险
function loadProjectRisks() {
    const projectId = {{ project.id }};
    const riskList = document.getElementById('riskList');
    
    if (!riskList) {
        console.warn('未找到风险列表容器');
        return;
    }
    
    // 如果风险列表已经有内容（从服务器端渲染），则不加载
    if (riskList.children.length > 0) {
        console.log('风险列表已有内容，无需重新加载');
        return;
    }
    
    // 显示加载中状态
    riskList.innerHTML = `
        <tr class="risk-loading">
            <td colspan="7" class="text-center">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                加载项目风险...
            </td>
        </tr>
    `;
    
    // 构建多个可能的API端点
    const apiUrls = [
        `/api/projects/${projectId}/risks?bypass_jwt=true`,
        `/api/auth/projects/${projectId}/risks?bypass_jwt=true`,
        `/api/noauth/projects/${projectId}/risks`,
        `/api/risks?project_id=${projectId}&bypass_jwt=true`
    ];
    
    // 尝试从多个API端点加载数据
    tryLoadRisks(apiUrls, 0);
}

// 尝试从不同API端点加载风险数据
function tryLoadRisks(urls, index) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        const riskList = document.getElementById('riskList');
        
        if (riskList) {
            riskList.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-exclamation-triangle"></i>
                        无法加载风险数据，请刷新页面重试
                    </td>
                </tr>
            `;
        }
        
        console.error('所有API端点都请求失败，无法加载风险数据');
        return;
    }
    
    const url = urls[index];
    console.log(`[tryLoadRisks] 尝试从 ${url} 加载风险数据`);
    
    fetch(url)
        .then(async response => {
            // 检查是否返回HTML而不是JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                console.warn(`[tryLoadRisks] ${url} 返回了HTML而不是JSON`);
                throw new Error('返回了HTML而不是JSON');
            }
            
            if (!response.ok) {
                throw new Error(`请求失败: ${response.status}`);
            }
            
            try {
                const data = await response.json();
                
                // 检查风险数据格式
                let risks = [];
                
                if (Array.isArray(data)) {
                    risks = data;
                } else if (data.risks && Array.isArray(data.risks)) {
                    risks = data.risks;
                } else if (data.data && Array.isArray(data.data)) {
                    risks = data.data;
                } else {
                    console.warn('[tryLoadRisks] 无法识别返回的数据格式');
                    throw new Error('无法识别返回的数据格式');
                }
                
                // 更新风险表格
                updateRiskTable(risks);
                
            } catch (parseError) {
                console.error(`[tryLoadRisks] 解析 ${url} 响应出错:`, parseError);
                throw parseError;
            }
        })
        .catch(error => {
            console.error(`[tryLoadRisks] ${url} 请求失败:`, error);
            
            // 尝试下一个API端点
            setTimeout(() => tryLoadRisks(urls, index + 1), 300);
        });
}

// 更新风险表格
function updateRiskTable(risks) {
    const riskList = document.getElementById('riskList');
    
    if (!riskList) {
        console.warn('未找到风险列表容器');
        return;
    }
    
    if (!risks || risks.length === 0) {
        riskList.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    该项目暂无风险记录
                </td>
            </tr>
        `;
        return;
    }
    
    riskList.innerHTML = '';
    
    // 获取当前用户是否有编辑权限
    const userCanEdit = {% if not user_is_regular(current_user) %}true{% else %}false{% endif %};
    
    risks.forEach(risk => {
        // 格式化风险等级
        let levelClass = 'bg-info';
        if (risk.level === 'high' || risk.severity === 'high') {
            levelClass = 'bg-danger';
        } else if (risk.level === 'medium' || risk.severity === 'medium') {
            levelClass = 'bg-warning';
        }
        
        const riskRow = `
            <tr data-risk-id="${risk.id}">
                <td>${risk.name || risk.title || '未命名风险'}</td>
                <td>${risk.description || risk.desc || '无描述'}</td>
                <td>
                    <span class="badge ${levelClass}">
                        ${risk.level || risk.severity || 'medium'}
                    </span>
                </td>
                <td>${risk.probability || '中'}</td>
                <td>${risk.impact || '中'}</td>
                <td>${risk.control_measures || risk.mitigation_plan || '无'}</td>
                <td class="text-end">
                    <div class="risk-operations">
                        ${userCanEdit ? `
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-action="edit" data-risk-id="${risk.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-action="delete" data-risk-id="${risk.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
        
        riskList.innerHTML += riskRow;
    });
    
    // 添加风险按钮事件监听器
    attachRiskButtonListeners();
}

// 添加风险按钮事件监听器
function attachRiskButtonListeners() {
    // 为编辑风险按钮添加事件监听器
    document.querySelectorAll('.edit-btn[data-action="edit"]').forEach(button => {
        button.addEventListener('click', function() {
            const riskId = this.getAttribute('data-risk-id');
            editRisk(riskId);
        });
    });
    
    // 为删除风险按钮添加事件监听器
    document.querySelectorAll('.delete-btn[data-action="delete"]').forEach(button => {
        button.addEventListener('click', function() {
            const riskId = this.getAttribute('data-risk-id');
            deleteRisk(riskId);
        });
    });
    
    // 为添加风险按钮添加事件监听器
    const addRiskBtn = document.getElementById('addRiskBtn');
    if (addRiskBtn) {
        addRiskBtn.addEventListener('click', function() {
            showAddRiskModal();
        });
    }
}

// 添加任务按钮事件监听器
function attachTaskButtonListeners() {
    // 为任务操作按钮添加事件监听器
    document.querySelectorAll('.edit-task-btn').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            editTask(taskId);
        });
    });
    
    document.querySelectorAll('.delete-task-btn').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            deleteTask(taskId);
        });
    });
    
    // 为添加任务按钮添加事件监听器
    const addTaskBtn = document.getElementById('addTaskBtn');
    if (addTaskBtn) {
        addTaskBtn.addEventListener('click', function() {
            showAddTaskModal();
        });
    }
}

// 使用JavaScript生成任务行并添加权限控制
function renderTaskRow(task) {
    // 创建一个变量接收模板变量值
    const userCanEdit = {% if not user_is_regular(current_user) %}true{% else %}false{% endif %};
    
    return `
        <tr data-task-id="${task.id}">
            <td>${task.title}</td>
            <td>${task.status_display || task.status}</td>
            <td>
                <span class="badge ${task.priority === 'high' ? 'bg-danger' : task.priority === 'medium' ? 'bg-warning' : 'bg-info'}">
                    ${task.priority}
                </span>
            </td>
            <td>${task.assignee_name || '未分配'}</td>
            <td>${task.due_date || '-'}</td>
            <td>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" style="width: ${task.progress || 0}%"></div>
                </div>
                <small class="text-muted">${task.progress || 0}%</small>
            </td>
            <td class="text-center">
                <div class="btn-group btn-group-sm">
                    <a href="/tasks/${task.id}/view?bypass_jwt=true" class="btn btn-outline-primary">
                        <i class="bi bi-eye"></i>
                    </a>
                    ${userCanEdit ? `
                    <button type="button" class="btn btn-outline-secondary edit-task-btn" data-task-id="${task.id}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger delete-task-btn" data-task-id="${task.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `;
}

// 删除风险
function deleteRisk(riskId) {
    if (!confirm('确定要删除此风险吗？')) {
        return;
    }
    
    // 构建多个可能的API端点，优先使用紧急删除端点
    const apiUrls = [
        `/api/risks/${riskId}/emergency_delete`,
        `/api/auth/risks/${riskId}`,
        `/api/risks/${riskId}`,
        `/api/noauth/risks/${riskId}`
    ];
    
    // 尝试从多个API端点删除数据
    tryDeleteRisk(apiUrls, 0, riskId);
}

// 尝试向不同API端点删除风险
function tryDeleteRisk(urls, index, riskId) {
    // 如果所有URL都尝试过了，显示错误信息
    if (index >= urls.length) {
        console.error('所有风险删除API端点都请求失败');
        alert('删除风险失败，请刷新页面重试');
        return;
    }
    
    const url = urls[index];
    console.log(`[tryDeleteRisk] 尝试向 ${url} 删除风险`);
    
    fetch(url, {
        method: 'DELETE',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryDeleteRisk] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            console.log('删除风险成功:', data);
            
            // 移除对应的行
            const row = document.querySelector(`tr[data-risk-id="${riskId}"]`);
            if (row) {
                row.remove();
            } else {
                // 找不到行，刷新页面
                loadProjectRisks();
            }
            
            // 显示成功消息
            alert('风险删除成功');
            
        } catch (parseError) {
            console.error(`[tryDeleteRisk] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryDeleteRisk] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryDeleteRisk(urls, index + 1, riskId), 300);
    });
}
</script>
{% endblock %} 