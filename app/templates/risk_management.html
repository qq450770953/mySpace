{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
<style>
    .risk-card {
        background: white;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .risk-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .risk-title {
        font-weight: bold;
        font-size: 1.1rem;
    }
    .risk-level {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        font-weight: bold;
    }
    .risk-level.critical {
        background-color: #ffebee;
        color: #c62828;
    }
    .risk-level.high {
        background-color: #fff3e0;
        color: #ef6c00;
    }
    .risk-level.medium {
        background-color: #fff8e1;
        color: #ff8f00;
    }
    .risk-level.low {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    .risk-details {
        margin: 1rem 0;
    }
    .risk-property {
        display: flex;
        margin-bottom: 0.5rem;
    }
    .risk-property-label {
        width: 100px;
        font-weight: bold;
        color: #6c757d;
    }
    .risk-property-value {
        flex: 1;
    }
    .risk-matrix {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        margin: 1rem 0;
    }
    .risk-matrix-cell {
        padding: 0.5rem;
        text-align: center;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    .risk-matrix-cell.active {
        background-color: #e9ecef;
    }
    .risk-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .risk-chart {
        height: 300px;
        margin: 1rem 0;
    }
    .risk-timeline {
        margin: 1rem 0;
    }
    .timeline-item {
        display: flex;
        margin-bottom: 1rem;
    }
    .timeline-date {
        width: 150px;
        color: #6c757d;
    }
    .timeline-content {
        flex: 1;
        padding-left: 1rem;
        border-left: 2px solid #dee2e6;
    }
    .risk-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .risk-statistics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .stat-card {
        background: white;
        border-radius: 0.25rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-title {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">风险列表</h5>
                    {% if current_user.is_authenticated and not user_is_regular(current_user) %}
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addRiskModal">
                        <i class="bi bi-plus-circle"></i> 添加风险
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <!-- 风险统计 -->
                    <div class="risk-statistics" id="riskStatistics">
                        <div class="stat-card">
                            <div class="stat-title">总风险数</div>
                            <div class="stat-value" id="totalRisks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">严重风险</div>
                            <div class="stat-value" id="criticalRisks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">高风险</div>
                            <div class="stat-value" id="highRisks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">中风险</div>
                            <div class="stat-value" id="mediumRisks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">低风险</div>
                            <div class="stat-value" id="lowRisks">0</div>
                        </div>
                    </div>
                    
                    <!-- 风险筛选 -->
                    <div class="risk-filters">
                        <select class="form-select" id="filterProject" onchange="applyFilters()">
                            <option value="">所有项目</option>
                        </select>
                        <select class="form-select" id="filterLevel" onchange="applyFilters()">
                            <option value="">所有等级</option>
                            <option value="critical">严重</option>
                            <option value="high">高</option>
                            <option value="medium">中</option>
                            <option value="low">低</option>
                        </select>
                        <select class="form-select" id="filterStatus" onchange="applyFilters()">
                            <option value="">所有状态</option>
                            <option value="active">活跃</option>
                            <option value="mitigated">已缓解</option>
                            <option value="closed">已关闭</option>
                        </select>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> 清除筛选
                        </button>
                    </div>
                    
                    <!-- 风险列表 -->
                    <div id="riskList">
                        <!-- 风险卡片将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加风险模态框 -->
<div class="modal fade" id="addRiskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加风险</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRiskForm">
                    <div class="mb-3">
                        <label class="form-label">任务</label>
                        <select class="form-select" id="riskTask" required>
                            <option value="">选择任务</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">风险标题</label>
                        <input type="text" class="form-control" id="riskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">风险描述</label>
                        <textarea class="form-control" id="riskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">发生概率 (1-5)</label>
                        <input type="number" class="form-control" id="riskProbability" min="1" max="5" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">影响程度 (1-5)</label>
                        <input type="number" class="form-control" id="riskImpact" min="1" max="5" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">缓解计划</label>
                        <textarea class="form-control" id="riskMitigationPlan" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addRisk()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑风险模态框 -->
<div class="modal fade" id="editRiskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑风险</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeEditRiskModal()"></button>
            </div>
            <div class="modal-body">
                <form id="editRiskForm">
                    <input type="hidden" id="editRiskId">
                    <div class="mb-3">
                        <label class="form-label">任务</label>
                        <select class="form-select" id="editRiskTask" required>
                            <option value="">选择任务</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">风险标题</label>
                        <input type="text" class="form-control" id="editRiskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">风险描述</label>
                        <textarea class="form-control" id="editRiskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">发生概率 (1-5)</label>
                        <input type="number" class="form-control" id="editRiskProbability" min="1" max="5" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">影响程度 (1-5)</label>
                        <input type="number" class="form-control" id="editRiskImpact" min="1" max="5" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">缓解计划</label>
                        <textarea class="form-control" id="editRiskMitigationPlan" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeEditRiskModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateRisk()">保存更改</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="D:\work\app\static\js\chart.js"></script>
<script>
// 页面加载时初始化
document.addEventListener('DOMContentLoaded', () => {
    // 初始化风险管理
    initRiskManagement();
    
    // 初始化按钮事件监听
    initializeEventListeners();
    
    // 自动重置所有按钮状态（避免卡在加载状态）
    setTimeout(resetAllButtonStates, 1000);
    
    // 预加载项目数据
    preloadProjectsData();
});

// 初始化按钮事件监听器
function initializeEventListeners() {
    console.log("[initializeEventListeners] 初始化事件监听器");
    
    // 添加风险按钮
    const addRiskBtn = document.querySelector('[data-bs-target="#addRiskModal"]');
    if (addRiskBtn) {
        addRiskBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showAddRiskModal();
        });
    }
    
    // 取消按钮（关闭模态框）
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            // 根据按钮所在的模态框确定要关闭哪个
            const modal = this.closest('.modal');
            if (modal) {
                const modalId = modal.id;
                if (modalId === 'editRiskModal') {
                    closeEditRiskModal();
                } else if (modalId === 'addRiskModal') {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) modalInstance.hide();
                }
            }
        });
    });
    
    // 添加风险提交按钮
    const addRiskSubmitBtn = document.querySelector('#addRiskModal .btn-primary');
    if (addRiskSubmitBtn) {
        addRiskSubmitBtn.addEventListener('click', addRisk);
    }
    
    // 编辑风险提交按钮
    const editRiskSubmitBtn = document.querySelector('#editRiskModal .btn-primary');
    if (editRiskSubmitBtn) {
        editRiskSubmitBtn.addEventListener('click', updateRisk);
    }
    
    // 筛选器变更事件
    document.querySelectorAll('#filterProject, #filterLevel, #filterStatus').forEach(filter => {
        filter.addEventListener('change', applyFilters);
    });
    
    // 清除筛选按钮
    const clearFilterBtn = document.querySelector('button[onclick="clearFilters()"]');
    if (clearFilterBtn) {
        clearFilterBtn.removeAttribute('onclick');
        clearFilterBtn.addEventListener('click', clearFilters);
    }
}

// 重置所有按钮状态
function resetAllButtonStates() {
    document.querySelectorAll('.btn').forEach(button => {
        if (button.getAttribute('data-original-html')) {
            button.innerHTML = button.getAttribute('data-original-html');
            button.disabled = false;
        }
        
        if (button.classList.contains('btn-loading')) {
            button.classList.remove('btn-loading');
            button.disabled = false;
        }
    });
    console.log('已重置所有按钮状态');
}

// 初始化风险管理
function initRiskManagement() {
    console.log('[initRiskManagement] 初始化风险管理系统');
    
    try {
        // 添加静态数据模式切换按钮
        addStaticDataToggleButton();
        
        // 检查URL参数是否指定使用静态数据
        const useStaticData = getUrlParam('static') === 'true';
        
        if (useStaticData) {
            console.log('[initRiskManagement] 使用静态数据模式');
            
            // 使用静态数据初始化
            useStaticProjectData(document.getElementById('filterProject'));
            useStaticRiskData();
            
            showMessage('正在使用静态数据模式，可以点击右上角按钮切换', 'info');
        } else {
            // 正常加载数据
            loadProjects();
            loadRisks();
        }
    } catch (error) {
        console.error('[initRiskManagement] 初始化错误:', error);
        showMessage('初始化失败，已切换到静态数据模式', 'warning');
        
        // 出错时强制使用静态数据
        useStaticProjectData(document.getElementById('filterProject'));
        useStaticRiskData();
    }
}

// 获取URL参数
function getUrlParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// 添加静态数据模式切换按钮
function addStaticDataToggleButton() {
    // 检查是否已经存在
    if (document.getElementById('staticDataBtn')) {
        return;
    }
    
    // 获取标题行
    const header = document.querySelector('.card-header');
    if (!header) {
        console.error('[addStaticDataToggleButton] 未找到卡片标题区域');
        return;
    }
    
    // 创建按钮
    const btn = document.createElement('button');
    btn.id = 'staticDataBtn';
    btn.className = 'btn btn-sm btn-outline-info ms-2';
    btn.innerHTML = '<i class="fas fa-database"></i> 静态数据';
    
    // 根据当前模式设置按钮状态
    const isStatic = getUrlParam('static') === 'true';
    if (isStatic) {
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-info');
        btn.innerHTML = '<i class="fas fa-database"></i> 使用API数据';
    }
    
    // 添加点击事件
    btn.addEventListener('click', toggleStaticDataMode);
    
    // 插入到DOM
    header.appendChild(btn);
}

// 切换静态数据模式
function toggleStaticDataMode() {
    // 获取当前模式
    const isStatic = getUrlParam('static') === 'true';
    
    // 构建新URL
    const url = new URL(window.location.href);
    if (isStatic) {
        url.searchParams.delete('static');
    } else {
        url.searchParams.set('static', 'true');
    }
    
    // 跳转
    window.location.href = url.toString();
}

// 加载项目数据
function loadProjects() {
    const projectSelect = document.getElementById('filterProject');
    if (!projectSelect) {
        console.error('未找到项目选择器');
        return;
    }
    
    // 显示加载中状态
    projectSelect.innerHTML = '<option value="">加载中...</option>';
    projectSelect.disabled = true;
    
    // 使用统一的项目加载函数
    fetchAllProjects()
        .then(projects => {
            updateProjectDropdown(projectSelect, projects);
        })
        .catch(error => {
            console.error('[loadProjects] 加载项目失败:', error);
            useStaticProjectData(projectSelect);
        });
}

// 尝试从不同API端点加载项目数据
function tryLoadProjects(urls, index, projectSelect) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        console.error('所有项目API端点都请求失败，尝试提取页面上的风险数据中的项目信息');
        
        // 尝试从风险数据中提取项目信息
        extractProjectsFromRisks(projectSelect);
        return;
    }
    
    const url = urls[index];
    console.log(`[tryLoadProjects] 尝试从 ${url} 加载项目数据`);
    
    // 尝试使用多种token来源
    const token = localStorage.getItem('access_token') || 
                  localStorage.getItem('token') || 
                  sessionStorage.getItem('token') || 
                  '';
    
    fetch(url, {
        method: 'GET', // 明确使用GET请求
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryLoadProjects] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // 检查项目数据格式
            let projects = [];
            
            if (Array.isArray(data)) {
                projects = data;
            } else if (data.projects && Array.isArray(data.projects)) {
                projects = data.projects;
            } else if (data.data && Array.isArray(data.data)) {
                projects = data.data;
            } else if (data.results && Array.isArray(data.results)) {
                projects = data.results;
            } else if (data.items && Array.isArray(data.items)) {
                projects = data.items;
            } else {
                console.warn('[tryLoadProjects] 无法识别返回的数据格式');
                throw new Error('无法识别返回的数据格式');
            }
            
            // 更新项目下拉框
            updateProjectDropdown(projectSelect, projects);
            
        } catch (parseError) {
            console.error(`[tryLoadProjects] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryLoadProjects] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryLoadProjects(urls, index + 1, projectSelect), 300);
    });
}

// 添加一个帮助函数来获取所有项目
function fetchAllProjects() {
    return new Promise((resolve, reject) => {
        // 尝试使用缓存的项目数据
        try {
            const savedProjects = localStorage.getItem('projects');
            if (savedProjects) {
                const parsedProjects = JSON.parse(savedProjects);
                if (Array.isArray(parsedProjects) && parsedProjects.length > 0) {
                    console.log('[fetchAllProjects] 使用缓存的项目数据');
                    return resolve(parsedProjects);
                }
            }
        } catch (e) {
            console.error('[fetchAllProjects] 解析缓存项目数据失败:', e);
        }
        
        // 构建多个可能的API端点
        const apiUrls = [
            '/api/projects',
            '/api/auth/projects',
            '/api/noauth/projects',
            '/api/v1/projects',
            '/projects/list'
        ];
        
        // 尝试从多个API端点加载数据
        tryFetchProjects(apiUrls, 0, resolve, reject);
    });
}

// 帮助函数 - 尝试从不同API端点加载项目数据
function tryFetchProjects(urls, index, resolve, reject) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        console.error('[tryFetchProjects] 所有项目API端点都请求失败');
        
        // 提供默认项目作为后备
        return resolve(addDefaultProjects([]));
    }
    
    const url = urls[index];
    console.log(`[tryFetchProjects] 尝试从 ${url} 加载项目数据`);
    
    // 尝试使用多种token来源
    const token = localStorage.getItem('access_token') || 
                  localStorage.getItem('token') || 
                  sessionStorage.getItem('token') || 
                  '';
    
    // 尝试获取CSRF令牌
    const csrf_token = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    fetch(url, {
        method: 'GET', // 明确使用GET请求
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf_token
        },
        credentials: 'same-origin'  // 发送cookie和认证信息
    })
    .then(async response => {
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            // 检查项目数据格式
            let projects = [];
            
            if (Array.isArray(data)) {
                projects = data;
            } else if (data.projects && Array.isArray(data.projects)) {
                projects = data.projects;
            } else if (data.data && Array.isArray(data.data)) {
                projects = data.data;
            } else if (data.results && Array.isArray(data.results)) {
                projects = data.results;
            } else if (data.items && Array.isArray(data.items)) {
                projects = data.items;
            } else {
                console.warn('[tryFetchProjects] 无法识别返回的数据格式');
                throw new Error('无法识别返回的数据格式');
            }
            
            // 保存到localStorage供将来使用
            try {
                localStorage.setItem('projects', JSON.stringify(projects));
            } catch (e) {
                console.error('[tryFetchProjects] 保存项目数据到本地存储失败:', e);
            }
            
            resolve(projects);
            
        } catch (parseError) {
            console.error(`[tryFetchProjects] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryFetchProjects] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryFetchProjects(urls, index + 1, resolve, reject), 300);
    });
}

// 添加默认项目（在API调用失败时使用）
function addDefaultProjects(projects) {
    // 如果已经有项目，不添加默认项目
    if (projects.length > 0) {
        return projects;
    }
    
    console.log('[addDefaultProjects] 添加默认项目');
    
    // 常见的示例项目数据
    const defaultProjects = [
        { id: '1', name: '财务系统重构项目' },
        { id: '2', name: '移动应用开发项目' },
        { id: '3', name: '数据中心搬迁项目' },
        { id: '4', name: '网站优化项目' },
        { id: '5', name: 'ERP系统升级项目' }
    ];
    
    return defaultProjects;
}

// 从页面上的风险数据中提取项目信息
function extractProjectsFromRisks(projectSelect) {
    console.log('[extractProjectsFromRisks] 尝试从风险数据中提取项目信息');
    
    // 尝试先从API获取所有项目
    fetchAllProjects()
        .then(projects => {
            if (projects.length > 0) {
                console.log('[extractProjectsFromRisks] 成功从API获取项目');
                updateProjectDropdown(projectSelect, projects);
                return;
            }
            
            // 如果API没有返回项目，尝试从DOM提取
            extractProjectsFromDOM(projectSelect);
        })
        .catch(() => {
            // 如果API调用失败，尝试从DOM提取
            extractProjectsFromDOM(projectSelect);
        });
}

// 从DOM中提取项目信息
function extractProjectsFromDOM(projectSelect) {
    // 尝试获取风险卡片
    const riskCards = document.querySelectorAll('.risk-card');
    if (riskCards.length === 0) {
        console.warn('[extractProjectsFromDOM] 页面上没有风险卡片，无法提取项目信息');
        useStaticProjectData(projectSelect);
        return;
    }
    
    // 尝试从DOM中的data属性获取项目信息
    const projectsMap = new Map();
    
    riskCards.forEach(card => {
        const projectId = card.getAttribute('data-project-id');
        const projectName = card.getAttribute('data-project-name');
        
        if (projectId && projectName) {
            projectsMap.set(projectId, { id: projectId, name: projectName });
        }
    });
    
    if (projectsMap.size === 0) {
        console.warn('[extractProjectsFromDOM] 无法从风险卡片中提取项目信息');
        useStaticProjectData(projectSelect);
        return;
    }
    
    // 将Map转换为数组
    const projects = Array.from(projectsMap.values());
    updateProjectDropdown(projectSelect, projects);
}

// 使用静态项目数据作为最终回退
function useStaticProjectData(projectSelect) {
    console.log('[useStaticProjectData] 使用静态项目数据');
    
    // 常见的示例项目数据
    const staticProjects = [
        { id: '1', name: '财务系统重构项目' },
        { id: '2', name: '移动应用开发项目' },
        { id: '3', name: '数据中心搬迁项目' },
        { id: '4', name: '网站优化项目' },
        { id: '5', name: 'ERP系统升级项目' }
    ];
    
    // 尝试从localStorage中获取项目数据
    try {
        const savedProjects = localStorage.getItem('projects');
        if (savedProjects) {
            const parsedProjects = JSON.parse(savedProjects);
            if (Array.isArray(parsedProjects) && parsedProjects.length > 0) {
                console.log('[useStaticProjectData] 使用本地存储的项目数据');
                updateProjectDropdown(projectSelect, parsedProjects);
                return;
            }
        }
    } catch (e) {
        console.error('[useStaticProjectData] 解析本地存储的项目数据出错:', e);
    }
    
    // 使用静态数据
    updateProjectDropdown(projectSelect, staticProjects);
    
    // 显示消息提示用户使用了静态数据
    showMessage('使用了静态项目数据，部分功能可能受限', 'warning');
}

// 更新项目下拉框
function updateProjectDropdown(projectSelect, projects) {
    // 清空现有选项
    projectSelect.innerHTML = '';
    
    // 添加默认选项
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '所有项目';
    projectSelect.appendChild(defaultOption);
    
    // 添加项目选项
    projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name || project.title || `项目 #${project.id}`;
        projectSelect.appendChild(option);
    });
    
    // 启用选择器
    projectSelect.disabled = false;
    
    console.log(`已加载 ${projects.length} 个项目`);
    
    // 尝试保存到localStorage供将来使用
    try {
        localStorage.setItem('projects', JSON.stringify(projects));
    } catch (e) {
        console.error('[updateProjectDropdown] 保存项目数据到本地存储失败:', e);
    }
}

// 加载风险数据
function loadRisks() {
    const projectId = document.getElementById('filterProject')?.value || '';
    const level = document.getElementById('filterLevel')?.value || '';
    const status = document.getElementById('filterStatus')?.value || '';
    
    // 构建查询参数
    const params = new URLSearchParams();
    if (projectId) params.append('project_id', projectId);
    if (level) params.append('level', level);
    if (status) params.append('status', status);
    
    const paramsStr = params.toString();
    const baseUrls = [
        '/api/auth/risks',
        '/api/risks',
        '/api/noauth/risks',
        '/api/v1/risks',
        '/risks/list'
    ];
    
    // 构建包含查询参数的URL
    const apiUrls = baseUrls.map(url => {
        return paramsStr ? `${url}?${paramsStr}` : url;
    });
    
    // 尝试从多个API端点加载数据
    tryLoadRisks(apiUrls, 0);
}

// 尝试从不同API端点加载风险数据
function tryLoadRisks(urls, index) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        console.error('所有风险API端点都请求失败，尝试使用静态数据');
        
        // 使用静态数据作为最终回退
        useStaticRiskData();
        return;
    }
    
    const url = urls[index];
    console.log(`[tryLoadRisks] 尝试从 ${url} 加载风险数据`);
    
    // 尝试使用多种token来源
    const token = localStorage.getItem('access_token') || 
                  localStorage.getItem('token') || 
                  sessionStorage.getItem('token') || 
                  '';
    
    // 尝试获取CSRF令牌
    const csrf_token = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    fetch(url, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf_token
        },
        credentials: 'same-origin'  // 发送cookie和认证信息
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryLoadRisks] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // 检查风险数据格式
            let risks = [];
            
            if (Array.isArray(data)) {
                risks = data;
            } else if (data.risks && Array.isArray(data.risks)) {
                risks = data.risks;
            } else if (data.data && Array.isArray(data.data)) {
                risks = data.data;
            } else if (data.results && Array.isArray(data.results)) {
                risks = data.results;
            } else if (data.items && Array.isArray(data.items)) {
                risks = data.items;
            } else {
                console.warn('[tryLoadRisks] 无法识别返回的数据格式');
                throw new Error('无法识别返回的数据格式');
            }
            
            // 保存到localStorage供将来使用
            try {
                localStorage.setItem('risks', JSON.stringify(risks));
            } catch (e) {
                console.error('[tryLoadRisks] 保存风险数据到本地存储失败:', e);
            }
            
            updateRiskList(risks);
            updateRiskStatistics(risks);
            
        } catch (parseError) {
            console.error(`[tryLoadRisks] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryLoadRisks] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryLoadRisks(urls, index + 1), 300);
    });
}

// 使用静态风险数据作为最终回退
function useStaticRiskData() {
    console.log('[useStaticRiskData] 尝试使用本地存储的风险数据');
    
    // 尝试从localStorage中获取风险数据
    try {
        const savedRisks = localStorage.getItem('risks');
        if (savedRisks) {
            const parsedRisks = JSON.parse(savedRisks);
            if (Array.isArray(parsedRisks) && parsedRisks.length > 0) {
                console.log('[useStaticRiskData] 使用本地存储的风险数据');
                updateRiskList(parsedRisks);
                updateRiskStatistics(parsedRisks);
                showMessage('使用缓存的风险数据', 'warning');
                return;
            }
        }
    } catch (e) {
        console.error('[useStaticRiskData] 解析本地存储的风险数据出错:', e);
    }
    
    console.log('[useStaticRiskData] 生成示例风险数据');
    
    // 常见的示例风险数据
    const staticRisks = [
        {
            id: '1',
            title: '服务器宕机风险',
            description: '主要服务器可能因过载而宕机',
            probability: '4',
            impact: '5',
            status: '活跃',
            mitigation_plan: '增加备份服务器并实施负载均衡'
        },
        {
            id: '2',
            title: '数据泄露风险',
            description: '用户敏感数据可能被未授权访问',
            probability: '3',
            impact: '5',
            status: '活跃',
            mitigation_plan: '加强数据加密和访问控制'
        },
        {
            id: '3',
            title: '项目延期风险',
            description: '关键模块开发可能延期',
            probability: '4',
            impact: '3',
            status: '活跃',
            mitigation_plan: '增加开发资源并优化工作流程'
        },
        {
            id: '4',
            title: '预算超支风险',
            description: '项目实施成本可能超出预算',
            probability: '3',
            impact: '4',
            status: '活跃',
            mitigation_plan: '定期审核预算执行情况并调整资源分配'
        },
        {
            id: '5',
            title: '技术兼容性风险',
            description: '新系统与现有系统集成可能存在兼容性问题',
            probability: '3',
            impact: '3',
            status: '活跃',
            mitigation_plan: '提前进行兼容性测试并准备适配方案'
        }
    ];
    
    // 应用筛选
    const projectId = document.getElementById('filterProject')?.value || '';
    const level = document.getElementById('filterLevel')?.value || '';
    const status = document.getElementById('filterStatus')?.value || '';
    
    // 筛选数据（仅示例，实际筛选逻辑会更复杂）
    let filteredRisks = staticRisks;
    
    // 显示风险列表和统计
    updateRiskList(filteredRisks);
    updateRiskStatistics(filteredRisks);
    
    // 显示消息
    showMessage('使用了示例风险数据，实际数据加载失败', 'danger');
}

// 更新风险列表显示
function updateRiskList(risks) {
    const riskList = document.getElementById('riskList');
    if (!riskList) {
        console.error('未找到风险列表容器');
        return;
    }
    
    riskList.innerHTML = '';
    
    if (!risks || risks.length === 0) {
        riskList.innerHTML = '<div class="alert alert-info">暂无风险记录</div>';
        return;
    }
    
    risks.forEach(risk => {
        const card = createRiskCard(risk);
        riskList.appendChild(card);
    });
    
    // 在后台异步获取详细风险信息
    setTimeout(() => fetchDetailedRiskInfo(risks), 500);
}

// 在后台异步获取详细风险信息
function fetchDetailedRiskInfo(risks) {
    console.log('[fetchDetailedRiskInfo] 开始异步获取详细风险信息');
    
    risks.forEach(risk => {
        if (!risk.id) return;
        
        const baseUrls = [
            `/api/risks/${risk.id}/emergency_delete`,
            `/api/auth/risks/${risk.id}`,
            `/api/risks/${risk.id}`,
            `/api/noauth/risks/${risk.id}`
        ];
        
        // 尝试从不同API端点获取详细信息
        tryFetchRiskDetail(baseUrls, 0, risk.id, risk);
    });
}

// 尝试从不同API端点获取风险详情
function tryFetchRiskDetail(urls, index, riskId, fallbackRiskData) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        console.error(`[tryFetchRiskDetail] 所有风险详情API端点都请求失败: ${riskId}`);
        
        // 使用原始风险数据作为回退方案更新卡片
        if (fallbackRiskData) {
            console.log(`[tryFetchRiskDetail] 使用初始风险数据作为回退: ${riskId}`);
            updateRiskCardWithDetails(riskId, fallbackRiskData);
        }
        return;
    }
    
    const url = urls[index];
    
    // 尝试使用多种token来源
    const token = localStorage.getItem('access_token') || 
                  localStorage.getItem('token') || 
                  sessionStorage.getItem('token') || 
                  '';
    
    // 尝试获取CSRF令牌
    const csrf_token = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    fetch(url, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf_token
        },
        credentials: 'same-origin'  // 发送cookie和认证信息
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryFetchRiskDetail] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            
            // 更新UI上的风险卡片
            updateRiskCardWithDetails(riskId, data);
            
        } catch (parseError) {
            console.error(`[tryFetchRiskDetail] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryFetchRiskDetail] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryFetchRiskDetail(urls, index + 1, riskId, fallbackRiskData), 300);
    });
}

// 更新风险卡片详情
function updateRiskCardWithDetails(riskId, detailData) {
    const card = document.querySelector(`.risk-card[data-risk-id="${riskId}"]`);
    if (!card) return;
    
    // 更新风险描述
    if (detailData.description) {
        const descElement = card.querySelector('.risk-property-value');
        if (descElement) {
            descElement.textContent = detailData.description;
        }
    }
    
    // 更新相关联的项目信息
    if (detailData.project_id && detailData.project_name) {
        // 将项目信息存储为卡片的数据属性
        card.setAttribute('data-project-id', detailData.project_id);
        card.setAttribute('data-project-name', detailData.project_name);
        
        // 添加项目徽章
        if (!card.querySelector('.project-badge')) {
            const header = card.querySelector('.risk-header');
            if (header) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary project-badge ms-2';
                badge.textContent = detailData.project_name;
                header.querySelector('.risk-title').appendChild(badge);
            }
        }
    }
    
    console.log(`[updateRiskCardWithDetails] 更新了风险卡片 #${riskId} 的详细信息`);
}

// 创建风险卡片
function createRiskCard(risk) {
    const card = document.createElement('div');
    card.className = 'risk-card';
    card.dataset.riskId = risk.id;
    
    const header = document.createElement('div');
    header.className = 'risk-header';
    
    const title = document.createElement('div');
    title.className = 'risk-title';
    title.textContent = risk.title || risk.name || '未命名风险';
    
    const level = document.createElement('div');
    level.className = `risk-level ${getRiskLevel(risk)}`;
    level.textContent = getRiskLevelText(risk);
    
    header.appendChild(title);
    header.appendChild(level);
    
    const details = document.createElement('div');
    details.className = 'risk-details';
    
    const properties = [
        { label: '描述', value: risk.description || risk.desc || '无' },
        { label: '概率', value: risk.probability || '未指定' },
        { label: '影响', value: risk.impact || '未指定' },
        { label: '状态', value: risk.status || '活跃' },
        { label: '缓解计划', value: risk.mitigation_plan || risk.control_measures || '无' }
    ];
    
    properties.forEach(prop => {
        const property = document.createElement('div');
        property.className = 'risk-property';
        
        const label = document.createElement('div');
        label.className = 'risk-property-label';
        label.textContent = prop.label;
        
        const value = document.createElement('div');
        value.className = 'risk-property-value';
        value.textContent = prop.value;
        
        property.appendChild(label);
        property.appendChild(value);
        details.appendChild(property);
    });
    
    const actions = document.createElement('div');
    actions.className = 'risk-actions';
    
    const editBtn = document.createElement('button');
    editBtn.className = 'btn btn-outline-primary btn-sm';
    editBtn.innerHTML = '<i class="fas fa-edit"></i> 编辑';
    editBtn.onclick = () => showEditRiskModal(risk);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-outline-danger btn-sm';
    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 删除';
    deleteBtn.onclick = () => deleteRisk(risk.id);
    
    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);
    
    card.appendChild(header);
    card.appendChild(details);
    card.appendChild(actions);
    
    return card;
}

// 获取风险等级
function getRiskLevel(risk) {
    const probability = (risk.probability || '').toString().toLowerCase();
    const impact = (risk.impact || '').toString().toLowerCase();
    const severity = (risk.severity || risk.level || '').toString().toLowerCase();
    
    if (severity === 'high' || severity === 'critical' || 
        (probability === 'high' && impact === 'high') ||
        (probability === '5' && impact === '5')) {
        return 'critical';
    } else if (severity === 'medium' || 
               probability === 'high' || impact === 'high' ||
               probability === '4' || impact === '4') {
        return 'high';
    } else if (severity === 'low' || 
               probability === 'medium' || impact === 'medium' ||
               probability === '3' || impact === '3') {
        return 'medium';
    } else {
        return 'low';
    }
}

// 获取风险等级文本
function getRiskLevelText(risk) {
    const level = getRiskLevel(risk);
    return {
        'critical': '严重',
        'high': '高',
        'medium': '中',
        'low': '低'
    }[level];
}

// 更新风险统计
function updateRiskStatistics(risks) {
    const stats = {
        total: risks.length,
        critical: 0,
        high: 0,
        medium: 0,
        low: 0
    };
    
    risks.forEach(risk => {
        const level = getRiskLevel(risk);
        stats[level]++;
    });
    
    document.getElementById('totalRisks').textContent = stats.total;
    document.getElementById('criticalRisks').textContent = stats.critical;
    document.getElementById('highRisks').textContent = stats.high;
    document.getElementById('mediumRisks').textContent = stats.medium;
    document.getElementById('lowRisks').textContent = stats.low;
}

// 显示添加风险模态框
function showAddRiskModal() {
    // 加载任务列表
    loadTasksForRiskForm();
    
    // 加载项目列表（为新的风险表单）
    loadProjectsForRiskForm('riskTask');
    
    const modal = new bootstrap.Modal(document.getElementById('addRiskModal'));
    modal.show();
}

// 加载项目列表用于风险表单
function loadProjectsForRiskForm(targetSelectId) {
    // 项目选择器可能在不同的模态框中
    const projectSelect = document.getElementById(targetSelectId);
    if (!projectSelect) {
        console.error(`未找到项目选择器 #${targetSelectId}`);
        return;
    }
    
    // 显示加载中状态
    projectSelect.innerHTML = '<option value="">加载中...</option>';
    projectSelect.disabled = true;
    
    // 使用统一的项目加载函数
    fetchAllProjects()
        .then(projects => {
            updateProjectSelectInForm(projectSelect, projects);
        })
        .catch(error => {
            console.error('[loadProjectsForRiskForm] 加载项目失败:', error);
            // 使用静态数据作为最终回退
            const staticProjects = addDefaultProjects([]);
            updateProjectSelectInForm(projectSelect, staticProjects);
        });
}

// 确保项目下拉框有数据
function ensureProjectDropdownPopulated(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // 检查是否已有选项
    if (select.options.length <= 1) { // 只有默认选项或没有选项
        console.log(`[ensureProjectDropdownPopulated] 项目下拉框 #${selectId} 没有数据，尝试加载`);
        
        // 尝试从缓存获取
        try {
            const savedProjects = localStorage.getItem('projects');
            if (savedProjects) {
                const parsedProjects = JSON.parse(savedProjects);
                if (Array.isArray(parsedProjects) && parsedProjects.length > 0) {
                    console.log(`[ensureProjectDropdownPopulated] 使用缓存数据填充 #${selectId}`);
                    updateProjectSelectInForm(select, parsedProjects);
                    return;
                }
            }
        } catch (e) {
            console.error('[ensureProjectDropdownPopulated] 解析缓存项目数据失败:', e);
        }
        
        // 如果没有缓存，尝试加载
        fetchAllProjects()
            .then(projects => {
                updateProjectSelectInForm(select, projects);
            })
            .catch(() => {
                // 使用默认数据
                updateProjectSelectInForm(select, addDefaultProjects([]));
            });
    }
}

// 加载任务列表用于风险表单
function loadTasksForRiskForm() {
    const taskSelect = document.getElementById('riskTask');
    if (!taskSelect) {
        console.error('未找到任务选择器');
        return;
    }
    
    // 显示加载中状态
    taskSelect.innerHTML = '<option value="">加载中...</option>';
    taskSelect.disabled = true;
    
    // 构建多个可能的API端点
    const apiUrls = [
        '/api/tasks',
        '/api/auth/tasks',
        '/api/noauth/tasks'
    ];
    
    // 尝试从多个API端点加载数据
    tryLoadTasksForRiskForm(apiUrls, 0, taskSelect);
}

// 尝试从不同API端点加载任务数据
function tryLoadTasksForRiskForm(urls, index, taskSelect) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        console.error('所有任务API端点都请求失败');
        
        taskSelect.innerHTML = '<option value="">无法加载任务</option>';
        taskSelect.disabled = false;
        
        return;
    }
    
    const url = urls[index];
    console.log(`[tryLoadTasksForRiskForm] 尝试从 ${url} 加载任务数据`);
    
    fetch(url, {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('access_token')}`,
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryLoadTasksForRiskForm] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            // 检查任务数据格式
            let tasks = [];
            
            if (Array.isArray(data)) {
                tasks = data;
            } else if (data.tasks && Array.isArray(data.tasks)) {
                tasks = data.tasks;
            } else if (data.data && Array.isArray(data.data)) {
                tasks = data.data;
            } else {
                console.warn('[tryLoadTasksForRiskForm] 无法识别返回的数据格式');
                throw new Error('无法识别返回的数据格式');
            }
            
            // 更新任务下拉框
            updateTaskDropdown(taskSelect, tasks);
            
        } catch (parseError) {
            console.error(`[tryLoadTasksForRiskForm] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryLoadTasksForRiskForm] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryLoadTasksForRiskForm(urls, index + 1, taskSelect), 300);
    });
}

// 更新任务下拉框
function updateTaskDropdown(taskSelect, tasks) {
    // 清空现有选项
    taskSelect.innerHTML = '';
    
    // 添加默认选项
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '选择任务';
    taskSelect.appendChild(defaultOption);
    
    // 添加任务选项
    tasks.forEach(task => {
        const option = document.createElement('option');
        option.value = task.id;
        option.textContent = task.title || task.name || `任务 #${task.id}`;
        taskSelect.appendChild(option);
    });
    
    // 启用选择器
    taskSelect.disabled = false;
    
    console.log(`已加载 ${tasks.length} 个任务`);
}

// 添加风险
function addRisk() {
    const form = document.getElementById('addRiskForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // 获取保存按钮并显示加载状态
    const saveBtn = document.querySelector('#addRiskModal .btn-primary');
    if (saveBtn) {
        if (!saveBtn.hasAttribute('data-original-html')) {
            saveBtn.setAttribute('data-original-html', saveBtn.innerHTML);
        }
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
        saveBtn.disabled = true;
        
        // 设置超时自动恢复按钮状态
        setTimeout(() => {
            if (saveBtn.disabled) {
                saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                saveBtn.disabled = false;
                console.log('按钮状态自动恢复');
            }
        }, 5000);
    }
    
    const riskData = {
        title: document.getElementById('riskTitle').value,
        description: document.getElementById('riskDescription').value,
        probability: document.getElementById('riskProbability').value,
        impact: document.getElementById('riskImpact').value,
        mitigation_plan: document.getElementById('riskMitigationPlan').value,
        task_id: document.getElementById('riskTask').value || null
    };
    
    // 构建多个可能的API端点
    const apiUrls = [
        '/api/auth/risks',
        '/api/risks',
        '/api/noauth/risks'
    ];
    
    // 尝试从多个API端点保存数据
    trySaveRisk(apiUrls, 0, riskData, saveBtn);
}

// 尝试向不同API端点保存风险
function trySaveRisk(urls, index, riskData, saveBtn) {
    // 如果所有URL都尝试过了，显示错误信息
    if (index >= urls.length) {
        console.error('所有风险保存API端点都请求失败');
        
        showMessage('保存风险失败', 'danger');
        
        // 恢复按钮状态
        if (saveBtn) {
            saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
            saveBtn.disabled = false;
        }
        
        return;
    }
    
    const url = urls[index];
    console.log(`[trySaveRisk] 尝试向 ${url} 保存风险`);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('access_token')}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(riskData)
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[trySaveRisk] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            console.log('保存风险成功:', data);
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
            
            // 恢复按钮状态
            if (saveBtn) {
                saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                saveBtn.disabled = false;
            }
            
            showMessage('风险添加成功', 'success');
            
            // 重新加载风险列表
            loadRisks();
            
        } catch (parseError) {
            console.error(`[trySaveRisk] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[trySaveRisk] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => trySaveRisk(urls, index + 1, riskData, saveBtn), 300);
    });
}

// 删除风险
function deleteRisk(riskId) {
    if (!confirm('确定要删除此风险吗？')) {
        return;
    }
    
    // 构建多个可能的API端点, 优先使用紧急删除端点
    const apiUrls = [
        `/api/risks/${riskId}/emergency_delete`,
        `/api/auth/risks/${riskId}`,
        `/api/risks/${riskId}`,
        `/api/noauth/risks/${riskId}`
    ];
    
    // 尝试从多个API端点删除数据
    tryDeleteRisk(apiUrls, 0, riskId);
}

// 尝试向不同API端点删除风险
function tryDeleteRisk(urls, index, riskId) {
    // 如果所有URL都尝试过了，显示错误信息
    if (index >= urls.length) {
        console.error('所有风险删除API端点都请求失败');
        
        showMessage('删除风险失败', 'danger');
        return;
    }
    
    const url = urls[index];
    console.log(`[tryDeleteRisk] 尝试向 ${url} 删除风险`);
    
    fetch(url, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('access_token')}`,
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryDeleteRisk] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            console.log('删除风险成功:', data);
            
            showMessage('风险删除成功', 'success');
            
            // 重新加载风险列表
            loadRisks();
            
        } catch (parseError) {
            console.error(`[tryDeleteRisk] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryDeleteRisk] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryDeleteRisk(urls, index + 1, riskId), 300);
    });
}

// 应用筛选
function applyFilters() {
    loadRisks();
}

// 清除筛选
function clearFilters() {
    document.getElementById('filterProject').value = '';
    document.getElementById('filterLevel').value = '';
    document.getElementById('filterStatus').value = '';
    loadRisks();
}

// 显示消息
function showMessage(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
    setTimeout(() => alert.remove(), 3000);
}

// 显示编辑风险模态框
function showEditRiskModal(risk) {
    // 确保风险对象存在
    if (!risk || !risk.id) {
        console.error("[showEditRiskModal] 没有提供有效的风险数据");
        showMessage("无法编辑风险：数据无效", "danger");
        return;
    }
    
    console.log("[showEditRiskModal] 显示风险编辑模态框:", risk.id);
    
    try {
        // 加载任务列表
        loadTasksForEditRiskForm(risk.task_id);
        
        // 加载项目列表（使用统一函数）
        loadProjectsForEdit();
        
        // 填充表单数据
        document.getElementById('editRiskId').value = risk.id;
        document.getElementById('editRiskTitle').value = risk.title || risk.name || '';
        document.getElementById('editRiskDescription').value = risk.description || risk.desc || '';
        document.getElementById('editRiskProbability').value = risk.probability || '';
        document.getElementById('editRiskImpact').value = risk.impact || '';
        document.getElementById('editRiskMitigationPlan').value = risk.mitigation_plan || risk.control_measures || '';
        
        // 显示模态框
        const modalEl = document.getElementById('editRiskModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
        // 为关闭按钮绑定事件（确保这个函数被定义）
        const closeBtns = modalEl.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]');
        closeBtns.forEach(btn => {
            // 移除旧的onclick
            if (btn.hasAttribute('onclick')) {
                btn.removeAttribute('onclick');
            }
            
            // 添加新的事件监听器（避免重复添加）
            btn.removeEventListener('click', closeEditRiskModal);
            btn.addEventListener('click', closeEditRiskModal);
        });
        
    } catch (error) {
        console.error("[showEditRiskModal] 显示编辑模态框出错:", error);
        showMessage("无法打开编辑窗口：" + error.message, "danger");
    }
}

// 为编辑风险表单加载项目列表
function loadProjectsForEdit() {
    const projectSelect = document.getElementById('editRiskTask');
    if (!projectSelect) {
        console.error('未找到编辑表单中的项目选择器');
        return;
    }
    
    // 显示加载中状态
    projectSelect.innerHTML = '<option value="">加载中...</option>';
    projectSelect.disabled = true;
    
    // 使用统一的项目加载函数
    fetchAllProjects()
        .then(projects => {
            updateProjectSelectInForm(projectSelect, projects);
        })
        .catch(error => {
            console.error('[loadProjectsForEdit] 加载项目失败:', error);
            // 使用静态数据作为最终回退
            const staticProjects = addDefaultProjects([]);
            updateProjectSelectInForm(projectSelect, staticProjects);
        });
}

// 页面初始化时预加载项目数据
function preloadProjectsData() {
    console.log('[preloadProjectsData] 预加载项目数据');
    
    fetchAllProjects()
        .then(projects => {
            console.log(`[preloadProjectsData] 成功预加载 ${projects.length} 个项目`);
        })
        .catch(error => {
            console.error('[preloadProjectsData] 预加载项目失败:', error);
        });
}

// 加载任务列表用于编辑风险表单
function loadTasksForEditRiskForm(selectedTaskId) {
    const taskSelect = document.getElementById('editRiskTask');
    if (!taskSelect) {
        console.error('未找到任务选择器');
        return;
    }
    
    // 显示加载中状态
    taskSelect.innerHTML = '<option value="">加载中...</option>';
    taskSelect.disabled = true;
    
    // 构建多个可能的API端点
    const apiUrls = [
        '/api/tasks',
        '/api/auth/tasks',
        '/api/noauth/tasks'
    ];
    
    // 尝试从多个API端点加载数据
    tryLoadTasksForEditRiskForm(apiUrls, 0, taskSelect, selectedTaskId);
}

// 尝试从不同API端点加载任务数据（用于编辑风险）
function tryLoadTasksForEditRiskForm(urls, index, taskSelect, selectedTaskId) {
    // 如果所有URL都尝试过了
    if (index >= urls.length) {
        console.error('所有任务API端点都请求失败');
        
        taskSelect.innerHTML = '<option value="">无法加载任务</option>';
        taskSelect.disabled = false;
        
        return;
    }
    
    const url = urls[index];
    console.log(`[tryLoadTasksForEditRiskForm] 尝试从 ${url} 加载任务数据`);
    
    fetch(url, {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('access_token')}`,
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryLoadTasksForEditRiskForm] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            // 检查任务数据格式
            let tasks = [];
            
            if (Array.isArray(data)) {
                tasks = data;
            } else if (data.tasks && Array.isArray(data.tasks)) {
                tasks = data.tasks;
            } else if (data.data && Array.isArray(data.data)) {
                tasks = data.data;
            } else {
                console.warn('[tryLoadTasksForEditRiskForm] 无法识别返回的数据格式');
                throw new Error('无法识别返回的数据格式');
            }
            
            // 更新任务下拉框
            updateEditTaskDropdown(taskSelect, tasks, selectedTaskId);
            
        } catch (parseError) {
            console.error(`[tryLoadTasksForEditRiskForm] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryLoadTasksForEditRiskForm] ${url} 请求失败:`, error);
        
        // 尝试下一个API端点
        setTimeout(() => tryLoadTasksForEditRiskForm(urls, index + 1, taskSelect, selectedTaskId), 300);
    });
}

// 更新编辑用的任务下拉框
function updateEditTaskDropdown(taskSelect, tasks, selectedTaskId) {
    // 清空现有选项
    taskSelect.innerHTML = '';
    
    // 添加默认选项
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '选择任务';
    taskSelect.appendChild(defaultOption);
    
    // 添加任务选项
    tasks.forEach(task => {
        const option = document.createElement('option');
        option.value = task.id;
        option.textContent = task.title || task.name || `任务 #${task.id}`;
        if (task.id == selectedTaskId) {
            option.selected = true;
        }
        taskSelect.appendChild(option);
    });
    
    // 启用选择器
    taskSelect.disabled = false;
    
    console.log(`已加载 ${tasks.length} 个任务`);
}

// 更新风险
function updateRisk() {
    const form = document.getElementById('editRiskForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // 获取保存按钮并显示加载状态
    const saveBtn = document.querySelector('#editRiskModal .btn-primary');
    if (saveBtn) {
        if (!saveBtn.hasAttribute('data-original-html')) {
            saveBtn.setAttribute('data-original-html', saveBtn.innerHTML);
        }
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
        saveBtn.disabled = true;
        
        // 设置超时自动恢复按钮状态
        setTimeout(() => {
            if (saveBtn.disabled) {
                saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                saveBtn.disabled = false;
                console.log('按钮状态自动恢复');
            }
        }, 5000);
    }
    
    const riskId = document.getElementById('editRiskId').value;
    const riskData = {
        title: document.getElementById('editRiskTitle').value,
        description: document.getElementById('editRiskDescription').value,
        probability: document.getElementById('editRiskProbability').value,
        impact: document.getElementById('editRiskImpact').value,
        mitigation_plan: document.getElementById('editRiskMitigationPlan').value,
        task_id: document.getElementById('editRiskTask').value || null
    };
    
    // 构建多个可能的API端点
    const apiUrls = [
        `/api/risks/${riskId}/emergency_delete`,
        `/api/auth/risks/${riskId}`,
        `/api/risks/${riskId}`,
        `/api/noauth/risks/${riskId}`
    ];
    
    // 尝试从多个API端点更新数据
    tryUpdateRisk(apiUrls, 0, riskData, saveBtn);
}

// 尝试向不同API端点更新风险
function tryUpdateRisk(urls, index, riskData, saveBtn) {
    // 如果所有URL都尝试过了，显示错误信息
    if (index >= urls.length) {
        console.error('所有风险更新API端点都请求失败');
        
        showMessage('更新风险失败', 'danger');
        
        // 恢复按钮状态
        if (saveBtn) {
            saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
            saveBtn.disabled = false;
        }
        
        return;
    }
    
    const url = urls[index];
    console.log(`[tryUpdateRisk] 尝试向 ${url} 更新风险`);
    
    // 尝试使用多种HTTP方法，因为不同后端可能支持不同的方法
    const methods = ['PUT', 'PATCH', 'POST'];
    tryUpdateRiskWithMethods(url, methods, 0, riskData, saveBtn, index, urls);
}

// 使用不同HTTP方法尝试更新风险
function tryUpdateRiskWithMethods(url, methods, methodIndex, riskData, saveBtn, urlIndex, urls) {
    // 如果所有方法都尝试过了，尝试下一个URL
    if (methodIndex >= methods.length) {
        // 尝试下一个API端点
        setTimeout(() => tryUpdateRisk(urls, urlIndex + 1, riskData, saveBtn), 300);
        return;
    }
    
    const method = methods[methodIndex];
    console.log(`[tryUpdateRiskWithMethods] 尝试使用 ${method} 方法向 ${url} 更新风险`);
    
    // 尝试获取CSRF令牌
    const csrf_token = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    fetch(url, {
        method: method,
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('access_token')}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrf_token
        },
        body: JSON.stringify(riskData)
    })
    .then(async response => {
        // 检查是否返回HTML而不是JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.warn(`[tryUpdateRiskWithMethods] ${url} 返回了HTML而不是JSON`);
            throw new Error('返回了HTML而不是JSON');
        }
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        try {
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            console.log('更新风险成功:', data);
            
            // 关闭模态框
            closeEditRiskModal();
            
            // 恢复按钮状态
            if (saveBtn) {
                saveBtn.innerHTML = saveBtn.getAttribute('data-original-html');
                saveBtn.disabled = false;
            }
            
            showMessage('风险更新成功', 'success');
            
            // 重新加载风险列表
            loadRisks();
            
        } catch (parseError) {
            console.error(`[tryUpdateRiskWithMethods] 解析 ${url} 响应出错:`, parseError);
            throw parseError;
        }
    })
    .catch(error => {
        console.error(`[tryUpdateRiskWithMethods] ${method} ${url} 请求失败:`, error);
        
        // 尝试下一个HTTP方法
        setTimeout(() => tryUpdateRiskWithMethods(url, methods, methodIndex + 1, riskData, saveBtn, urlIndex, urls), 300);
    });
}

// 模态框相关函数
// 关闭查看风险详情模态框
function closeViewRiskModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('viewRiskModal'));
    if (modal) {
        modal.hide();
    }
}
</script>
{% endblock %} 