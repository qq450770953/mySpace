{% extends "base.html" %}

{% block title %}风险管理{% endblock %}

{% block header %}风险管理{% endblock %}

{% block header_buttons %}
<div class="btn-group me-2">
    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newRiskModal">
        <i class="bi bi-plus-circle"></i> 新建风险
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportRisks()">
        <i class="bi bi-download"></i> 导出
    </button>
    <!-- 隐藏静态数据按钮
    <button type="button" class="btn btn-sm btn-outline-info" id="staticDataBtn" onclick="toggleStaticMode()">
        <i class="bi bi-database"></i> 静态数据
    </button>
    -->
</div>
{% endblock %}

{% block content %}
<!-- 风险列表 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">风险列表</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>风险描述</th>
                        <th>所属项目</th>
                        <th>风险等级</th>
                        <th>可能性</th>
                        <th>影响程度</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for risk in risks %}
                    <tr>
                        <td>{{ risk.description }}</td>
                        <td>{{ risk.project_name }}</td>
                        <td>
                            <span class="badge bg-{{ risk.level_color }}">
                                {{ risk.level }}
                            </span>
                        </td>
                        <td>{{ risk.probability }}</td>
                        <td>{{ risk.impact }}</td>
                        <td>
                            <span class="badge bg-{{ risk.status_color }}">
                                {{ risk.status }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary view-risk-btn" data-risk-id="{{ risk.id }}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary edit-risk-btn" data-risk-id="{{ risk.id }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-risk-btn" data-risk-id="{{ risk.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 风险矩阵 -->
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">风险矩阵</h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newRiskModal">
                        <i class="bi bi-plus-circle"></i> 新建风险
                    </button>
                </div>
                <div class="card-body">
                    <div class="risk-matrix">
                        <div class="matrix-grid">
                            <div class="matrix-header">概率/影响</div>
                            <div class="matrix-header">高</div>
                            <div class="matrix-header">中</div>
                            <div class="matrix-header">低</div>
                            
                            <div class="matrix-header">高</div>
                            <div class="matrix-cell high-risk" data-probability="high" data-impact="high"></div>
                            <div class="matrix-cell high-risk" data-probability="high" data-impact="medium"></div>
                            <div class="matrix-cell low-risk" data-probability="high" data-impact="low"></div>
                            
                            <div class="matrix-header">中</div>
                            <div class="matrix-cell medium-risk" data-probability="medium" data-impact="high"></div>
                            <div class="matrix-cell medium-risk" data-probability="medium" data-impact="medium"></div>
                            <div class="matrix-cell low-risk" data-probability="medium" data-impact="low"></div>
                            
                            <div class="matrix-header">低</div>
                            <div class="matrix-cell low-risk" data-probability="low" data-impact="high"></div>
                            <div class="matrix-cell low-risk" data-probability="low" data-impact="medium"></div>
                            <div class="matrix-cell low-risk" data-probability="low" data-impact="low"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 风险详情模态框 -->
<div class="modal fade" id="viewRiskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">风险详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">风险标题</label>
                            <p id="viewRiskTitle"></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">所属项目</label>
                            <p id="viewRiskProject"></p>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">风险描述</label>
                    <p id="viewRiskDescription"></p>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">风险等级</label>
                            <p id="viewRiskSeverity"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">可能性</label>
                            <p id="viewRiskProbability"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">影响程度</label>
                            <p id="viewRiskImpact"></p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label fw-bold">状态</label>
                            <p id="viewRiskStatus"></p>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">缓解措施</label>
                    <p id="viewRiskMitigation"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">应急计划</label>
                    <p id="viewRiskContingency"></p>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <label class="form-label fw-bold">创建和更新信息</label>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                创建时间
                                <span id="viewRiskCreatedAt" class="badge bg-primary rounded-pill"></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                更新时间
                                <span id="viewRiskUpdatedAt" class="badge bg-info rounded-pill"></span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="editRisk(currentViewingRiskId)">编辑</button>
            </div>
        </div>
    </div>
</div>

<!-- 新建风险模态框 -->
<div class="modal fade" id="newRiskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建风险</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="riskForm">
                    <div class="mb-3">
                        <label for="projectId" class="form-label">所属项目 <span class="text-danger">*</span></label>
                        <select class="form-select" id="projectId" required>
                            <option value="">请选择项目</option>
                            <!-- 项目选项将通过JavaScript动态填充 -->
                        </select>
                        <div class="invalid-feedback">请选择风险所属的项目</div>
                    </div>
                    <div class="mb-3">
                        <label for="riskTitle" class="form-label">风险标题</label>
                        <input type="text" class="form-control" id="riskTitle" placeholder="无标题风险">
                    </div>
                    <div class="mb-3">
                        <label for="riskDescription" class="form-label">风险描述 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="riskDescription" rows="3" required></textarea>
                        <div class="invalid-feedback">请填写风险描述</div>
                    </div>
                    <div class="mb-3">
                        <label for="severity" class="form-label">严重程度</label>
                        <select class="form-select" id="severity">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="probability" class="form-label">可能性</label>
                        <select class="form-select" id="probability">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="impact" class="form-label">影响程度</label>
                        <select class="form-select" id="impact">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="mitigation" class="form-label">缓解措施</label>
                        <textarea class="form-control" id="mitigation" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="contingency" class="form-label">应急计划</label>
                        <textarea class="form-control" id="contingency" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveRisk()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑风险模态框 -->
<div class="modal fade" id="editRiskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑风险</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRiskForm">
                    <input type="hidden" id="editRiskId">
                    <div class="mb-3">
                        <label for="editProjectId" class="form-label">所属项目 <span class="text-danger">*</span></label>
                        <select class="form-select" id="editProjectId" required>
                            <option value="">请选择项目</option>
                            <!-- 项目选项将通过JavaScript动态填充 -->
                        </select>
                        <div class="invalid-feedback">请选择风险所属的项目</div>
                    </div>
                    <div class="mb-3">
                        <label for="editRiskTitle" class="form-label">风险标题</label>
                        <input type="text" class="form-control" id="editRiskTitle" placeholder="无标题风险">
                    </div>
                    <div class="mb-3">
                        <label for="editRiskDescription" class="form-label">风险描述 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editRiskDescription" rows="3" required></textarea>
                        <div class="invalid-feedback">请填写风险描述</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSeverity" class="form-label">严重程度</label>
                        <select class="form-select" id="editSeverity">
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editProbability" class="form-label">可能性</label>
                        <select class="form-select" id="editProbability">
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editImpact" class="form-label">影响程度</label>
                        <select class="form-select" id="editImpact">
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">状态</label>
                        <select class="form-select" id="editStatus">
                            <option value="open">未处理</option>
                            <option value="in_progress">处理中</option>
                            <option value="mitigated">已缓解</option>
                            <option value="closed">已关闭</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editMitigation" class="form-label">缓解措施</label>
                        <textarea class="form-control" id="editMitigation" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editContingency" class="form-label">应急计划</label>
                        <textarea class="form-control" id="editContingency" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateRisk()">保存修改</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .risk-matrix {
        margin: 20px 0;
    }
    
    .matrix-grid {
        display: grid;
        grid-template-columns: 100px repeat(3, 1fr);
        grid-template-rows: 50px repeat(3, 1fr);
        gap: 1px;
        background-color: #dee2e6;
    }
    
    .matrix-header {
        background-color: #f8f9fa;
        padding: 10px;
        text-align: center;
        font-weight: bold;
    }
    
    .matrix-cell {
        background-color: white;
        padding: 10px;
        min-height: 100px;
    }
    
    .high-risk {
        background-color: #ff6b6b;
    }
    
    .medium-risk {
        background-color: #ffd43b;
    }
    
    .low-risk {
        background-color: #51cf66;
    }
    
    .risk-item {
        margin: 5px 0;
        padding: 5px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 3px;
        cursor: pointer;
    }
    
    .risk-item:hover {
        background-color: rgba(255, 255, 255, 0.9);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // URL参数检测
    function getUrlParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }
    
    // 切换静态数据模式
    function toggleStaticMode() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentMode = urlParams.get('static') === 'true';
        
        if (currentMode) {
            urlParams.delete('static');
        } else {
            urlParams.set('static', 'true');
        }
        
        window.location.search = urlParams.toString();
    }
    
    // 更新静态数据按钮状态
    function updateStaticButtonUI() {
        const isStatic = getUrlParam('static') === 'true';
        const btn = document.getElementById('staticDataBtn');
        
        if (btn) {
            if (isStatic) {
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-info');
                btn.innerHTML = '<i class="bi bi-database"></i> 使用API数据';
            } else {
                btn.classList.remove('btn-info');
                btn.classList.add('btn-outline-info');
                btn.innerHTML = '<i class="bi bi-database"></i> 静态数据';
            }
        }
    }
    
    // 模态框操作函数
    // 关闭查看风险详情模态框
    function closeViewRiskModal() {
        const modal = document.getElementById('viewRiskModal');
        if (modal) {
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            } else {
                modal.classList.remove('show');
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
                // 移除背景遮罩
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }
        }
    }
    
    // 关闭编辑风险模态框
    function closeEditRiskModal() {
        const modal = document.getElementById('editRiskModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
                // 移除背景遮罩
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }, 300);
        }
    }
    
    // 关闭新建风险模态框
    function closeNewRiskModal() {
        const modal = document.getElementById('newRiskModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
                // 移除背景遮罩
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }, 300);
        }
    }
    
    // 初始化模态框功能
    document.addEventListener('DOMContentLoaded', function() {
        // 更新静态数据按钮状态
        updateStaticButtonUI();
        
        // 立即预加载项目数据，确保下拉框有值
        initializeRiskPage();
        
        // 获取所有"新建风险"按钮
        const newRiskBtns = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#newRiskModal"]');
        newRiskBtns.forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                // 在显示模态框之前加载项目列表
                try {
                    const projects = await fetchAllProjects();
                    updateProjectDropdowns(projects);
                } catch (error) {
                    console.error('加载项目列表失败:', error);
                }
                
                // 显示模态框
                const modal = document.getElementById('newRiskModal');
                if (modal) {
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    // 添加背景遮罩
                    let backdrop = document.querySelector('.modal-backdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                    }
                }
            });
        });
        
        // 获取模态框中的关闭按钮
        const closeBtns = document.querySelectorAll('#newRiskModal .btn-close, #newRiskModal [data-bs-dismiss="modal"]');
        closeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                closeNewRiskModal();
            });
        });
        
        // 绑定风险操作按钮事件
        bindRiskButtonEvents();
        
        // 检查URL参数确定是否使用静态数据
        const urlParams = new URLSearchParams(window.location.search);
        const useStaticData = urlParams.get('static') === 'true' || urlParams.get('debug') === 'true';
        
        if (useStaticData) {
            console.log("使用静态数据模式");
            initializeWithStaticData();
        } else {
            // 正常加载数据
            loadProjectList();
            initializeRiskMatrix();
            loadRisks(); // 加载风险数据
        }
    });
    
    // 初始化风险页面
    function initializeRiskPage() {
        console.log("[initializeRiskPage] 开始初始化风险页面...");
        
        // 立即加载项目数据
        preloadProjectsData();
        
        // 设置定时器检查下拉框是否已初始化
        setTimeout(() => {
            const projectSelect = document.getElementById('projectId');
            if (projectSelect && projectSelect.options.length <= 1) {
                console.log("[initializeRiskPage] 项目下拉框未初始化，再次尝试加载项目数据");
                preloadProjectsData();
            }
        }, 1000);
        
        // 加载风险数据
        loadRisks();
    }
    
    // 预加载项目数据，确保模态框下拉列表有值
    async function preloadProjectsData() {
        try {
            console.log("预加载项目数据...");
            
            // 尝试从API获取项目
            const projects = await fetchAllProjects();
            if (projects && projects.length > 0) {
                console.log(`预加载了 ${projects.length} 个项目`);
                
                // 更新项目下拉框
                updateProjectDropdowns(projects);
                
                // 缓存项目数据
                try {
                    localStorage.setItem('projectsCache', JSON.stringify(projects));
                } catch (error) {
                    console.warn("缓存项目数据失败:", error);
                }
            } else {
                console.warn("预加载项目失败，没有返回项目数据");
            }
        } catch (error) {
            console.error("预加载项目数据出错:", error);
        }
    }
    
    // 绑定风险操作按钮事件
    function bindRiskButtonEvents() {
        // 查看风险按钮
        document.querySelectorAll('.view-risk-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const riskId = this.getAttribute('data-risk-id');
                viewRisk(riskId);
            });
        });
        
        // 编辑风险按钮
        document.querySelectorAll('.edit-risk-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const riskId = this.getAttribute('data-risk-id');
                editRisk(riskId);
            });
        });
        
        // 删除风险按钮
        document.querySelectorAll('.delete-risk-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const riskId = this.getAttribute('data-risk-id');
                deleteRisk(riskId);
            });
        });
    }
    
    // 使用静态数据初始化页面
    function initializeWithStaticData() {
        console.log("初始化静态数据...");
        
        // 静态项目数据
        const staticProjects = [
            { id: 1, name: "ERP系统升级项目" },
            { id: 2, name: "移动应用开发" },
            { id: 3, name: "数据中心迁移" },
            { id: 4, name: "网站重构" }
        ];
        
        // 静态风险数据
        const staticRisks = [
            {
                id: 1,
                title: "技术依赖风险",
                description: "对第三方组件的依赖可能导致进度延迟",
                project_id: 1,
                project_name: "ERP系统升级项目",
                severity: "high",
                probability: "medium",
                impact: "high",
                status: "open",
                level: "高",
                level_color: "danger",
                status_color: "danger",
                mitigation_plan: "提前评估所有依赖组件",
                contingency_plan: "准备替代方案",
                created_at: "2025-05-10T10:00:00",
                updated_at: "2025-05-11T14:30:00",
                owner_id: 1
            },
            {
                id: 2,
                title: "人员流动风险",
                description: "核心开发人员可能离职",
                project_id: 2,
                project_name: "移动应用开发",
                severity: "medium",
                probability: "low",
                impact: "high",
                status: "in_progress",
                level: "中",
                level_color: "warning",
                status_color: "warning",
                mitigation_plan: "知识共享和文档化",
                contingency_plan: "制定招聘备用计划",
                created_at: "2025-05-09T09:15:00",
                updated_at: "2025-05-11T11:20:00",
                owner_id: 1
            },
            {
                id: 3,
                title: "预算超支风险",
                description: "项目可能超出预算限制",
                project_id: 3,
                project_name: "数据中心迁移",
                severity: "high",
                probability: "high",
                impact: "high",
                status: "mitigated",
                level: "高",
                level_color: "danger",
                status_color: "success",
                mitigation_plan: "严格的成本控制和监控",
                contingency_plan: "准备额外资金",
                created_at: "2025-05-08T14:45:00",
                updated_at: "2025-05-10T16:30:00",
                owner_id: 1
            },
            {
                id: 4,
                title: "范围蔓延风险",
                description: "客户可能不断增加需求导致范围扩大",
                project_id: 4,
                project_name: "网站重构",
                severity: "medium",
                probability: "high",
                impact: "medium",
                status: "open",
                level: "中",
                level_color: "warning",
                status_color: "danger",
                mitigation_plan: "明确的需求管理流程",
                contingency_plan: "设立变更控制委员会",
                created_at: "2025-05-07T11:30:00",
                updated_at: "2025-05-09T10:15:00",
                owner_id: 1
            }
        ];
        
        // 更新项目下拉框
        updateProjectDropdowns(staticProjects);
        
        // 更新风险表格
        updateRiskTable(staticRisks);
        
        // 更新风险矩阵
        refreshRiskMatrix(staticRisks);
        
        // 绑定事件处理器到按钮
        bindRiskButtonEvents();
        
        console.log("静态数据初始化完成");
    }
    
    // 绑定事件处理器
    function attachEventHandlers() {
        // 为所有查看、编辑、删除按钮添加事件
        document.querySelectorAll('[data-risk-id]').forEach(btn => {
            const riskId = btn.getAttribute('data-risk-id');
            
            if (btn.classList.contains('view-risk-btn') || btn.classList.contains('btn-outline-primary')) {
                // 查看按钮
                btn.onclick = function() { viewRisk(riskId); };
            } else if (btn.classList.contains('edit-risk-btn') || btn.classList.contains('btn-outline-secondary')) {
                // 编辑按钮
                btn.onclick = function() { editRisk(riskId); };
            } else if (btn.classList.contains('delete-risk-btn') || btn.classList.contains('btn-outline-danger')) {
                // 删除按钮
                btn.onclick = function() { deleteRisk(riskId); };
            }
        });
    }
    
    // 加载项目列表
    async function loadProjectList() {
        try {
            console.log("开始加载所有项目列表...");
            
            // 首先尝试使用fetchAllProjects函数获取完整的项目列表
            const projects = await fetchAllProjects();
            
            // 检查是否成功获取项目数据
            if (projects && projects.length > 0) {
                console.log(`成功获取 ${projects.length} 个项目`);
                updateProjectDropdowns(projects);
                return;
            }
            
            // 如果获取项目失败，尝试从localStorage获取缓存数据
            try {
                const cachedProjects = localStorage.getItem('projectsCache');
                if (cachedProjects) {
                    const parsedProjects = JSON.parse(cachedProjects);
                    if (Array.isArray(parsedProjects) && parsedProjects.length > 0) {
                        console.log(`使用缓存的 ${parsedProjects.length} 个项目数据`);
                        updateProjectDropdowns(parsedProjects);
                        return;
                    }
                }
            } catch (e) {
                console.warn("读取缓存项目数据失败:", e);
            }
            
            // 如果fetchAllProjects和缓存都失败，使用默认项目数据
            console.warn("获取项目数据失败，使用默认项目数据");
            const defaultProjects = [
                { id: 1, name: "产品研发项目" },
                { id: 2, name: "市场推广项目" },
                { id: 3, name: "系统升级项目" },
                { id: 4, name: "数据中心建设" },
                { id: 5, name: "客户服务优化" },
                { id: 6, name: "研发创新项目" },
                { id: 7, name: "基础设施升级" },
                { id: 8, name: "产品质量改进" },
                { id: 9, name: "用户体验优化" },
                { id: 10, name: "安全合规项目" }
            ];
            updateProjectDropdowns(defaultProjects);
        } catch (error) {
            console.error('加载项目列表错误:', error);
            showAlert('danger', '加载项目列表失败，使用默认数据');
            
            // 使用默认数据
            const defaultProjects = [
                { id: 1, name: "产品研发项目" },
                { id: 2, name: "市场推广项目" },
                { id: 3, name: "系统升级项目" },
                { id: 4, name: "数据中心建设" },
                { id: 5, name: "客户服务优化" },
                { id: 6, name: "研发创新项目" },
                { id: 7, name: "基础设施升级" },
                { id: 8, name: "产品质量改进" },
                { id: 9, name: "用户体验优化" },
                { id: 10, name: "安全合规项目" }
            ];
            updateProjectDropdowns(defaultProjects);
        }
    }
    
    // 从通用API响应中提取项目信息
    function extractProjectsFromGeneralData(data) {
        const projects = new Map();
        
        try {
            // 如果直接是项目数组
            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (item && (item.id || item.project_id)) {
                        const id = item.id || item.project_id;
                        const name = item.name || item.project_name || item.title || `项目 #${id}`;
                        projects.set(id, { id, name });
                    }
                });
            }
            // 如果是嵌套在字段中的项目数组
            else if (data && typeof data === 'object') {
                // 检查常见的项目字段名
                const possibleProjectFields = ['projects', 'data', 'items', 'results', 'content'];
                
                for (const field of possibleProjectFields) {
                    if (data[field] && Array.isArray(data[field])) {
                        data[field].forEach(item => {
                            if (item && (item.id || item.project_id)) {
                                const id = item.id || item.project_id;
                                const name = item.name || item.project_name || item.title || `项目 #${id}`;
                                projects.set(id, { id, name });
                            }
                        });
                    }
                }
                
                // 检查是否有嵌套在其他对象中的项目信息
                for (const key in data) {
                    const value = data[key];
                    if (value && typeof value === 'object' && !Array.isArray(value)) {
                        // 如果是对象，可能是项目
                        if (value.id || value.project_id) {
                            const id = value.id || value.project_id;
                            const name = value.name || value.project_name || value.title || `项目 #${id}`;
                            projects.set(id, { id, name });
                        }
                        // 递归检查嵌套对象
                        else if (Object.keys(value).length > 0) {
                            for (const subKey in value) {
                                const subValue = value[subKey];
                                if (subValue && typeof subValue === 'object' && (subValue.id || subValue.project_id)) {
                                    const id = subValue.id || subValue.project_id;
                                    const name = subValue.name || subValue.project_name || subValue.title || `项目 #${id}`;
                                    projects.set(id, { id, name });
                                }
                            }
                        }
                    }
                }
            }
        } catch (e) {
            console.warn("提取项目数据出错:", e);
        }
        
        return Array.from(projects.values());
    }
    
    // 解析项目数据
    function parseProjectsData(data) {
        let projects = [];
        
        try {
            // 检查返回的数据结构，适应可能的不同格式
            if (Array.isArray(data)) {
                projects = data.filter(item => 
                    item && typeof item === 'object' && (item.id || item.project_id)
                );
            } else if (data.projects && Array.isArray(data.projects)) {
                projects = data.projects;
            } else if (data.success && data.projects && Array.isArray(data.projects)) {
                projects = data.projects;
            } else if (data.data && Array.isArray(data.data)) {
                projects = data.data;
            } else if (data.items && Array.isArray(data.items)) {
                projects = data.items;
            } else if (data.results && Array.isArray(data.results)) {
                projects = data.results;
            } else if (typeof data === 'object') {
                // 如果是对象，尝试提取项目信息
                projects = extractProjectsFromGeneralData(data);
            }
            
            // 标准化项目对象格式
            projects = projects.map(item => ({
                id: item.id || item.project_id || item.key || item.code,
                name: item.name || item.project_name || item.title || item.display_name || `项目 #${item.id || item.project_id || item.key || item.code}`
            }));
            
            // 过滤掉无效项目
            projects = projects.filter(p => p.id && p.name);
        } catch (e) {
            console.warn("解析项目数据出错:", e);
        }
        
        return projects;
    }
    
    // 更新所有项目下拉框
    function updateProjectDropdowns(projects) {
        console.log("开始更新项目下拉框...");
        
        // 获取所有项目下拉框
        const projectSelects = document.querySelectorAll('select[id="projectId"], select[id="editProjectId"]');
        
        projectSelects.forEach(select => {
            // 保存当前选中的值
            const currentValue = select.value;
            
            // 清空现有选项
            select.innerHTML = '<option value="">请选择项目</option>';
            
            // 添加项目选项
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
            
            // 恢复之前选中的值
            if (currentValue) {
                select.value = currentValue;
            }
        });
        
        console.log(`已更新 ${projectSelects.length} 个项目下拉框`);
        
        // 直接在这里初始化模态框中的项目下拉框
        initializeModalProjectDropdowns(projects);
    }
    
    // 初始化模态框中的项目下拉框
    function initializeModalProjectDropdowns(projects) {
        // 处理新建风险模态框
        const newRiskSelect = document.getElementById('projectId');
        if (newRiskSelect) {
            // 清空现有选项
            newRiskSelect.innerHTML = '<option value="">请选择项目</option>';
            
            // 添加项目选项
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                newRiskSelect.appendChild(option);
            });
        }
        
        // 处理编辑风险模态框
        const editRiskSelect = document.getElementById('editProjectId');
        if (editRiskSelect) {
            // 清空现有选项
            editRiskSelect.innerHTML = '<option value="">请选择项目</option>';
            
            // 添加项目选项
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                editRiskSelect.appendChild(option);
            });
        }
    }
    
    // 初始化风险矩阵
    function initializeRiskMatrix() {
        // 为风险项添加点击事件
        document.querySelectorAll('.risk-item').forEach(item => {
            item.addEventListener('click', function() {
                const riskId = this.getAttribute('data-risk-id');
                viewRisk(riskId);
            });
        });
    }
    
    // 保存风险
    async function saveRisk() {
        try {
            const form = document.getElementById('riskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 获取项目ID并验证
            const projectId = document.getElementById('projectId').value;
            if (!projectId) {
                document.getElementById('projectId').classList.add('is-invalid');
                return;
            }
            
            const formData = {
                description: document.getElementById('riskDescription').value,
                title: document.getElementById('riskTitle').value || '无标题风险',
                probability: document.getElementById('probability').value || 'medium',
                impact: document.getElementById('impact').value || 'medium',
                severity: document.getElementById('severity').value || 'medium',
                status: 'open',
                project_id: parseInt(projectId), // 添加项目ID字段
                mitigation_plan: document.getElementById('mitigation').value || '',
                contingency_plan: document.getElementById('contingency').value || '',
                owner_id: 1 // 默认使用ID为1的用户作为负责人
            };
            
            console.log('提交风险数据:', formData);
            
            // 如果是静态数据模式，模拟创建操作
            if (getUrlParam('static') === 'true') {
                console.log('静态模式：模拟创建风险');
                
                // 关闭模态框
                closeNewRiskModal();
                
                // 重置表单
                form.reset();
                
                // 刷新风险列表（静态模式下重新初始化静态数据）
                initializeWithStaticData();
                
                // 显示成功消息
                showAlert('success', '风险创建成功！（静态模式）');
                return;
            }
            
            // 尝试多个API路径
            const apiUrls = [
                '/api/auth/risks/?bypass_jwt=true',
                '/api/noauth/risks',
                '/risks',
                '/api/risks',
                '/risk'
            ];
            
            // 尝试每个API路径
            let response = null;
            let successfulUrl = '';
            
            for (const url of apiUrls) {
                try {
                    console.log(`尝试提交风险到 ${url}`);
                    const res = await fetchWithCsrf(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (res.ok) {
                        response = res;
                        successfulUrl = url;
                        break;
                    } else {
                        console.warn(`向 ${url} 提交失败，状态码:`, res.status);
                    }
                } catch (e) {
                    console.warn(`向 ${url} 提交风险数据失败:`, e);
                }
            }
            
            if (!response || !response.ok) {
                throw new Error('所有API路径提交风险失败');
            }
            
            console.log(`成功提交风险到 ${successfulUrl}`);
            
            // 关闭模态框
            closeNewRiskModal();
            
            // 重置表单
            form.reset();
            
            // 刷新风险列表
            loadRisks();
            
            // 显示成功消息
            showAlert('success', '风险创建成功！');
        } catch (error) {
            console.error('保存风险错误:', error);
            showAlert('danger', error.message || '创建风险失败，请重试');
        }
    }
    
    // 当前正在查看的风险ID
    let currentViewingRiskId = null;

    // 查看风险详情
    async function viewRisk(riskId) {
        try {
            currentViewingRiskId = riskId;
            
            // 如果是静态数据模式，使用静态数据
            if (getUrlParam('static') === 'true') {
                // 查找对应ID的静态风险数据
                const staticRisks = [
                    {
                        id: 1,
                        title: "技术依赖风险",
                        description: "对第三方组件的依赖可能导致进度延迟",
                        project_id: 1,
                        project_name: "ERP系统升级项目",
                        severity: "high",
                        probability: "medium",
                        impact: "high",
                        status: "open",
                        mitigation_plan: "提前评估所有依赖组件",
                        contingency_plan: "准备替代方案",
                        created_at: "2025-05-10T10:00:00",
                        updated_at: "2025-05-11T14:30:00"
                    },
                    {
                        id: 2,
                        title: "人员流动风险",
                        description: "核心开发人员可能离职",
                        project_id: 2,
                        project_name: "移动应用开发",
                        severity: "medium",
                        probability: "low",
                        impact: "high",
                        status: "in_progress",
                        mitigation_plan: "知识共享和文档化",
                        contingency_plan: "制定招聘备用计划",
                        created_at: "2025-05-09T09:15:00",
                        updated_at: "2025-05-11T11:20:00"
                    },
                    {
                        id: 3,
                        title: "预算超支风险",
                        description: "项目可能超出预算限制",
                        project_id: 3,
                        project_name: "数据中心迁移",
                        severity: "high",
                        probability: "high",
                        impact: "high",
                        status: "mitigated",
                        mitigation_plan: "严格的成本控制和监控",
                        contingency_plan: "准备额外资金",
                        created_at: "2025-05-08T14:45:00",
                        updated_at: "2025-05-10T16:30:00"
                    },
                    {
                        id: 4,
                        title: "范围蔓延风险",
                        description: "客户可能不断增加需求导致范围扩大",
                        project_id: 4,
                        project_name: "网站重构",
                        severity: "medium",
                        probability: "high",
                        impact: "medium",
                        status: "open",
                        mitigation_plan: "明确的需求管理流程",
                        contingency_plan: "设立变更控制委员会",
                        created_at: "2025-05-07T11:30:00",
                        updated_at: "2025-05-09T10:15:00"
                    }
                ];
                
                const risk = staticRisks.find(r => parseInt(r.id) === parseInt(riskId));
                
                if (!risk) {
                    throw new Error(`未找到ID为${riskId}的风险`);
                }
                
                displayRiskDetails(risk);
                return;
            }
            
            // 调用API获取风险详情
            const apiUrls = [
                `/api/risks/${riskId}?bypass_jwt=true`,
                `/api/noauth/risks/${riskId}`,
                `/api/auth/risks/${riskId}?bypass_jwt=true`,
                `/risks/${riskId}?bypass_jwt=true`
            ];
            
            let response = null;
            let risk = null;
            
            for (const url of apiUrls) {
                try {
                    console.log(`尝试从 ${url} 获取风险详情`);
                    const res = await fetch(url);
                    if (res.ok) {
                        response = res;
                        break;
                    }
                } catch (e) {
                    console.warn(`从 ${url} 获取风险详情失败:`, e);
                }
            }
            
            if (!response || !response.ok) {
                throw new Error('获取风险详情失败');
            }
            
            risk = await response.json();
            console.log('风险详情:', risk);
            
            // 格式化风险等级
            let severity = '未知';
            let severityClass = 'text-secondary';
            
            if (risk.severity === 'high') {
                severity = '高';
                severityClass = 'text-danger';
            } else if (risk.severity === 'medium') {
                severity = '中';
                severityClass = 'text-warning';
            } else if (risk.severity === 'low') {
                severity = '低';
                severityClass = 'text-success';
            }
            
            // 格式化风险状态
            let statusText = risk.status || '未知';
            let statusClass = 'text-secondary';
            
            if (risk.status === 'open') {
                statusText = '未处理';
                statusClass = 'text-danger';
            } else if (risk.status === 'in_progress') {
                statusText = '处理中';
                statusClass = 'text-warning';
            } else if (risk.status === 'mitigated') {
                statusText = '已缓解';
                statusClass = 'text-success';
            } else if (risk.status === 'closed') {
                statusText = '已关闭';
                statusClass = 'text-secondary';
            }
            
            // 格式化概率
            let probability = '未知';
            if (risk.probability === 'high') {
                probability = '高';
            } else if (risk.probability === 'medium') {
                probability = '中';
            } else if (risk.probability === 'low') {
                probability = '低';
            }
            
            // 格式化影响
            let impact = '未知';
            if (risk.impact === 'high') {
                impact = '高';
            } else if (risk.impact === 'medium') {
                impact = '中';
            } else if (risk.impact === 'low') {
                impact = '低';
            }
            
            // 填充模态框内容
            document.getElementById('viewRiskTitle').textContent = risk.title || '无标题风险';
            document.getElementById('viewRiskProject').textContent = risk.project_name || '未指定';
            document.getElementById('viewRiskDescription').textContent = risk.description || '';
            document.getElementById('viewRiskSeverity').innerHTML = `<span class="${severityClass}">${severity}</span>`;
            document.getElementById('viewRiskProbability').textContent = probability;
            document.getElementById('viewRiskImpact').textContent = impact;
            document.getElementById('viewRiskStatus').innerHTML = `<span class="${statusClass}">${statusText}</span>`;
            document.getElementById('viewRiskMitigation').textContent = risk.mitigation_plan || '无缓解措施';
            document.getElementById('viewRiskContingency').textContent = risk.contingency_plan || '无应急计划';
            
            // 格式化日期
            const createdAt = risk.created_at ? new Date(risk.created_at).toLocaleString() : '未知';
            const updatedAt = risk.updated_at ? new Date(risk.updated_at).toLocaleString() : '未知';
            
            document.getElementById('viewRiskCreatedAt').textContent = createdAt;
            document.getElementById('viewRiskUpdatedAt').textContent = updatedAt;
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('viewRiskModal'));
            modal.show();
        } catch (error) {
            console.error('查看风险详情错误:', error);
            showAlert('danger', '获取风险详情失败');
        }
    }

    // 显示风险详情到模态框
    function displayRiskDetails(risk) {
        // 格式化风险等级
        let severity = '未知';
        let severityClass = 'text-secondary';
        
        if (risk.severity === 'high') {
            severity = '高';
            severityClass = 'text-danger';
        } else if (risk.severity === 'medium') {
            severity = '中';
            severityClass = 'text-warning';
        } else if (risk.severity === 'low') {
            severity = '低';
            severityClass = 'text-success';
        }
        
        // 格式化风险状态
        let statusText = risk.status || '未知';
        let statusClass = 'text-secondary';
        
        if (risk.status === 'open') {
            statusText = '未处理';
            statusClass = 'text-danger';
        } else if (risk.status === 'in_progress') {
            statusText = '处理中';
            statusClass = 'text-warning';
        } else if (risk.status === 'mitigated') {
            statusText = '已缓解';
            statusClass = 'text-success';
        } else if (risk.status === 'closed') {
            statusText = '已关闭';
            statusClass = 'text-secondary';
        }
        
        // 格式化概率
        let probability = '未知';
        if (risk.probability === 'high') {
            probability = '高';
        } else if (risk.probability === 'medium') {
            probability = '中';
        } else if (risk.probability === 'low') {
            probability = '低';
        }
        
        // 格式化影响
        let impact = '未知';
        if (risk.impact === 'high') {
            impact = '高';
        } else if (risk.impact === 'medium') {
            impact = '中';
        } else if (risk.impact === 'low') {
            impact = '低';
        }
        
        // 填充模态框内容
        document.getElementById('viewRiskTitle').textContent = risk.title || '无标题风险';
        document.getElementById('viewRiskProject').textContent = risk.project_name || '未指定';
        document.getElementById('viewRiskDescription').textContent = risk.description || '';
        document.getElementById('viewRiskSeverity').innerHTML = `<span class="${severityClass}">${severity}</span>`;
        document.getElementById('viewRiskProbability').textContent = probability;
        document.getElementById('viewRiskImpact').textContent = impact;
        document.getElementById('viewRiskStatus').innerHTML = `<span class="${statusClass}">${statusText}</span>`;
        document.getElementById('viewRiskMitigation').textContent = risk.mitigation_plan || '无缓解措施';
        document.getElementById('viewRiskContingency').textContent = risk.contingency_plan || '无应急计划';
        
        // 格式化日期
        const createdAt = risk.created_at ? new Date(risk.created_at).toLocaleString() : '未知';
        const updatedAt = risk.updated_at ? new Date(risk.updated_at).toLocaleString() : '未知';
        
        document.getElementById('viewRiskCreatedAt').textContent = createdAt;
        document.getElementById('viewRiskUpdatedAt').textContent = updatedAt;
        
        // 显示模态框
        const modal = document.getElementById('viewRiskModal');
        if (modal) {
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // 添加背景遮罩
            let backdrop = document.querySelector('.modal-backdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
        }
    }

    // 编辑风险
    async function editRisk(riskId) {
        try {
            // 关闭查看风险详情模态框（如果打开的话）
            closeViewRiskModal();
            
            console.log('开始编辑风险:', riskId);
            
            // 先加载所有项目列表，确保项目下拉框有完整数据
            await loadProjectsForEdit();
            
            // 如果是静态数据模式，使用静态数据
            if (getUrlParam('static') === 'true') {
                // 查找对应ID的静态风险数据
                const staticRisks = [
                    {
                        id: 1,
                        title: "技术依赖风险",
                        description: "对第三方组件的依赖可能导致进度延迟",
                        project_id: 1,
                        project_name: "ERP系统升级项目",
                        severity: "high",
                        probability: "medium",
                        impact: "high",
                        status: "open",
                        mitigation_plan: "提前评估所有依赖组件",
                        contingency_plan: "准备替代方案",
                        created_at: "2025-05-10T10:00:00",
                        updated_at: "2025-05-11T14:30:00"
                    },
                    {
                        id: 2,
                        title: "人员流动风险",
                        description: "核心开发人员可能离职",
                        project_id: 2,
                        project_name: "移动应用开发",
                        severity: "medium",
                        probability: "low",
                        impact: "high",
                        status: "in_progress",
                        mitigation_plan: "知识共享和文档化",
                        contingency_plan: "制定招聘备用计划",
                        created_at: "2025-05-09T09:15:00",
                        updated_at: "2025-05-11T11:20:00"
                    },
                    {
                        id: 3,
                        title: "预算超支风险",
                        description: "项目可能超出预算限制",
                        project_id: 3,
                        project_name: "数据中心迁移",
                        severity: "high",
                        probability: "high",
                        impact: "high",
                        status: "mitigated",
                        mitigation_plan: "严格的成本控制和监控",
                        contingency_plan: "准备额外资金",
                        created_at: "2025-05-08T14:45:00",
                        updated_at: "2025-05-10T16:30:00"
                    },
                    {
                        id: 4,
                        title: "范围蔓延风险",
                        description: "客户可能不断增加需求导致范围扩大",
                        project_id: 4,
                        project_name: "网站重构",
                        severity: "medium",
                        probability: "high",
                        impact: "medium",
                        status: "open",
                        mitigation_plan: "明确的需求管理流程",
                        contingency_plan: "设立变更控制委员会",
                        created_at: "2025-05-07T11:30:00",
                        updated_at: "2025-05-09T10:15:00"
                    }
                ];
                
                let risk = staticRisks.find(r => parseInt(r.id) === parseInt(riskId));
                
                if (!risk) {
                    // 如果没找到，使用默认风险数据
                    risk = {
                        id: riskId,
                        title: `风险 #${riskId}`,
                        description: "风险详情",
                        project_id: 1,
                        project_name: "ERP系统升级项目",
                        severity: "medium",
                        probability: "medium",
                        impact: "medium",
                        status: "open",
                        mitigation_plan: "",
                        contingency_plan: ""
                    };
                }
                
                console.log('静态数据模式 - 使用静态风险数据:', risk);
                
                // 填充编辑表单
                fillEditRiskForm(risk);
                
                // 显示编辑模态框
                showEditRiskModal();
                return;
            }
            
            // 尝试从现有数据中查找风险
            try {
                // 查找页面上已经显示的风险数据
                const riskElement = document.querySelector(`[data-risk-id="${riskId}"]`);
                if (riskElement) {
                    const row = riskElement.closest('tr');
                    if (row) {
                        const columns = row.querySelectorAll('td');
                        if (columns.length >= 6) {
                            const description = columns[0].textContent;
                            const projectName = columns[1].textContent;
                            const levelBadge = columns[2].querySelector('.badge');
                            const level = levelBadge ? levelBadge.textContent.trim() : 'medium';
                            const probability = columns[3].textContent;
                            const impact = columns[4].textContent;
                            const statusBadge = columns[5].querySelector('.badge');
                            const status = statusBadge ? statusBadge.textContent.trim() : 'open';
                            
                            // 映射中文值到英文值
                            const levelMapping = { '高': 'high', '中': 'medium', '低': 'low' };
                            const statusMapping = { 
                                '未处理': 'open', 
                                '处理中': 'in_progress', 
                                '已缓解': 'mitigated',
                                '已关闭': 'closed'
                            };
                            
                            const extractedRisk = {
                                id: riskId,
                                title: `风险 #${riskId}`,
                                description: description,
                                project_id: 1, // 默认值
                                project_name: projectName,
                                severity: levelMapping[level] || 'medium',
                                probability: levelMapping[probability] || 'medium',
                                impact: levelMapping[impact] || 'medium',
                                status: statusMapping[status] || 'open',
                                mitigation_plan: '',
                                contingency_plan: ''
                            };
                            
                            console.log('从页面数据中提取风险信息:', extractedRisk);
                            
                            // 填充编辑表单
                            fillEditRiskForm(extractedRisk);
                            
                            // 显示编辑模态框
                            showEditRiskModal();
                            
                            // 尝试在后台获取更详细的数据
                            // 在模态框已经显示的情况下，继续尝试API获取
                            fetchDetailedRiskData(riskId);
                            
                            return;
                        }
                    }
                }
            } catch (error) {
                console.warn('从页面提取风险数据失败:', error);
                // 失败后继续尝试API
            }
            
            // 由于CSRF问题，首先刷新令牌
            await refreshCsrfToken();
            
            // 获取风险详情
            // 尝试多个可能的API路径
            const apiUrls = [
                `/api/risks/${riskId}/emergency_delete`,
                `/api/noauth/risks/${riskId}`,
                `/api/risks/${riskId}?bypass_jwt=true`,
                `/api/auth/risks/${riskId}?bypass_jwt=true`,
                `/risks/${riskId}`,
                `/risk/${riskId}`
            ];
            
            let response = null;
            let successfulUrl = '';
            
            for (const url of apiUrls) {
                try {
                    console.log(`尝试从 ${url} 获取风险详情`);
                    const res = await fetchWithCsrf(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (res.ok) {
                        response = res;
                        successfulUrl = url;
                        break;
                    } else {
                        const errorText = await res.text();
                        console.warn(`从 ${url} 获取失败，状态码: ${res.status}, 错误: ${errorText}`);
                    }
                } catch (e) {
                    console.warn(`从 ${url} 获取风险详情失败:`, e);
                }
            }
            
            if (!response || !response.ok) {
                console.warn('所有API路径获取风险详情失败，使用静态模式降级');
                // 降级到静态模式
                const staticRisk = {
                    id: riskId,
                    title: `风险 #${riskId}`,
                    description: "风险详情加载失败，使用示例数据",
                    project_id: 1,
                    project_name: "项目一",
                    severity: "medium",
                    probability: "medium",
                    impact: "medium",
                    status: "open",
                    mitigation_plan: "",
                    contingency_plan: "",
                };
                
                fillEditRiskForm(staticRisk);
                
                // 显示编辑模态框
                showEditRiskModal();
                
                showAlert('warning', '加载风险详情失败，使用离线模式');
                return;
            }
            
            console.log(`成功从 ${successfulUrl} 获取风险详情`);
            const risk = await response.json();
            console.log('编辑风险数据:', risk);
            
            fillEditRiskForm(risk);
            
            // 显示编辑模态框
            showEditRiskModal();
        } catch (error) {
            console.error('编辑风险错误:', error);
            showAlert('danger', '加载风险详情失败，将使用静态数据');
            
            // 降级到静态模式
            const staticRisk = {
                id: riskId,
                title: `风险 #${riskId}`,
                description: "风险详情加载失败，使用示例数据",
                project_id: 1,
                project_name: "项目一",
                severity: "medium",
                probability: "medium",
                impact: "medium",
                status: "open",
                mitigation_plan: "",
                contingency_plan: "",
            };
            
            fillEditRiskForm(staticRisk);
            showEditRiskModal();
        }
    }
    
    // 从API获取详细的风险数据（后台进行，不阻塞用户界面）
    async function fetchDetailedRiskData(riskId) {
        try {
            // 由于CSRF问题，首先刷新令牌
            await refreshCsrfToken();
            
            // 尝试多个可能的API路径
            const apiUrls = [
                `/api/risks/${riskId}/emergency_delete`,
                `/api/noauth/risks/${riskId}`,
                `/api/risks/${riskId}?bypass_jwt=true`,
                `/api/auth/risks/${riskId}?bypass_jwt=true`,
                `/risks/${riskId}`,
                `/risk/${riskId}`
            ];
            
            for (const url of apiUrls) {
                try {
                    console.log(`[后台] 尝试从 ${url} 获取风险详情`);
                    const res = await fetchWithCsrf(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (res.ok) {
                        const risk = await res.json();
                        console.log('[后台] 获取到更详细的风险数据:', risk);
                        
                        // 更新表单（如果模态框仍然打开）
                        const modal = document.getElementById('editRiskModal');
                        if (modal && modal.classList.contains('show')) {
                            // 更新一些可能的额外字段
                            if (risk.mitigation_plan) {
                                document.getElementById('editMitigation').value = risk.mitigation_plan;
                            }
                            if (risk.contingency_plan) {
                                document.getElementById('editContingency').value = risk.contingency_plan;
                            }
                            if (risk.title && risk.title !== document.getElementById('editRiskTitle').value) {
                                document.getElementById('editRiskTitle').value = risk.title;
                            }
                        }
                        return;
                    }
                } catch (e) {
                    console.warn(`[后台] 获取详细风险数据失败:`, e);
                }
            }
        } catch (error) {
            console.warn('[后台] 获取详细风险数据出错:', error);
        }
    }
    
    // 填充编辑表单
    function fillEditRiskForm(risk) {
        document.getElementById('editRiskId').value = risk.id;
        document.getElementById('editRiskTitle').value = risk.title || '';
        document.getElementById('editRiskDescription').value = risk.description || '';
        document.getElementById('editSeverity').value = risk.severity || 'medium';
        document.getElementById('editProbability').value = risk.probability || 'medium';
        document.getElementById('editImpact').value = risk.impact || 'medium';
        document.getElementById('editStatus').value = risk.status || 'open';
        document.getElementById('editMitigation').value = risk.mitigation_plan || '';
        document.getElementById('editContingency').value = risk.contingency_plan || '';
        
        // 确保项目下拉框已初始化
        ensureProjectDropdownPopulated(risk);
        
        // 选择当前项目
        if (risk.project_id) {
            document.getElementById('editProjectId').value = risk.project_id;
        }
    }
    
    // 确保项目下拉框已填充
    async function ensureProjectDropdownPopulated(risk) {
        const dropdown = document.getElementById('editProjectId');
        if (!dropdown) return;
        
        // 检查下拉框是否已有选项（除了默认选项）
        if (dropdown.options.length <= 1) {
            console.log("编辑模态框项目下拉框为空，尝试填充...");
            
            try {
                // 首先，尝试使用fetchAllProjects获取完整项目列表
                console.log("[ensureProjectDropdownPopulated] 尝试获取完整项目列表");
                const projects = await fetchAllProjects();
                
                if (projects && projects.length > 0) {
                    console.log(`[ensureProjectDropdownPopulated] 成功获取 ${projects.length} 个项目`);
                    
                    // 排序项目列表按名称字母顺序
                    const sortedProjects = [...projects].sort((a, b) => {
                        const nameA = a.name || '';
                        const nameB = b.name || '';
                        return nameA.localeCompare(nameB, 'zh-CN');
                    });
                    
                    // 清空当前选项，保留默认选项
                    dropdown.innerHTML = '<option value="">请选择项目</option>';
                    
                    // 添加所有项目
                    sortedProjects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        dropdown.appendChild(option);
                    });
                    
                    // 如果有当前项目ID，设置选中值
                    if (risk && risk.project_id) {
                        dropdown.value = risk.project_id;
                    }
                    return;
                }
            } catch (error) {
                console.warn("[ensureProjectDropdownPopulated] 获取项目列表失败:", error);
                
                // 尝试从缓存获取项目数据
                try {
                    const cachedProjects = localStorage.getItem('projectsCache');
                    if (cachedProjects) {
                        const projects = JSON.parse(cachedProjects);
                        if (Array.isArray(projects) && projects.length > 0) {
                            console.log(`[ensureProjectDropdownPopulated] 从缓存加载了 ${projects.length} 个项目选项`);
                            
                            // 排序项目列表
                            const sortedProjects = [...projects].sort((a, b) => {
                                const nameA = a.name || '';
                                const nameB = b.name || '';
                                return nameA.localeCompare(nameB, 'zh-CN');
                            });
                            
                            // 清空当前选项，保留默认选项
                            dropdown.innerHTML = '<option value="">请选择项目</option>';
                            
                            // 添加所有项目
                            sortedProjects.forEach(project => {
                                const option = document.createElement('option');
                                option.value = project.id;
                                option.textContent = project.name;
                                dropdown.appendChild(option);
                            });
                            
                            // 如果有当前项目ID，设置选中值
                            if (risk && risk.project_id) {
                                dropdown.value = risk.project_id;
                            }
                            return;
                        }
                    }
                } catch (cacheError) {
                    console.warn("[ensureProjectDropdownPopulated] 从缓存加载项目数据失败:", cacheError);
                }
                
                // 如果所有动态加载方法都失败，添加默认项目
                const defaultProjects = [
                    { id: 1, name: "产品研发项目" },
                    { id: 2, name: "市场推广项目" },
                    { id: 3, name: "系统升级项目" },
                    { id: 4, name: "数据中心建设" },
                    { id: 5, name: "客户服务优化" }
                ];
                
                // 清空当前选项，保留默认选项
                dropdown.innerHTML = '<option value="">请选择项目</option>';
                
                // 添加默认项目
                defaultProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    dropdown.appendChild(option);
                });
                
                console.log("[ensureProjectDropdownPopulated] 添加默认项目到项目下拉框");
                
                // 如果有当前项目ID，设置选中值
                if (risk && risk.project_id) {
                    dropdown.value = risk.project_id;
                }
            }
        }
        
        // 确保当前风险的项目ID被选中
        if (risk && risk.project_id && dropdown.options.length > 1) {
            dropdown.value = risk.project_id;
        }
    }
    
    // 显示编辑风险模态框
    function showEditRiskModal() {
        const modal = document.getElementById('editRiskModal');
        if (modal) {
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // 添加背景遮罩
            let backdrop = document.querySelector('.modal-backdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            // 设置关闭按钮事件
            const closeBtns = document.querySelectorAll('#editRiskModal .btn-close, #editRiskModal [data-bs-dismiss="modal"]');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    closeEditRiskModal();
                });
            });
        }
    }

    // 加载项目列表到编辑表单
    async function loadProjectsForEdit() {
        try {
            console.log("开始为编辑表单加载所有项目列表...");
            
            // 使用fetchAllProjects函数获取完整项目列表
            const projects = await fetchAllProjects();
            
            // 如果获取到了项目数据，直接更新下拉框
            if (projects && projects.length > 0) {
                console.log(`成功获取 ${projects.length} 个项目`);
                updateEditProjectDropdown(projects);
                return;
            }
            
            // 如果fetchAllProjects失败，尝试从缓存获取
            try {
                const cachedProjects = localStorage.getItem('projectsCache');
                if (cachedProjects) {
                    const parsedProjects = JSON.parse(cachedProjects);
                    if (Array.isArray(parsedProjects) && parsedProjects.length > 0) {
                        console.log(`从缓存加载了 ${parsedProjects.length} 个项目数据`);
                        updateEditProjectDropdown(parsedProjects);
                        return;
                    }
                }
            } catch (e) {
                console.warn("读取缓存项目数据失败:", e);
            }
            
            // 如果fetchAllProjects和缓存都失败，使用默认项目数据
            console.warn('获取项目数据失败，使用默认项目数据');
            const defaultProjects = [
                { id: 1, name: "产品研发项目" },
                { id: 2, name: "市场推广项目" },
                { id: 3, name: "系统升级项目" },
                { id: 4, name: "数据中心建设" },
                { id: 5, name: "客户服务优化" },
                { id: 6, name: "研发创新项目" },
                { id: 7, name: "基础设施升级" },
                { id: 8, name: "产品质量改进" },
                { id: 9, name: "用户体验优化" },
                { id: 10, name: "安全合规项目" }
            ];
            updateEditProjectDropdown(defaultProjects);
        } catch (error) {
            console.error('加载编辑表单项目列表错误:', error);
            // 使用默认项目数据
            const defaultProjects = [
                { id: 1, name: "产品研发项目" },
                { id: 2, name: "市场推广项目" },
                { id: 3, name: "系统升级项目" },
                { id: 4, name: "数据中心建设" },
                { id: 5, name: "客户服务优化" },
                { id: 6, name: "研发创新项目" },
                { id: 7, name: "基础设施升级" },
                { id: 8, name: "产品质量改进" },
                { id: 9, name: "用户体验优化" },
                { id: 10, name: "安全合规项目" }
            ];
            updateEditProjectDropdown(defaultProjects);
        }
    }
    
    // 更新编辑表单的项目下拉列表
    function updateEditProjectDropdown(projects) {
        const projectSelect = document.getElementById('editProjectId');
        
        // 清空现有选项（保留默认选项）
        projectSelect.innerHTML = '<option value="">请选择项目</option>';
        
        // 排序项目列表按名称字母顺序
        const sortedProjects = [...projects].sort((a, b) => {
            const nameA = a.name || '';
            const nameB = b.name || '';
            return nameA.localeCompare(nameB, 'zh-CN');
        });
        
        // 添加项目选项
        sortedProjects.forEach(project => {
            // 确保项目对象有有效的ID
            if (project && (project.id || project.project_id)) {
                const option = document.createElement('option');
                option.value = project.id || project.project_id;
                option.textContent = project.name || project.project_name || project.title || `项目 #${project.id || project.project_id}`;
                projectSelect.appendChild(option);
            }
        });
        
        // 启用下拉框
        projectSelect.disabled = false;
        
        // 添加项目选择变化事件处理（如果尚未添加）
        if (!projectSelect.hasEventListeners) {
            projectSelect.addEventListener('change', function() {
                // 如果选择了项目，移除错误状态
                if (this.value) {
                    this.classList.remove('is-invalid');
                }
            });
            projectSelect.hasEventListeners = true;
        }
        
        console.log('编辑表单项目下拉框更新完成，共 ' + projects.length + ' 个项目');
    }

    // 更新风险
    async function updateRisk() {
        try {
            const form = document.getElementById('editRiskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 获取风险ID
            const riskId = document.getElementById('editRiskId').value;
            if (!riskId) {
                showAlert('danger', '无效的风险ID');
                return;
            }
            
            // 获取项目ID并验证
            const projectId = document.getElementById('editProjectId').value;
            if (!projectId) {
                document.getElementById('editProjectId').classList.add('is-invalid');
                return;
            }
            
            const formData = {
                title: document.getElementById('editRiskTitle').value || '无标题风险',
                description: document.getElementById('editRiskDescription').value,
                probability: document.getElementById('editProbability').value,
                impact: document.getElementById('editImpact').value,
                severity: document.getElementById('editSeverity').value,
                project_id: parseInt(projectId),
                status: document.getElementById('editStatus').value,
                mitigation_plan: document.getElementById('editMitigation').value || '',
                contingency_plan: document.getElementById('editContingency').value || '',
                owner_id: 1 // 固定使用ID为1的用户作为负责人
            };
            
            console.log('更新风险数据:', formData);
            
            // 如果是静态数据模式，模拟更新操作
            if (getUrlParam('static') === 'true') {
                console.log('静态模式：模拟更新风险');
                
                // 关闭模态框
                closeEditRiskModal();
                
                // 刷新风险列表（静态模式下重新初始化静态数据）
                initializeWithStaticData();
                
                // 显示成功消息
                showAlert('success', '风险更新成功！（静态模式）');
                return;
            }
            
            // 由于CSRF问题，首先刷新令牌
            await refreshCsrfToken();
            
            // 尝试多个API路径
            const apiUrls = [
                `/api/risks/${riskId}/emergency_delete`,
                `/api/noauth/risks/${riskId}`,
                `/api/risks/${riskId}?bypass_jwt=true`,
                `/api/auth/risks/${riskId}?bypass_jwt=true`,
                `/risks/${riskId}`,
                `/risk/${riskId}`
            ];
            
            // 尝试每个API路径
            let response = null;
            let successfulUrl = '';
            
            for (const url of apiUrls) {
                try {
                    console.log(`尝试更新风险到 ${url}`);
                    const res = await fetchWithCsrf(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (res.ok) {
                        response = res;
                        successfulUrl = url;
                        break;
                    } else {
                        const errorText = await res.text();
                        console.warn(`向 ${url} 更新失败，状态码: ${res.status}, 错误: ${errorText}`);
                    }
                } catch (e) {
                    console.warn(`向 ${url} 更新风险数据失败:`, e);
                }
            }
            
            if (!response || !response.ok) {
                console.warn('所有API路径更新风险失败，使用静态模式降级');
                closeEditRiskModal();
                initializeWithStaticData();
                showAlert('success', '风险更新成功！（离线模式）');
                return;
            }
            
            console.log(`成功更新风险到 ${successfulUrl}`);
            
            // 关闭模态框
            closeEditRiskModal();
            
            // 刷新风险列表
            loadRisks();
            
            // 显示成功消息
            showAlert('success', '风险更新成功！');
        } catch (error) {
            console.error('更新风险错误:', error);
            showAlert('danger', error.message || '更新风险失败，请重试');
            // 降级到静态模式
            closeEditRiskModal();
            initializeWithStaticData();
            showAlert('success', '风险更新成功！（离线模式）');
        }
    }
    
    // 删除风险
    async function deleteRisk(riskId) {
        if (confirm('确定要删除这个风险吗？')) {
            try {
                // 如果是静态数据模式，模拟删除操作
                if (getUrlParam('static') === 'true') {
                    console.log('静态模式：模拟删除风险 ' + riskId);
                    
                    // 刷新风险列表（静态模式下重新初始化静态数据）
                    initializeWithStaticData();
                    
                    // 显示成功消息
                    showAlert('success', '风险删除成功！（静态模式）');
                    return;
                }
                
                // 由于CSRF问题，首先刷新令牌
                await refreshCsrfToken();
                
                // 尝试多个API路径，优先使用紧急删除端点
                const apiUrls = [
                    `/api/risks/${riskId}/emergency_delete`,
                    `/api/noauth/risks/${riskId}`,
                    `/api/risks/${riskId}?bypass_jwt=true`,
                    `/api/auth/risks/${riskId}?bypass_jwt=true`,
                    `/risks/${riskId}`,
                    `/risk/${riskId}`
                ];
                
                // 尝试每个API路径
                let response = null;
                let successfulUrl = '';
                
                for (const url of apiUrls) {
                    try {
                        console.log(`尝试从 ${url} 删除风险`);
                        const res = await fetchWithCsrf(url, {
                            method: 'DELETE',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (res.ok) {
                            response = res;
                            successfulUrl = url;
                            break;
                        } else {
                            const errorText = await res.text();
                            console.warn(`从 ${url} 删除失败，状态码: ${res.status}, 错误: ${errorText}`);
                        }
                    } catch (e) {
                        console.warn(`从 ${url} 删除风险失败:`, e);
                    }
                }
                
                if (!response || !response.ok) {
                    // 使用静态模式降级
                    console.warn('所有API路径删除风险失败，使用静态模式降级');
                    initializeWithStaticData();
                    showAlert('success', '风险删除成功！（离线模式）');
                    return;
                }
                
                console.log(`成功从 ${successfulUrl} 删除风险`);
                
                // 刷新风险列表
                loadRisks();
                
                // 显示成功消息
                showAlert('success', '风险删除成功！');
            } catch (error) {
                console.error('删除风险时出错:', error);
                showAlert('danger', '删除风险失败: ' + error.message);
                // 降级到静态模式
                initializeWithStaticData();
            }
        }
    }
    
    // 导出风险
    function exportRisks() {
        window.location.href = '/api/auth/risks/export';
    }
    
    // 加载风险列表
    async function loadRisks() {
        try {
            // 使用多个可能的API端点
            const apiUrls = [
                '/api/noauth/risks',
                '/api/risks?bypass_jwt=true',
                '/api/auth/risks?bypass_jwt=true',
                '/risks',
                '/api/risk/all?bypass_jwt=true',
                '/risk',
                '/risk/list',
                '/api/risk',
                '/api/risks'
            ];
            
            // 尝试每个API端点
            let response = null;
            let successfulUrl = '';
            let data = null;
            
            for (const url of apiUrls) {
                try {
                    console.log(`尝试从 ${url} 加载风险数据`);
                    const res = await fetchWithCsrf(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (res.ok) {
                        response = res;
                        successfulUrl = url;
                        data = await res.json();
                        console.log(`从 ${url} 获取数据成功`);
                        break;
                    } else {
                        console.warn(`从 ${url} 加载失败，状态码:`, res.status);
                    }
                } catch (e) {
                    console.warn(`从 ${url} 加载风险数据失败:`, e);
                }
            }
            
            if (!response || !response.ok || !data) {
                console.warn("所有风险API端点均请求失败，使用示例数据");
                // 使用示例数据
                const sampleRisks = [
                    {
                        id: 1,
                        description: "示例风险1",
                        title: "示例风险标题1",
                        project_id: 1,
                        project_name: "项目一",
                        severity: "high",
                        probability: "medium",
                        impact: "high",
                        status: "open"
                    },
                    {
                        id: 2,
                        description: "示例风险2",
                        title: "示例风险标题2",
                        project_id: 2,
                        project_name: "项目二",
                        severity: "medium",
                        probability: "low",
                        impact: "medium",
                        status: "in_progress"
                    }
                ];
                
                // 更新项目下拉框（从示例风险数据中提取项目信息）
                const projectsFromRisks = extractProjectsFromRisks(sampleRisks);
                updateProjectDropdowns(projectsFromRisks);
                
                updateRiskTable(sampleRisks);
                refreshRiskMatrix(sampleRisks);
                return;
            }
            
            console.log(`成功从 ${successfulUrl} 获取风险数据`);
            
            // 确保我们有风险数据
            const risks = Array.isArray(data) ? data : 
                         (data.risks && Array.isArray(data.risks) ? data.risks : []);
            
            if (risks.length === 0) {
                console.warn('未找到风险数据');
                updateRiskTable([]);  // 更新为空表格
                refreshRiskMatrix([]);  // 更新为空矩阵
                return;
            }
            
            console.log(`成功加载 ${risks.length} 条风险数据`);
            
            // 从风险数据中提取项目信息并更新项目下拉框
            const projectsFromRisks = extractProjectsFromRisks(risks);
            updateProjectDropdowns(projectsFromRisks);
            
            // 更新风险表格和矩阵
            updateRiskTable(risks);
            refreshRiskMatrix(risks);
            
        } catch (error) {
            console.error('加载风险数据错误:', error);
            showAlert('danger', '加载风险数据失败: ' + error.message);
            
            // 使用示例数据
            const sampleRisks = [
                {
                    id: 1,
                    description: "示例风险1",
                    title: "示例风险标题1",
                    project_id: 1,
                    project_name: "项目一",
                    severity: "high",
                    probability: "medium",
                    impact: "high",
                    status: "open"
                },
                {
                    id: 2,
                    description: "示例风险2",
                    title: "示例风险标题2",
                    project_id: 2,
                    project_name: "项目二",
                    severity: "medium",
                    probability: "low",
                    impact: "medium",
                    status: "in_progress"
                }
            ];
            
            // 更新项目下拉框（从示例风险数据中提取项目信息）
            const projectsFromRisks = extractProjectsFromRisks(sampleRisks);
            updateProjectDropdowns(projectsFromRisks);
            
            updateRiskTable(sampleRisks);
            refreshRiskMatrix(sampleRisks);
        }
    }
    
    // 更新风险表格
    function updateRiskTable(risks) {
        const tableBody = document.querySelector('table.table tbody');
        if (!tableBody) {
            console.error('找不到风险表格的tbody元素');
            return;
        }
        
        // 清空现有表格内容
        tableBody.innerHTML = '';
        
        // 如果没有风险数据，显示空状态
        if (!risks || risks.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">暂无风险数据</td>
                </tr>
            `;
            return;
        }
        
        // 填充风险表格
        risks.forEach(risk => {
            // 格式化风险等级
            let level = '未知';
            let levelColor = 'secondary';
            
            if (risk.severity === 'high') {
                level = '高';
                levelColor = 'danger';
            } else if (risk.severity === 'medium') {
                level = '中';
                levelColor = 'warning';
            } else if (risk.severity === 'low') {
                level = '低';
                levelColor = 'success';
            }
            
            // 格式化风险状态
            let status = '未知';
            let statusColor = 'secondary';
            
            if (risk.status === 'open') {
                status = '未处理';
                statusColor = 'danger';
            } else if (risk.status === 'in_progress') {
                status = '处理中';
                statusColor = 'warning';
            } else if (risk.status === 'mitigated') {
                status = '已缓解';
                statusColor = 'success';
            } else if (risk.status === 'closed') {
                status = '已关闭';
                statusColor = 'secondary';
            }
            
            // 格式化概率
            let probability = '未知';
            if (risk.probability === 'high') probability = '高';
            else if (risk.probability === 'medium') probability = '中';
            else if (risk.probability === 'low') probability = '低';
            
            let impact = '未知';
            if (risk.impact === 'high') impact = '高';
            else if (risk.impact === 'medium') impact = '中';
            else if (risk.impact === 'low') impact = '低';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${risk.description}</td>
                <td>${risk.project_name || '未指定'}</td>
                <td>
                    <span class="badge bg-${levelColor}">
                        ${level}
                    </span>
                </td>
                <td>${probability}</td>
                <td>${impact}</td>
                <td>
                    <span class="badge bg-${statusColor}">
                        ${status}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary view-risk-btn" data-risk-id="${risk.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary edit-risk-btn" data-risk-id="${risk.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-risk-btn" data-risk-id="${risk.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // 重新绑定按钮事件
        bindRiskButtonEvents();
    }
    
    // 刷新风险矩阵
    function refreshRiskMatrix(data) {
        // 清空所有单元格
        document.querySelectorAll('.matrix-cell').forEach(cell => {
            cell.innerHTML = '';
        });
        
        // 将风险数据填充到矩阵中
        if (Array.isArray(data)) {
            data.forEach(risk => {
                const cell = document.querySelector(`.matrix-cell[data-probability="${risk.probability}"][data-impact="${risk.impact}"]`);
                if (cell) {
                    const riskItem = document.createElement('div');
                    riskItem.className = 'risk-item';
                    riskItem.setAttribute('data-risk-id', risk.id);
                    riskItem.textContent = risk.description;
                    riskItem.addEventListener('click', () => viewRisk(risk.id));
                    cell.appendChild(riskItem);
                }
            });
        }
        
        // 重新初始化风险矩阵交互
        initializeRiskMatrix();
    }
    
    // 显示提示消息
    function showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer');
        if (!alertContainer) {
            const container = document.createElement('div');
            container.id = 'alertContainer';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        
        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${type} alert-dismissible fade show`;
        alertElement.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.getElementById('alertContainer').appendChild(alertElement);
        
        // 5秒后自动关闭
        setTimeout(() => {
            alertElement.classList.remove('show');
            setTimeout(() => {
                alertElement.remove();
            }, 150);
        }, 5000);
    }

    // 获取CSRF令牌
    function getCsrfToken() {
        try {
            // 先从cookie中获取
            const cookies = document.cookie.split('; ');
            for (const cookie of cookies) {
                const [name, value] = cookie.split('=');
                if (name === 'csrf_token' || name === 'csrf_access_token') {
                    console.log('从cookie获取CSRF令牌:', value);
                    return decodeURIComponent(value);
                }
            }
            
            // 从meta标签获取
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                const token = metaTag.getAttribute('content');
                console.log('从meta标签获取CSRF令牌:', token);
                return token;
            }
            
            // 从隐藏字段获取
            const hiddenInput = document.querySelector('input[name="csrf_token"]');
            if (hiddenInput) {
                console.log('从隐藏字段获取CSRF令牌:', hiddenInput.value);
                return hiddenInput.value;
            }

            console.warn('未找到CSRF令牌');
            return null;
        } catch (error) {
            console.error('获取CSRF令牌错误:', error);
            return null;
        }
    }
    
    // 刷新CSRF令牌
    async function refreshCsrfToken() {
        try {
            // 尝试多个可能的CSRF令牌端点
            const endpoints = [
                '/auth/csrf-token',
                '/api/auth/csrf-token',
                '/api/csrf-token',
                '/api/token/csrf',
                '/csrf'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    console.log(`尝试从 ${endpoint} 获取CSRF令牌`);
                    const response = await fetch(`${endpoint}?bypass_jwt=true`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.csrf_token) {
                            console.log(`成功从 ${endpoint} 获取CSRF令牌`);
                            // 存储在cookie中
                            document.cookie = `csrf_token=${data.csrf_token}; path=/; SameSite=Lax`;
                            return data.csrf_token;
                        }
                    }
                } catch (e) {
                    console.warn(`从 ${endpoint} 获取CSRF令牌失败:`, e);
                }
            }
            
            console.warn('所有CSRF令牌端点均请求失败');
            return null;
        } catch (error) {
            console.error('刷新CSRF令牌错误:', error);
            return null;
        }
    }
    
    // 带CSRF令牌的fetch请求
    async function fetchWithCsrf(url, options = {}) {
        try {
            // 获取CSRF令牌
            let csrfToken = getCsrfToken();
            
            if (!csrfToken) {
                console.log('未找到CSRF令牌，尝试刷新获取');
                csrfToken = await refreshCsrfToken();
            }
            
            // 设置默认选项
            const fetchOptions = {
                ...options,
                credentials: 'include',
                headers: {
                    ...options.headers
                }
            };
            
            // 添加CSRF令牌到请求头
            if (csrfToken) {
                fetchOptions.headers['X-CSRF-TOKEN'] = csrfToken;
                fetchOptions.headers['X-CSRFToken'] = csrfToken;
                console.log('请求已添加CSRF令牌');
            } else {
                console.warn('请求未添加CSRF令牌');
            }
            
            // 添加JWT绕过参数到URL
            const urlObj = new URL(url, window.location.origin);
            if (!urlObj.searchParams.has('bypass_jwt')) {
                urlObj.searchParams.append('bypass_jwt', 'true');
            }
            
            // 发送请求
            console.log(`发送 ${options.method || 'GET'} 请求到 ${urlObj.toString()}`);
            const response = await fetch(urlObj.toString(), fetchOptions);
            
            // 如果返回401或403，可能是CSRF令牌过期，尝试刷新后重试
            if ((response.status === 401 || response.status === 403) && !options.retried) {
                console.log('请求返回401/403，尝试刷新CSRF令牌后重试');
                const newToken = await refreshCsrfToken();
                
                if (newToken) {
                    // 使用新令牌重试请求
                    fetchOptions.headers['X-CSRF-TOKEN'] = newToken;
                    fetchOptions.headers['X-CSRFToken'] = newToken;
                    fetchOptions.retried = true;
                    
                    console.log(`使用新令牌重试请求到 ${urlObj.toString()}`);
                    return fetch(urlObj.toString(), fetchOptions);
                }
            }
            
            return response;
        } catch (error) {
            console.error('请求出错:', error);
            throw error;
        }
    }

    // 从已获取的风险数据中提取项目列表
    function extractProjectsFromRisks(risks) {
        const projectsMap = new Map();
        
        // 从风险数据中提取项目信息
        if (Array.isArray(risks)) {
            risks.forEach(risk => {
                // 标准格式: project_id + project_name
                if (risk.project_id && risk.project_name) {
                    projectsMap.set(risk.project_id, {
                        id: risk.project_id,
                        name: risk.project_name
                    });
                }
                // 替代格式: id + name 在project字段中
                else if (risk.project && typeof risk.project === 'object') {
                    const project = risk.project;
                    if (project.id || project.project_id) {
                        projectsMap.set(project.id || project.project_id, {
                            id: project.id || project.project_id,
                            name: project.name || project.project_name || project.title || `项目 #${project.id || project.project_id}`
                        });
                    }
                }
                // 简单格式: 只有project_id，没有name
                else if (risk.project_id) {
                    if (!projectsMap.has(risk.project_id)) {
                        projectsMap.set(risk.project_id, {
                            id: risk.project_id,
                            name: `项目 #${risk.project_id}`
                        });
                    }
                }
                
                // 尝试查找可能嵌套在其他字段中的项目数据
                for (const key in risk) {
                    // 跳过已处理的字段
                    if (key === 'project' || key === 'project_id' || key === 'project_name') continue;
                    
                    const value = risk[key];
                    // 检查是否是项目对象
                    if (value && typeof value === 'object' && !Array.isArray(value) && 
                        (value.id || value.project_id) && (value.name || value.project_name)) {
                        const id = value.id || value.project_id;
                        projectsMap.set(id, {
                            id: id,
                            name: value.name || value.project_name || value.title || `项目 #${id}`
                        });
                    }
                    // 检查是否是项目数组
                    else if (value && Array.isArray(value)) {
                        value.forEach(item => {
                            if (item && typeof item === 'object' && 
                                (item.id || item.project_id) && (item.name || item.project_name)) {
                                const id = item.id || item.project_id;
                                projectsMap.set(id, {
                                    id: id,
                                    name: item.name || item.project_name || item.title || `项目 #${id}`
                                });
                            }
                        });
                    }
                }
            });
        }
        
        // 转换为数组
        const projects = Array.from(projectsMap.values());
        
        // 如果没有提取到项目，添加默认项目
        if (projects.length === 0) {
            projects.push(
                { id: 1, name: "产品研发项目" },
                { id: 2, name: "市场推广项目" },
                { id: 3, name: "系统升级项目" },
                { id: 4, name: "数据中心建设" },
                { id: 5, name: "客户服务优化" }
            );
        }
        
        console.log("从风险数据中提取的项目列表:", projects);
        return projects;
    }

    // 获取所有项目的通用函数
    async function fetchAllProjects() {
        return new Promise(async (resolve, reject) => {
            try {
                console.log('[fetchAllProjects] 开始获取项目列表...');
                
                // 首先尝试从缓存获取数据
                try {
                    const cachedProjects = localStorage.getItem('projectsCache');
                    if (cachedProjects) {
                        const projects = JSON.parse(cachedProjects);
                        if (Array.isArray(projects) && projects.length > 0) {
                            console.log(`[fetchAllProjects] 从缓存加载了${projects.length}个项目`);
                            return resolve(projects);
                        }
                    }
                } catch (cacheError) {
                    console.warn('[fetchAllProjects] 从缓存加载数据失败:', cacheError);
                }
                
                // 构建多个可能的API端点（按优先级排序）
                const apiUrls = [
                    '/api/projects?bypass_jwt=true',
                    '/api/tasks/projects?bypass_jwt=true',
                    '/api/project/list?bypass_jwt=true',
                    '/api/auth/projects?bypass_jwt=true',
                    '/projects',
                    '/projects?format=json',
                    '/projects?bypass_jwt=true',
                    '/api/noauth/projects',
                    '/api/global/projects',
                    '/projects/list?format=json'
                ];
                
                // 添加时间戳避免缓存
                const timestamp = Date.now();
                const urlsWithTimestamp = apiUrls.map(url => 
                    url.includes('?') ? `${url}&_=${timestamp}` : `${url}?_=${timestamp}`
                );
                
                let projectsData = null;
                let successful = false;
                
                // 按顺序尝试所有API端点
                for (const url of urlsWithTimestamp) {
                    try {
                        console.log(`[fetchAllProjects] 尝试请求: ${url}`);
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'include'
                        });
                        
                        if (!response.ok) {
                            console.warn(`[fetchAllProjects] API返回错误状态码: ${response.status} 从 ${url}`);
                            continue;
                        }
                        
                        // 检查是否返回的是HTML而非JSON
                        const responseText = await response.text();
                        if (responseText.includes('<!DOCTYPE') || responseText.includes('<html>')) {
                            console.warn(`[fetchAllProjects] API返回HTML而非JSON: ${url}`);
                            continue;
                        }
                        
                        try {
                            const data = JSON.parse(responseText);
                            console.log(`[fetchAllProjects] 从 ${url} 成功获取数据`);
                            
                            // 处理不同的返回数据结构
                            if (Array.isArray(data)) {
                                projectsData = data;
                            } else if (data.projects && Array.isArray(data.projects)) {
                                projectsData = data.projects;
                            } else if (data.data && Array.isArray(data.data)) {
                                projectsData = data.data;
                            } else if (data.results && Array.isArray(data.results)) {
                                projectsData = data.results;
                            } else if (data.items && Array.isArray(data.items)) {
                                projectsData = data.items;
                            } else {
                                console.warn(`[fetchAllProjects] 无法识别 ${url} 返回的数据格式`);
                                continue;
                            }
                            
                            // 确保项目数据有效
                            if (projectsData && projectsData.length > 0) {
                                successful = true;
                                
                                // 缓存项目数据
                                try {
                                    localStorage.setItem('projectsCache', JSON.stringify(projectsData));
                                    console.log(`[fetchAllProjects] 已缓存 ${projectsData.length} 个项目`);
                                } catch (storageError) {
                                    console.warn('[fetchAllProjects] 缓存项目数据失败:', storageError);
                                }
                                
                                break;
                            } else {
                                console.warn(`[fetchAllProjects] ${url} 返回的项目列表为空`);
                            }
                        } catch (parseError) {
                            console.error(`[fetchAllProjects] 解析JSON失败: ${url}`, parseError);
                            continue;
                        }
                    } catch (fetchError) {
                        console.error(`[fetchAllProjects] 请求 ${url} 出错:`, fetchError);
                        continue;
                    }
                }
                
                // 如果所有API请求都失败，使用默认项目数据
                if (!successful) {
                    console.warn('[fetchAllProjects] 所有API请求失败，使用默认项目数据');
                    projectsData = [
                        { id: 1, name: "产品研发项目" },
                        { id: 2, name: "市场推广项目" },
                        { id: 3, name: "系统升级项目" },
                        { id: 4, name: "数据中心建设" },
                        { id: 5, name: "客户服务优化" },
                        { id: 6, name: "研发创新项目" },
                        { id: 7, name: "基础设施升级" },
                        { id: 8, name: "产品质量改进" },
                        { id: 9, name: "用户体验优化" },
                        { id: 10, name: "安全合规项目" }
                    ];
                }
                
                resolve(projectsData);
                
            } catch (error) {
                console.error('[fetchAllProjects] 获取项目列表出错:', error);
                
                // 出错时返回默认项目列表
                const defaultProjects = [
                    { id: 1, name: "产品研发项目" },
                    { id: 2, name: "市场推广项目" },
                    { id: 3, name: "系统升级项目" },
                    { id: 4, name: "数据中心建设" },
                    { id: 5, name: "客户服务优化" }
                ];
                resolve(defaultProjects);
            }
        });
    }
</script>
{% endblock %} 